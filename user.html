<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uda-Mandi Enterprise Payroll</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. THEME VARIABLES --- */
        :root {
            --primary: #1e3c72;
            --secondary: #2a5298;
            --accent: #f39c12;
            --success: #27ae60;
            --danger: #e74c3c;
            --bg-body: #f4f7f6;
            --text-main: #2c3e50;
            --border: #e0e0e0;
        }

        /* --- 2. GLOBAL RESET --- */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--bg-body);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- 3. LAYOUT --- */
        .app-header {
            height: 60px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 100;
        }
        .header-title { font-size: 20px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        
        .workspace { display: flex; flex: 1; overflow: hidden; }

        /* SIDEBAR (Inputs) */
        .sidebar {
            width: 400px; background: white; border-right: 1px solid var(--border);
            display: flex; flex-direction: column; overflow-y: auto; padding: 20px;
        }

        /* PREVIEW AREA */
        .preview-area {
            flex: 1; background: #555; display: flex; justify-content: center; align-items: flex-start;
            overflow-y: auto; padding: 40px; position: relative;
        }

        /* --- 4. COMPONENTS --- */
        .section-card {
            border: 1px solid var(--border); border-radius: 8px; margin-bottom: 20px; overflow: hidden; background: #fff;
        }
        .card-header {
            background: #f8f9fa; padding: 10px 15px; font-weight: bold; border-bottom: 1px solid var(--border);
            color: var(--primary); font-size: 14px; display: flex; align-items: center; gap: 8px;
        }
        .card-body { padding: 15px; }

        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .col { flex: 1; }
        label { display: block; font-size: 11px; font-weight: bold; color: #666; margin-bottom: 4px; text-transform: uppercase; }
        input { 
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; 
        }
        input:focus { border-color: var(--secondary); }
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; }

        /* Company Selector */
        .company-tiles { display: flex; gap: 10px; }
        .tile {
            flex: 1; border: 2px solid #eee; border-radius: 6px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; font-size: 13px;
        }
        .tile:hover { border-color: var(--secondary); background: #f0f4ff; }
        .tile.active { border-color: var(--success); background: #eafff0; color: #006400; font-weight: bold; }

        /* Toggle Switch */
        .switch-wrapper { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f9f9f9; border-radius: 5px; border: 1px solid #eee; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 20px; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Buttons */
        .btn { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .btn-success { background: var(--success); width: 100%; font-size: 15px; margin-top: 10px; }
        .btn-danger { background: var(--danger); font-size: 12px; padding: 6px 12px; }
        .btn-admin { background: var(--accent); display: none; }

        /* --- 5. PAYSLIP PAPER DESIGN --- */
        #payslip-paper {
            width: 794px; /* A4 Width */
            background: white;
            padding: 40px 50px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            position: relative;
            color: black;
            font-family: Arial, Helvetica, sans-serif;
            z-index: 1;
        }

        /* HEADER (Full Address Fix) */
        .paper-header { text-align: center; margin-bottom: 25px; display: none; }
        .paper-header.show { display: block; }
        
        .ph-title { 
            font-family: 'Arial Black', Arial, sans-serif; 
            font-size: 32px; 
            font-weight: 900; 
            color: #555555; /* Solid Dark Grey */
            text-transform: uppercase; 
            margin-bottom: 8px; 
            letter-spacing: 1px; 
        }
        .ph-sub { 
            font-size: 13px; 
            color: #555555; 
            font-weight: 600; 
            /* Added width constraints to force wrapping if needed, but allow full text */
            max-width: 90%;
            margin: 0 auto;
            line-height: 1.5;
        } 
        .ph-line { border-bottom: 2px solid #999; margin-top: 15px; width: 100%; }

        /* WATERMARK */
        .watermark {
            position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%);
            font-size: 130px; font-weight: 900; 
            z-index: 0; pointer-events: none; letter-spacing: 20px; white-space: nowrap;
            font-family: 'Arial Black', sans-serif; 
            opacity: 0.15; 
        }
        .watermark.purple { color: #6a4ca8; }
        .watermark.red { color: #800000; }

        /* TABLE */
        table.std-table { width: 100%; border-collapse: collapse; position: relative; z-index: 2; border: 2px solid black; }
        .std-table th, .std-table td { border: 1px solid black; padding: 8px 10px; font-size: 13px; vertical-align: middle; line-height: 1.4; background: transparent; }
        
        .th-main { background: rgba(255,255,255,0.95); font-weight: bold; text-align: center; font-size: 16px; padding: 12px !important; border-bottom: 2px solid black; }
        .th-sub { background: #f0f0f0; font-weight: bold; font-size: 12px; text-transform: uppercase; }
        
        .aln-right { text-align: right; }
        .aln-center { text-align: center; }
        .f-bold { font-weight: bold; }
        .c-blue { color: #1a73e8; font-weight: 700; }
        
        .net-pay { font-size: 18px; font-weight: bold; text-align: center; padding: 15px !important; background: white; border-top: 2px solid black; }
        .footer { text-align: center; font-size: 11px; font-style: italic; margin-top: 30px; color: #555; }

        /* Background Pattern */
        .bg-pattern {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(#800000 1px, transparent 1px);
            background-size: 20px 20px; opacity: 0.05; z-index: 0; display: none;
        }

        /* Loading Overlay */
        #loader {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999;
            display: none; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top: 4px solid var(--success); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <h3>Generating PNG...</h3>
</div>

<div class="app-header">
    <div class="header-title"><i class="fas fa-file-invoice"></i> Uda-Mandi Enterprise</div>
    <div style="display:flex; gap:10px;">
        <button class="btn btn-admin" onclick="location.href='admin.html'">Admin</button>
        <button class="btn btn-danger" onclick="logout()">Logout</button>
    </div>
</div>

<div class="workspace">
    
    <div class="sidebar">
        
        <div class="section-card">
            <div class="card-header"><i class="fas fa-building"></i> Select Company</div>
            <div class="card-body">
                <div class="company-tiles">
                    <div class="tile active" id="tile-udamandi" onclick="setCompany('udamandi')">
                        <i class="fas fa-city"></i> Udamandi
                    </div>
                    <div class="tile" id="tile-gautam" onclick="setCompany('gautam')">
                        <i class="fas fa-solar-panel"></i> Gautam Solar
                    </div>
                </div>
            </div>
        </div>

        <div class="section-card">
            <div class="card-header"><i class="fas fa-cogs"></i> Calculations</div>
            <div class="card-body">
                <div class="switch-wrapper">
                    <span style="font-size:13px; font-weight:600;">Auto-Calculate PF (12%)</span>
                    <label class="switch">
                        <input type="checkbox" id="pfToggle" onchange="togglePFMode()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="pf-msg" style="margin-top:5px; font-size:11px; color:gray; display:none;">
                    *PF is locked to 12% of Basic Pay.
                </div>
            </div>
        </div>

        <div class="section-card">
            <div class="card-header"><i class="fas fa-user"></i> Employee Info</div>
            <div class="card-body">
                <div class="form-row">
                    <div class="col"><label>Month</label><input type="text" id="i-month" value="October, 2025" oninput="upd()"></div>
                    <div class="col"><label>Code</label><input type="text" id="i-code" value="6138" oninput="upd()"></div>
                </div>
                <div class="col" style="margin-bottom:10px;"><label>Name</label><input type="text" id="i-name" value="Shivshree Kumar" oninput="upd()"></div>
                <div class="col" style="margin-bottom:10px;"><label>Father Name</label><input type="text" id="i-fname" value="Santosh Kumar" oninput="upd()"></div>
                <div class="form-row">
                    <div class="col"><label>PF No.</label><input type="text" id="i-pfno" placeholder="-" oninput="upd()"></div>
                    <div class="col"><label>DOJ</label><input type="date" id="i-doj" value="2025-05-15" oninput="upd()"></div>
                </div>
            </div>
        </div>

        <div class="section-card">
            <div class="card-header"><i class="fas fa-clock"></i> Attendance</div>
            <div class="card-body">
                <div class="form-row">
                    <div class="col"><label>Work Days</label><input type="number" id="i-wday" value="23" oninput="calcAll()"></div>
                    <div class="col"><label>Pres Days</label><input type="number" id="i-pday" value="16" oninput="calcAll()"></div>
                </div>
                <div class="form-row" style="background:#f0f0f0; padding:10px; border-radius:5px;">
                    <div class="col"><label>Var Hrs</label><input type="number" id="i-vhrs" value="72.4" oninput="calcAll()"></div>
                    <div class="col"><label>Rate</label><input type="number" id="i-vrate" value="105" oninput="calcAll()"></div>
                </div>
            </div>
        </div>

        <div class="section-card">
            <div class="card-header"><i class="fas fa-rupee-sign"></i> Financials</div>
            <div class="card-body">
                <div class="form-row">
                    <div class="col"><label>Basic (Str)</label><input type="number" id="i-bs" value="23541" oninput="calcAll()"></div>
                    <div class="col"><label>Basic (Pay)</label><input type="number" id="i-bp" value="16376.35" readonly></div>
                </div>
                <div class="form-row">
                    <div class="col"><label>Food Allow</label><input type="number" id="i-food" value="3000" oninput="calcAll()"></div>
                    <div class="col"><label>Bus Fee</label><input type="number" id="i-bus" value="750" oninput="calcAll()"></div>
                </div>
                <div class="form-row">
                    <div class="col"><label>PF Deduct</label><input type="number" id="i-pf" value="1965.16" oninput="calcAll()"></div>
                    <div class="col"><label>ESI Deduct</label><input type="number" id="i-esi" value="0.00" oninput="calcAll()"></div>
                </div>
            </div>
        </div>

        <button class="btn btn-success" onclick="downloadPng()">
            <i class="fas fa-download"></i> Generate & Save Payslip
        </button>
        <div style="height:50px;"></div>
    </div>

    <div class="preview-area">
        <div id="payslip-paper">
            
            <div id="bg-pattern" class="bg-pattern"></div>
            
            <div id="p-watermark" class="watermark purple">U-MAN</div>

            <div id="comp-header" class="paper-header show">
                <div class="ph-title" id="c-name">UDA-MANDI SERVICES PVT LTD</div>
                <div class="ph-sub" id="c-addr">Unit 317, Road/Street: Bye-Pass Road, Mathura Road, Sector 37, Faridabad, Haryana - 121003</div>
                <div class="ph-line"></div>
            </div>

            <table class="std-table">
                <tr><th colspan="4" class="th-main">PAY SLIP (<span id="p-month">October, 2025</span>)</th></tr>
                <tr><td colspan="2">Emp Code: <span id="p-code"></span></td><td colspan="2">PF. No.: <span id="p-pfno"></span></td></tr>
                <tr><td colspan="2">Emp Name: <span id="p-name"></span></td><td colspan="2">E.S.I. No.:</td></tr>
                <tr><td colspan="2">F/H. Name: <span id="p-fname"></span></td><td colspan="2">D.O.J.: <span id="p-doj"></span></td></tr>

                <tr class="th-sub"><td>Working Day</td><td>Present Day</td><td colspan="2">Monthly Variable</td></tr>
                <tr><td class="aln-center"><span id="p-wday"></span></td><td class="aln-center"><span id="p-pday"></span></td><td colspan="2" class="aln-center"><span id="p-vhrs"></span> Hr.</td></tr>

                <tr class="th-sub"><td>EARNINGS</td><td>STRUCTURE</td><td>PAYABLE</td><td>DEDUCTIONS</td></tr>
                
                <tr>
                    <td>Basic</td>
                    <td class="aln-right"><span id="p-bs"></span></td>
                    <td class="aln-right"><span id="p-bp"></span></td>
                    <td><span class="f-bold">PF:</span> <span id="p-pf" class="c-blue"></span></td>
                </tr>
                <tr>
                    <td>Monthly V.Allowance</td>
                    <td class="aln-right"></td>
                    <td class="aln-right"><span id="p-mv"></span></td>
                    <td><span class="f-bold">ESI:</span> <span id="p-esi" class="c-blue"></span></td>
                </tr>
                <tr>
                    <td>Food Allowance</td>
                    <td class="aln-right"></td>
                    <td class="aln-right"><span id="p-food"></span></td>
                    <td><span class="f-bold">Bus:</span> <span id="p-bus" class="c-blue"></span></td>
                </tr>

                <tr>
                    <td class="f-bold">Total Rs.</td>
                    <td></td>
                    <td class="aln-right f-bold"><span id="p-tot-earn"></span></td>
                    <td class="aln-right f-bold"><span id="p-tot-ded"></span></td>
                </tr>

                <tr><th colspan="4" class="net-pay">Net Payable: Rs. <span id="p-net"></span></th></tr>
            </table>

            <div class="footer">"This is a Computer generated statement and does not require authentication"</div>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION (Updated Addresses) ---
    const companies = {
        'udamandi': { 
            name: "UDA-MANDI SERVICES PVT LTD", 
            // FULL ADDRESS HERE
            addr: "Unit 317, Road/Street: Bye-Pass Road, Mathura Road, Sector 37, Faridabad, Haryana - 121003", 
            wm: "U-MAN", 
            cls: "purple", 
            bg: false 
        },
        'gautam': { 
            name: "GAUTAM SOLAR PRIVATE LIMITED", 
            // FULL ADDRESS HERE
            addr: "7 KM Milestone, Tosham Road, Bhiwani, Haryana, INDIA", 
            wm: "GSPL", 
            cls: "red", 
            bg: true 
        }
    };
    
    // --- 2. INIT ---
    document.addEventListener("DOMContentLoaded", () => {
        const role = localStorage.getItem('role');
        if(role === 'admin') document.querySelector('.btn-admin').style.display = 'inline-flex';
        else if(!role) window.location.href = 'index.html';
        
        setCompany('udamandi');
        togglePFMode(); // Initialize Toggle State
        calcAll();
    });

    // --- 3. COMPANY LOGIC ---
    function setCompany(key) {
        const c = companies[key];
        document.querySelectorAll('.tile').forEach(el => el.classList.remove('active'));
        document.getElementById(`tile-${key}`).classList.add('active');
        
        document.getElementById('c-name').innerText = c.name;
        document.getElementById('c-addr').innerText = c.addr;
        
        const wm = document.getElementById('p-watermark');
        wm.innerText = c.wm;
        wm.className = `watermark ${c.cls}`;
        document.getElementById('bg-pattern').style.display = c.bg ? 'block' : 'none';
    }

    // --- 4. PF TOGGLE LOGIC (FIXED) ---
    function togglePFMode() {
        const isAuto = document.getElementById('pfToggle').checked;
        const pfInput = document.getElementById('i-pf');
        const msg = document.getElementById('pf-msg');

        if (isAuto) {
            // LOCK INPUT
            pfInput.setAttribute('readonly', true);
            pfInput.style.backgroundColor = "#e9ecef";
            msg.style.display = 'block';
            calcAll(); // Recalculate immediately
        } else {
            // UNLOCK INPUT
            pfInput.removeAttribute('readonly');
            pfInput.style.backgroundColor = "white";
            msg.style.display = 'none';
        }
    }

    // --- 5. CALCULATION ---
    const fmt = (n) => n.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});

    function calcAll() {
        // Gather Inputs
        let bs = parseFloat(document.getElementById('i-bs').value) || 0;
        let wday = parseFloat(document.getElementById('i-wday').value) || 0;
        let pday = parseFloat(document.getElementById('i-pday').value) || 0;
        
        // 1. Basic Payable
        let bp = (wday > 0) ? (bs / wday * pday) : 0;
        document.getElementById('i-bp').value = bp.toFixed(2);

        // 2. Variable
        let vhrs = parseFloat(document.getElementById('i-vhrs').value) || 0;
        let vrate = parseFloat(document.getElementById('i-vrate').value) || 0;
        let mv = vhrs * vrate;

        // 3. PF Logic
        let pf = 0;
        const isAutoPF = document.getElementById('pfToggle').checked;
        
        if (isAutoPF) {
            // Auto Calculate
            pf = Math.round(bp * 0.12);
            document.getElementById('i-pf').value = pf.toFixed(2);
        } else {
            // Manual Entry
            pf = parseFloat(document.getElementById('i-pf').value) || 0;
        }

        // 4. Totals
        let food = parseFloat(document.getElementById('i-food').value) || 0;
        let esi = parseFloat(document.getElementById('i-esi').value) || 0;
        let bus = parseFloat(document.getElementById('i-bus').value) || 0;

        let totEarn = bp + mv + food;
        let totDed = pf + esi + bus;
        let net = totEarn - totDed;

        // Update Preview
        updatePreview(bs, bp, mv, pf, esi, bus, food, totEarn, totDed, net);
    }

    function updatePreview(bs, bp, mv, pf, esi, bus, food, te, td, net) {
        // Sync Text Inputs
        const map = {
            'i-month': 'p-month', 'i-code': 'p-code', 'i-pfno': 'p-pfno',
            'i-name': 'p-name', 'i-fname': 'p-fname', 'i-doj': 'p-doj',
            'i-wday': 'p-wday', 'i-pday': 'p-pday', 'i-vhrs': 'p-vhrs'
        };
        for(let k in map) document.getElementById(map[k]).innerText = document.getElementById(k).value;

        // Sync Numbers
        document.getElementById('p-bs').innerText = fmt(bs);
        document.getElementById('p-bp').innerText = fmt(bp);
        document.getElementById('p-mv').innerText = fmt(mv);
        document.getElementById('p-food').innerText = fmt(food);
        document.getElementById('p-pf').innerText = fmt(pf);
        document.getElementById('p-esi').innerText = fmt(esi);
        document.getElementById('p-bus').innerText = bus;
        document.getElementById('p-tot-earn').innerText = fmt(te);
        document.getElementById('p-tot-ded').innerText = fmt(td);
        document.getElementById('p-net').innerText = fmt(net);
    }

    function upd() { calcAll(); }

    // --- 6. DOWNLOAD FIX ---
    function downloadPng() {
        const el = document.getElementById("payslip-paper");
        const loader = document.getElementById("loader");
        
        if (typeof html2canvas === 'undefined') {
            alert("Error: Script not loaded. Check internet connection.");
            return;
        }

        loader.style.display = "flex";

        // Slight delay to ensure UI updates
        setTimeout(() => {
            html2canvas(el, { scale: 3, backgroundColor: "#ffffff" })
            .then(canvas => {
                const link = document.createElement('a');
                link.download = `Payslip_${document.getElementById('i-name').value}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                loader.style.display = "none";
            })
            .catch(err => {
                console.error(err);
                alert("Download failed.");
                loader.style.display = "none";
            });
        }, 500);
    }

    function logout() { localStorage.clear(); window.location.href = 'index.html'; }
</script>

</body>
</html>
