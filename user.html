<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>पेस्लिप जेनरेटर | Uda-Mandi</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- RESET & BASE --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, Helvetica, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* --- CONTAINER --- */
        .main-container {
            max-width: 1300px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }

        /* --- HEADER --- */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: linear-gradient(90deg, #2c3e50, #4a6278);
            color: white;
            border-bottom: 3px solid #3498db;
        }

        .app-header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-header h1 i {
            color: #f39c12;
        }

        .header-controls {
            display: flex;
            gap: 15px;
        }

        /* --- BUTTONS --- */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: #2980b9;
            color: white;
        }

        .btn-primary:hover {
            background: #1f6391;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(41, 128, 185, 0.3);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-download {
            background: #27ae60;
            color: white;
            font-size: 16px;
            padding: 12px 30px;
            margin-top: 20px;
            width: 100%;
        }

        .btn-download:hover {
            background: #219653;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        /* --- MAIN LAYOUT --- */
        .content-wrapper {
            display: flex;
            min-height: 750px;
        }

        /* --- FORM SECTION --- */
        .form-container {
            flex: 1;
            padding: 25px;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
        }

        .form-container h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #3498db;
        }

        .input-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"] {
            width: 100%;
            padding: 11px 15px;
            margin-bottom: 15px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .input-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-row > div {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 6px;
            color: #34495e;
            font-weight: 500;
            font-size: 13px;
        }

        .calculation-box {
            background: #e8f4fc;
            padding: 12px;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px dashed #3498db;
            font-size: 13px;
            text-align: right;
        }

        /* --- PREVIEW SECTION --- */
        .preview-container {
            flex: 1.2;
            padding: 30px;
            background: #555;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow-y: auto;
        }

        /* --- EXACT PAYSLIP DESIGN --- */
        #payslip-box {
            width: 700px;
            background: white;
            position: relative;
            font-family: Arial, Helvetica, sans-serif;
            color: #000;
            box-sizing: border-box;
            padding: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        /* EXACT WATERMARK */
        .watermark {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-35deg);
            font-size: 110px;
            font-weight: 900;
            color: rgba(100, 80, 180, 0.10);
            z-index: 0;
            pointer-events: none;
            letter-spacing: 6px;
            text-transform: uppercase;
            white-space: nowrap;
            font-family: Arial, sans-serif;
        }

        /* EXACT TABLE */
        table.exact-table {
            width: 100%;
            border-collapse: collapse;
            z-index: 2;
            position: relative;
            background: transparent;
            table-layout: fixed;
        }

        table.exact-table th, 
        table.exact-table td {
            border: 1px solid #000;
            padding: 5px 8px;
            font-size: 12.5px;
            vertical-align: middle;
            line-height: 1.3;
        }

        .header-title { 
            font-weight: bold; 
            text-align: center; 
            font-size: 15px; 
            padding: 8px !important;
            background-color: #f0f0f0;
        }
        
        .section-header { 
            background: #e8e8e8; 
            font-weight: bold; 
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .text-bold { font-weight: bold; }
        
        /* EXACT BLUE TEXT FOR DEDUCTIONS */
        .blue-text { 
            color: #2e74b5; 
            font-weight: 600;
            font-family: Arial, Helvetica, sans-serif;
        }
        
        /* NET PAY ROW */
        .net-row {
            background: #f0f8ff !important;
            font-size: 15px !important;
            font-weight: bold !important;
            padding: 10px !important;
        }
        
        /* FOOTER NOTE */
        .footer-note {
            text-align: center;
            margin-top: 25px;
            font-size: 11px;
            font-style: italic;
            color: #666;
            border-top: 1px dashed #aaa;
            padding-top: 10px;
        }

        /* --- LOADING OVERLAY --- */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
        }

        .loading-overlay.active {
            display: flex;
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 1200px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .form-container, 
            .preview-container {
                width: 100%;
            }
            
            #payslip-box {
                width: 100%;
                max-width: 700px;
            }
            
            .app-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-controls {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            #payslip-box {
                padding: 5px;
            }
            
            .watermark {
                font-size: 70px;
            }
            
            .input-row {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>

<!-- लोडिंग ओवरले -->
<div class="loading-overlay" id="loadingOverlay">
    <div style="text-align: center;">
        <i class="fas fa-spinner fa-spin fa-3x" style="margin-bottom: 20px;"></i>
        <h3>पेस्लिप जेनरेट हो रही है...</h3>
        <p style="margin-top: 10px; font-size: 14px;">कृपया प्रतीक्षा करें</p>
    </div>
</div>

<div class="main-container">
    <!-- हेडर -->
    <div class="app-header">
        <h1><i class="fas fa-file-invoice"></i> पेस्लिप जेनरेटर - Uda-Mandi</h1>
        <div class="header-controls">
            <button class="btn btn-primary admin-controls" onclick="window.location.href='admin.html'">
                <i class="fas fa-tachometer-alt"></i> डैशबोर्ड
            </button>
            <button class="btn btn-danger" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> लॉगआउट
            </button>
        </div>
    </div>
    
    <!-- मुख्य सामग्री -->
    <div class="content-wrapper">
        <!-- फॉर्म सेक्शन -->
        <div class="form-container">
            <h2><i class="fas fa-edit"></i> पेस्लिप विवरण दर्ज करें</h2>
            
            <!-- कर्मचारी विवरण -->
            <div class="input-section">
                <h3><i class="fas fa-user-tie"></i> कर्मचारी विवरण</h3>
                <input type="text" id="i-month" value="अक्टूबर, 2025" placeholder="माह और वर्ष" oninput="updatePayslip()">
                
                <div class="input-row">
                    <div>
                        <label>कर्मचारी कोड</label>
                        <input type="text" id="i-code" value="6138" placeholder="कर्मचारी कोड" oninput="updatePayslip()">
                    </div>
                    <div>
                        <label>पीएफ नंबर</label>
                        <input type="text" id="i-pfno" placeholder="पीएफ नंबर" oninput="updatePayslip()">
                    </div>
                </div>
                
                <div class="input-row">
                    <div>
                        <label>कर्मचारी का नाम</label>
                        <input type="text" id="i-name" value="शिवश्री कुमार" placeholder="कर्मचारी का नाम" oninput="updatePayslip()">
                    </div>
                    <div>
                        <label>पिता का नाम</label>
                        <input type="text" id="i-fname" value="संतोष कुमार" placeholder="पिता का नाम" oninput="updatePayslip()">
                    </div>
                </div>
                
                <label>कार्यग्रहण तिथि (D.O.J.)</label>
                <input type="date" id="i-doj" value="2025-05-15" oninput="updatePayslip()">
            </div>

            <!-- उपस्थिति और परिवर्तन -->
            <div class="input-section" style="border-left-color: #9b59b6;">
                <h3><i class="fas fa-calendar-alt"></i> उपस्थिति एवं परिवर्तन</h3>
                <div class="input-row">
                    <div>
                        <label>कार्य दिवस</label>
                        <input type="number" id="i-wday" value="23" placeholder="कार्य दिवस" oninput="updatePayslip()">
                    </div>
                    <div>
                        <label>उपस्थिति दिवस</label>
                        <input type="number" id="i-pday" value="16" placeholder="उपस्थिति दिवस" oninput="updatePayslip()">
                    </div>
                </div>
                
                <div class="input-row">
                    <div>
                        <label>परिवर्तन घंटे</label>
                        <input type="number" id="i-var-hrs" value="72.4" placeholder="परिवर्तन घंटे" step="0.1" oninput="updatePayslip()">
                    </div>
                    <div>
                        <label>दर (प्रति घंटा)</label>
                        <input type="number" id="i-var-rate" value="105" placeholder="दर प्रति घंटा" oninput="updatePayslip()">
                    </div>
                </div>
                
                <div class="calculation-box">
                    गणना: <span id="lbl-calc-var">7,602.00</span> रुपये
                    <br>
                    <small>(परिवर्तन घंटे × दर)</small>
                </div>
            </div>

            <!-- वित्तीय विवरण -->
            <div class="input-section" style="border-left-color: #27ae60;">
                <h3><i class="fas fa-rupee-sign"></i> वित्तीय विवरण</h3>
                
                <div class="input-row">
                    <div>
                        <label>मूल वेतन (संरचना)</label>
                        <input type="number" id="i-bas-str" value="23541" placeholder="संरचना" oninput="updatePayslip()">
                    </div>
                    <div>
                        <label>मूल वेतन (देय)</label>
                        <input type="number" id="i-bas-pay" value="16376.35" placeholder="देय" oninput="updatePayslip()">
                    </div>
                </div>
                
                <div class="input-row">
                    <div>
                        <label>भोजन भत्ता</label>
                        <input type="number" id="i-food" value="3000" placeholder="भोजन भत्ता" oninput="updatePayslip()">
                    </div>
                    <div>
                        <label>बस शुल्क (कटौती)</label>
                        <input type="number" id="i-bus" value="750" placeholder="बस शुल्क" oninput="updatePayslip()">
                    </div>
                </div>
                
                <div class="input-row">
                    <div>
                        <label>पीएफ कटौती</label>
                        <input type="number" id="i-pf" value="1965.16" placeholder="पीएफ कटौती" oninput="updatePayslip()">
                    </div>
                    <div>
                        <label>ईएसआई कटौती</label>
                        <input type="number" id="i-esi" value="0.00" placeholder="ईएसआई कटौती" oninput="updatePayslip()">
                    </div>
                </div>
            </div>

            <!-- डाउनलोड बटन -->
            <button class="btn btn-download" onclick="downloadPayslip()">
                <i class="fas fa-download"></i> पेस्लिप डाउनलोड करें (PNG)
            </button>
            
            <div style="margin-top: 15px; font-size: 13px; color: #7f8c8d; text-align: center;">
                <i class="fas fa-info-circle"></i> उच्च गुणवत्ता वाली PNG फाइल डाउनलोड होगी
            </div>
        </div>

        <!-- प्रीव्यू सेक्शन -->
        <div class="preview-container">
            <div id="payslip-box">
                <!-- वॉटरमार्क -->
                <div class="watermark">Uda-Mandi</div>

                <!-- पेस्लिप टेबल -->
                <table class="exact-table">
                    <tr>
                        <th colspan="4" class="header-title">PAY SLIP (<span id="p-month">अक्टूबर, 2025</span>)</th>
                    </tr>
                    
                    <tr>
                        <td colspan="2">Emp Code: <span id="p-code">6138</span></td>
                        <td colspan="2">PF. No.: <span id="p-pfno"></span></td>
                    </tr>
                    
                    <tr>
                        <td colspan="2">Emp Name: <span id="p-name">शिवश्री कुमार</span></td>
                        <td colspan="2">E.S.I. No.:</td>
                    </tr>
                    
                    <tr>
                        <td colspan="2">F/H. Name: <span id="p-fname">संतोष कुमार</span></td>
                        <td colspan="2">D.O.J.: <span id="p-doj">2025-05-15</span></td>
                    </tr>

                    <tr class="section-header">
                        <td>Working Day</td>
                        <td>Present Day</td>
                        <td colspan="2">Monthly Variable</td>
                    </tr>

                    <tr>
                        <td class="text-center"><span id="p-wday">23</span></td>
                        <td class="text-center"><span id="p-pday">16</span></td>
                        <td colspan="2" class="text-center"><span id="p-var-hrs">72.4</span> Hr.</td>
                    </tr>

                    <tr class="section-header">
                        <td>EARNINGS</td>
                        <td>STRUCTURE</td>
                        <td>PAYABLE</td>
                        <td>DEDUCTIONS</td>
                    </tr>

                    <tr>
                        <td>Basic</td>
                        <td class="text-right"><span id="p-bas-str">23,541.00</span></td>
                        <td class="text-right"><span id="p-bas-pay">16,376.35</span></td>
                        <td><span class="text-bold">PF:</span> <span id="p-pf" class="blue-text">1,965.16</span></td>
                    </tr>

                    <tr>
                        <td>Monthly V.Allowance</td>
                        <td class="text-right"></td>
                        <td class="text-right"><span id="p-mv-pay">7,602.00</span></td>
                        <td><span class="text-bold">ESI:</span> <span id="p-esi" class="blue-text">0.00</span></td>
                    </tr>

                    <tr>
                        <td>Food Allowance</td>
                        <td class="text-right"></td>
                        <td class="text-right"><span id="p-food">3,000.0</span></td>
                        <td><span class="text-bold">Bus:</span> <span id="p-bus" class="blue-text">750</span></td>
                    </tr>

                    <tr>
                        <td class="text-bold">Total Rs.</td>
                        <td></td>
                        <td class="text-right text-bold"><span id="p-tot-earn">26,978.35</span></td>
                        <td class="text-right text-bold"><span id="p-tot-ded">2,715.16</span></td>
                    </tr>

                    <tr class="net-row">
                        <th colspan="4" class="text-center">
                            Net Payable: Rs. <span id="p-net">24,263.19</span>
                        </th>
                    </tr>
                </table>

                <!-- फुटर नोट -->
                <div class="footer-note">
                    "This is a Computer generated statement and does not require authentication"
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- प्रमाणीकरण जांच ---
    document.addEventListener('DOMContentLoaded', function() {
        const role = localStorage.getItem('role');
        const currentUser = localStorage.getItem('currentUser');
        
        if (role === 'admin') {
            document.querySelector('.admin-controls').style.display = 'inline-flex';
        } else if (!role) {
            window.location.href = 'index.html';
        }
        
        // प्रारंभिक अपडेट
        updatePayslip();
    });

    // --- संख्या स्वरूपण सहायक ---
    function formatIndianCurrency(num, decimals = 2) {
        if (isNaN(num)) num = 0;
        return num.toLocaleString('en-IN', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }

    // --- मुख्य अपडेट फ़ंक्शन ---
    function updatePayslip() {
        // 1. टेक्स्ट फील्ड अपडेट
        const textFields = [
            { input: 'i-month', output: 'p-month' },
            { input: 'i-code', output: 'p-code' },
            { input: 'i-pfno', output: 'p-pfno' },
            { input: 'i-name', output: 'p-name' },
            { input: 'i-fname', output: 'p-fname' },
            { input: 'i-doj', output: 'p-doj' },
            { input: 'i-wday', output: 'p-wday' },
            { input: 'i-pday', output: 'p-pday' },
            { input: 'i-var-hrs', output: 'p-var-hrs' }
        ];
        
        textFields.forEach(field => {
            const inputEl = document.getElementById(field.input);
            const outputEl = document.getElementById(field.output);
            if (inputEl && outputEl) {
                outputEl.textContent = inputEl.value;
            }
        });
        
        // 2. गणना
        // परिवर्तन गणना
        const varHours = parseFloat(document.getElementById('i-var-hrs').value) || 0;
        const varRate = parseFloat(document.getElementById('i-var-rate').value) || 0;
        const mvValue = varHours * varRate;
        document.getElementById('lbl-calc-var').textContent = formatIndianCurrency(mvValue);
        
        // आय गणना
        const basicStruct = parseFloat(document.getElementById('i-bas-str').value) || 0;
        const basicPayable = parseFloat(document.getElementById('i-bas-pay').value) || 0;
        const foodAllowance = parseFloat(document.getElementById('i-food').value) || 0;
        
        // कटौती गणना
        const pfDeduction = parseFloat(document.getElementById('i-pf').value) || 0;
        const esiDeduction = parseFloat(document.getElementById('i-esi').value) || 0;
        const busDeduction = parseFloat(document.getElementById('i-bus').value) || 0;
        
        // कुल गणना
        const totalEarnings = basicPayable + mvValue + foodAllowance;
        const totalDeductions = pfDeduction + esiDeduction + busDeduction;
        const netPayable = totalEarnings - totalDeductions;
        
        // 3. टेबल अपडेट
        document.getElementById('p-bas-str').textContent = formatIndianCurrency(basicStruct);
        document.getElementById('p-bas-pay').textContent = formatIndianCurrency(basicPayable);
        document.getElementById('p-mv-pay').textContent = formatIndianCurrency(mvValue);
        document.getElementById('p-food').textContent = formatIndianCurrency(foodAllowance, 1);
        
        document.getElementById('p-pf').textContent = formatIndianCurrency(pfDeduction);
        document.getElementById('p-esi').textContent = formatIndianCurrency(esiDeduction);
        document.getElementById('p-bus').textContent = busDeduction; // बस शुल्क में दशमलव नहीं
        
        document.getElementById('p-tot-earn').textContent = formatIndianCurrency(totalEarnings);
        document.getElementById('p-tot-ded').textContent = formatIndianCurrency(totalDeductions);
        document.getElementById('p-net').textContent = formatIndianCurrency(netPayable);
    }

    // --- डाउनलोड फ़ंक्शन ---
    function downloadPayslip() {
        const payslipElement = document.getElementById("payslip-box");
        const loadingOverlay = document.getElementById("loadingOverlay");
        
        // लोडिंग दिखाएं
        loadingOverlay.classList.add('active');
        
        // उच्च गुणवत्ता वाली छवि बनाएं
        html2canvas(payslipElement, { 
            scale: 4,
            backgroundColor: '#FFFFFF',
            useCORS: true,
            logging: false,
            allowTaint: true,
            imageTimeout: 0
        }).then(canvas => {
            const link = document.createElement('a');
            const employeeName = document.getElementById('i-name').value || 'Employee';
            const month = document.getElementById('i-month').value || 'Month';
            const fileName = `Payslip_${employeeName.replace(/\s+/g, '_')}_${month.replace(/\s+/g, '_')}.png`;
            
            link.download = fileName;
            link.href = canvas.toDataURL("image/png", 1.0);
            link.click();
            
            // लोडिंग छिपाएं
            loadingOverlay.classList.remove('active');
            
            // सफलता संदेश
            showNotification('पेस्लिप सफलतापूर्वक डाउनलोड हो गई!', 'success');
        }).catch(error => {
            console.error('त्रुटि:', error);
            loadingOverlay.classList.remove('active');
            showNotification('डाउनलोड विफल। कृपया पुनः प्रयास करें।', 'error');
        });
    }

    // --- लॉगआउट फ़ंक्शन ---
    function logout() {
        if (confirm('क्या आप लॉगआउट करना चाहते हैं?')) {
            localStorage.removeItem('role');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }
    }

    // --- सूचना प्रदर्शित करें ---
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 15px 25px;
            background: ${type === 'success' ? '#27ae60' : '#e74c3c'};
            color: white;
            border-radius: 8px;
            z-index: 10000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        `;
        
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        notification.innerHTML = `
            <i class="fas ${icon} fa-lg"></i>
            <div>
                <strong>${type === 'success' ? 'सफलता!' : 'त्रुटि!'}</strong><br>
                <span style="font-size: 14px;">${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // स्वचालित रूप से हटाएं
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 4000);
    }

    // एनिमेशन स्टाइल जोड़ें
    const styleSheet = document.createElement('style');
    styleSheet.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(styleSheet);
</script>

</body>
</html>
