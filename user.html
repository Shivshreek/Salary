<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uda-Mandi Enterprise Payroll</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. GLOBAL SETTINGS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh; padding: 20px; display: flex; justify-content: center; align-items: center;
        }

        /* --- 2. LAYOUT --- */
        .main-container {
            width: 100%; max-width: 1400px; background: white; border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4); overflow: hidden; display: flex; flex-direction: column; height: 95vh;
        }

        .app-header {
            height: 65px; background: #fff; padding: 0 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f0f0;
        }
        .header-title { font-size: 22px; font-weight: 800; color: #1e3c72; display: flex; align-items: center; gap: 10px; }
        .content-wrapper { display: flex; flex: 1; overflow: hidden; }

        /* --- 3. INPUT PANEL --- */
        .input-panel {
            flex: 1; min-width: 400px; background: #f4f7f6; padding: 25px; border-right: 1px solid #e0e0e0;
            overflow-y: auto; max-height: calc(95vh - 65px);
        }

        .section-box {
            background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 15px; border-left: 5px solid #1e3c72;
        }
        .section-box h3 { font-size: 14px; margin-bottom: 10px; font-weight: 700; color: #444; border-bottom: 1px solid #eee; padding-bottom: 5px; }

        /* Inputs */
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        .col { flex: 1; }
        label { display: block; font-size: 11px; font-weight: 700; color: #555; margin-bottom: 4px; text-transform: uppercase; }
        
        /* STANDARD INPUT STYLE */
        input { 
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; font-weight: 600;
            background-color: #fff; /* Default White */
        }
        input:focus { border-color: #1e3c72; outline: none; background: #fff; }
        
        /* READONLY INPUT STYLE (Auto Calculated) */
        input[readonly] { 
            background-color: #e9ecef !important; 
            color: #555; 
            cursor: not-allowed; 
            border: 1px solid #ddd; 
        }

        /* Company Select */
        .company-tiles { display: flex; gap: 10px; }
        .tile {
            flex: 1; padding: 12px; border: 2px solid #eee; border-radius: 8px; text-align: center; cursor: pointer; background: #fff; transition: 0.2s;
        }
        .tile.active { border-color: #27ae60; background: #eafff0; color: #006400; font-weight: bold; }

        /* Toggle */
        .toggle-wrapper { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        .toggle-switch { position: relative; width: 40px; height: 20px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #27ae60; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Buttons */
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
        .btn-download { background: #27ae60; width: 100%; font-size: 16px; margin-top: 15px; padding: 14px; }
        .btn-logout { background: #c0392b; margin-left: 10px; }
        .btn-admin { background: #f39c12; display: none; }

        /* --- 4. PREVIEW PANEL --- */
        .preview-panel {
            flex: 1.6; min-width: 500px; background: #555; padding: 40px;
            display: flex; justify-content: center; align-items: flex-start;
            overflow-y: auto; max-height: calc(95vh - 65px);
        }

        /* --- 5. PAYSLIP PAPER --- */
        #payslip-paper {
            width: 794px; /* A4 */
            background: white;
            padding: 40px 50px;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
            position: relative;
            font-family: Arial, Helvetica, sans-serif;
            color: #000;
            z-index: 1;
        }

        /* HEADER (Full Address Fix) */
        .company-header { text-align: center; margin-bottom: 25px; display: none; z-index: 5; position: relative; }
        .company-header.active { display: block; }
        
        .comp-name {
            font-family: 'Arial Black', Arial, sans-serif;
            font-size: 30px; 
            font-weight: 900; 
            text-transform: uppercase;
            color: #222; 
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        .comp-details { 
            font-size: 14px; 
            color: #333; 
            font-weight: 600; 
            line-height: 1.6;
            margin: 0 auto;
            white-space: pre-wrap; 
            word-wrap: break-word; /* KEY FIX: Forces text to wrap */
            width: 100%;
        }
        .header-line { border-bottom: 2px solid #ccc; width: 100%; margin-top: 15px; }

        /* WATERMARK */
        .watermark {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            font-size: 120px; font-weight: 900; z-index: 0; pointer-events: none;
            letter-spacing: 10px; white-space: nowrap; text-transform: uppercase;
            font-family: 'Arial Black', sans-serif; opacity: 0.15;
        }
        .watermark.udamandi { color: #6a4ca8; } 
        .watermark.gautam { color: #800000; }
        
        .gspl-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(#800000 1px, transparent 1px);
            background-size: 20px 20px; opacity: 0.04; z-index: 0; pointer-events: none; display: none;
        }

        /* TABLE */
        table.slip-table {
            width: 100%; border-collapse: collapse; position: relative; z-index: 2; 
            margin-top: 15px; border: 2px solid #000; background: transparent !important;
        }
        table.slip-table th, table.slip-table td {
            border: 1px solid #000; padding: 8px 10px; font-size: 13px; vertical-align: middle; line-height: 1.4;
            background: transparent;
        }
        
        .th-main { background: rgba(255,255,255,0.95) !important; font-weight: bold; text-align: center; font-size: 16px; padding: 12px !important; border-bottom: 2px solid #000; }
        .th-sub { background: #f0f0f0 !important; font-weight: bold; font-size: 12px; text-transform: uppercase; }
        
        .align-r { text-align: right; }
        .align-c { text-align: center; }
        .bold { font-weight: bold; }
        .blue { color: #1a73e8; font-weight: 700; }
        
        .net-pay { font-size: 18px; font-weight: bold; text-align: center; padding: 12px !important; background: #fff !important; border-top: 2px solid #000; }
        .footer { text-align: center; font-size: 11px; font-style: italic; margin-top: 30px; color: #555; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; display: none; justify-content: center; align-items: center; color: white; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top: 4px solid #27ae60; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><h3>Creating PNG...</h3></div>

<div class="main-container">
    <div class="app-header">
        <div class="header-title"><i class="fas fa-file-invoice"></i> Uda-Mandi Enterprise</div>
        <div>
            <button class="btn btn-admin" onclick="location.href='admin.html'">Admin</button>
            <button class="btn btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="content-wrapper">
        <div class="input-panel">
            
            <div class="section-box" style="border-left-color: #9b59b6;">
                <h3><i class="fas fa-building"></i> Select Company</h3>
                <div class="company-tiles">
                    <div class="tile active" id="tile-udamandi" onclick="setCompany('udamandi')">Uda-Mandi</div>
                    <div class="tile" id="tile-gautam" onclick="setCompany('gautam')">Gautam Solar</div>
                </div>
            </div>

            <div class="section-box" style="border-left-color: #e74c3c;">
                <h3><i class="fas fa-calculator"></i> Logic</h3>
                <div class="toggle-wrapper">
                    <span style="font-weight:600; font-size:13px;">Auto PF (12%)</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="pfToggle" onchange="togglePF()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="pf-hint" style="font-size:11px; color:gray; margin-top:5px; display:none;">*PF Locked to 12% of Basic Pay</div>
            </div>

            <div class="section-box" style="border-left-color: #3498db;">
                <h3><i class="fas fa-user"></i> Employee</h3>
                <div class="row"><div class="col"><label>Month</label><input type="text" id="i-month" value="October, 2025" oninput="calc()"></div><div class="col"><label>Code</label><input type="text" id="i-code" value="6138" oninput="calc()"></div></div>
                <div class="row"><div class="col"><label>Name</label><input type="text" id="i-name" value="Shivshree Kumar" oninput="calc()"></div></div>
                <div class="row"><div class="col"><label>Father Name</label><input type="text" id="i-fname" value="Santosh Kumar" oninput="calc()"></div></div>
                <div class="row"><div class="col"><label>PF No.</label><input type="text" id="i-pfno" placeholder="-" oninput="calc()"></div><div class="col"><label>DOJ</label><input type="date" id="i-doj" value="2025-05-15" oninput="calc()"></div></div>
            </div>

            <div class="section-box" style="border-left-color: #f39c12;">
                <h3><i class="fas fa-clock"></i> Attendance</h3>
                <div class="row"><div class="col"><label>Work Days</label><input type="number" id="i-wday" value="23" oninput="calc()"></div><div class="col"><label>Pres Days</label><input type="number" id="i-pday" value="16" oninput="calc()"></div></div>
                <div class="row" style="background:#f9f9f9; padding:8px; border-radius:5px;"><div class="col"><label>Var Hrs</label><input type="number" id="i-vhrs" value="72.4" oninput="calc()"></div><div class="col"><label>Rate</label><input type="number" id="i-vrate" value="105" oninput="calc()"></div></div>
            </div>

            <div class="section-box" style="border-left-color: #27ae60;">
                <h3><i class="fas fa-rupee-sign"></i> Salary</h3>
                <div class="row"><div class="col"><label>Basic (Str)</label><input type="number" id="i-bs" value="23541" oninput="calc()"></div><div class="col"><label>Basic (Pay)</label><input type="number" id="i-bp" value="16376.35" readonly></div></div>
                <div class="row"><div class="col"><label>Food</label><input type="number" id="i-food" value="3000" oninput="calc()"></div><div class="col"><label>Bus</label><input type="number" id="i-bus" value="750" oninput="calc()"></div></div>
                <div class="row">
                    <div class="col"><label>PF Deduct</label><input type="number" id="i-pf" value="1965.16" step="0.01" oninput="calc()"></div>
                    <div class="col"><label>ESI Deduct</label><input type="number" id="i-esi" value="0.00" oninput="calc()"></div>
                </div>
            </div>

            <button class="btn btn-download" onclick="downloadPng()"><i class="fas fa-download"></i> Download Payslip</button>
        </div>

        <div class="preview-panel">
            <div id="payslip-paper">
                
                <div class="gspl-bg" id="bg-gspl"></div>
                <div class="watermark udamandi" id="p-watermark">U-MAN</div>

                <div class="company-header active" id="comp-header">
                    <div class="comp-name" id="c-name">UDA-MANDI SERVICES PVT LTD</div>
                    <div class="comp-details" id="c-addr">Unit 317, Road/Street: Bye-Pass Road, Mathura Road, Sector 37, Faridabad, Haryana - 121003</div>
                    <div class="header-line"></div>
                </div>

                <table class="slip-table">
                    <tr><th colspan="4" class="th-main">PAY SLIP (<span id="p-month">October, 2025</span>)</th></tr>
                    <tr><td colspan="2">Emp Code: <span id="p-code"></span></td><td colspan="2">PF. No.: <span id="p-pfno"></span></td></tr>
                    <tr><td colspan="2">Emp Name: <span id="p-name"></span></td><td colspan="2">E.S.I. No.:</td></tr>
                    <tr><td colspan="2">F/H. Name: <span id="p-fname"></span></td><td colspan="2">D.O.J.: <span id="p-doj"></span></td></tr>

                    <tr class="th-sub"><td>WORKING DAY</td><td>PRESENT DAY</td><td colspan="2">MONTHLY VARIABLE</td></tr>
                    <tr><td class="align-c"><span id="p-wday"></span></td><td class="align-c"><span id="p-pday"></span></td><td colspan="2" class="align-c"><span id="p-vhrs"></span> Hr.</td></tr>

                    <tr class="th-sub"><td>EARNINGS</td><td>STRUCTURE</td><td>PAYABLE</td><td>DEDUCTIONS</td></tr>
                    <tr><td>Basic</td><td class="align-r"><span id="p-bs"></span></td><td class="align-r"><span id="p-bp"></span></td><td><span class="bold">PF:</span> <span id="p-pf" class="blue"></span></td></tr>
                    <tr><td>Monthly V.Allowance</td><td class="align-r"></td><td class="align-r"><span id="p-mv"></span></td><td><span class="bold">ESI:</span> <span id="p-esi" class="blue"></span></td></tr>
                    <tr><td>Food Allowance</td><td class="align-r"></td><td class="align-r"><span id="p-food"></span></td><td><span class="bold">Bus:</span> <span id="p-bus" class="blue"></span></td></tr>
                    <tr><td class="bold">Total Rs.</td><td></td><td class="align-r bold"><span id="p-tot-earn"></span></td><td class="align-r bold"><span id="p-tot-ded"></span></td></tr>
                    <tr><th colspan="4" class="net-pay">Net Payable: Rs. <span id="p-net"></span></th></tr>
                </table>

                <div class="footer">"This is a Computer generated statement and does not require authentication"</div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIG ---
    const companies = {
        'udamandi': {
            name: "UDA-MANDI SERVICES PVT LTD",
            addr: "Unit 317, Road/Street: Bye-Pass Road, Mathura Road, Sector 37, Faridabad, Haryana - 121003",
            wm: "U-MAN", cls: "purple", bg: false
        },
        'gautam': {
            name: "GAUTAM SOLAR PRIVATE LIMITED",
            addr: "7 KM Milestone, Tosham Road, Bhiwani, Haryana, INDIA",
            wm: "GSPL", cls: "red", bg: true
        }
    };

    // --- 2. INIT ---
    document.addEventListener("DOMContentLoaded", () => {
        const role = localStorage.getItem('role');
        if(role === 'admin') document.querySelector('.btn-admin').style.display = 'inline-flex';
        else if(!role) window.location.href = 'index.html';
        
        setCompany('udamandi');
        togglePF(); // Initialize Toggle State
        calc(); // First Calculation
    });

    // --- 3. COMPANY LOGIC ---
    function setCompany(key) {
        const c = companies[key];
        document.querySelectorAll('.tile').forEach(t => t.classList.remove('active'));
        document.getElementById(`tile-${key}`).classList.add('active');

        document.getElementById('c-name').innerText = c.name;
        document.getElementById('c-addr').innerText = c.addr;
        
        const wm = document.getElementById('p-watermark');
        wm.innerText = c.wm;
        wm.className = `watermark ${c.cls}`;
        document.getElementById('bg-gspl').style.display = c.bg ? 'block' : 'none';
    }

    // --- 4. PF LOGIC ---
    function togglePF() {
        const isAuto = document.getElementById('pfToggle').checked;
        const pfInput = document.getElementById('i-pf');
        const hint = document.getElementById('pf-hint');

        if(isAuto) {
            // LOCK INPUT
            pfInput.setAttribute('readonly', true);
            pfInput.style.backgroundColor = "#e9ecef";
            hint.style.display = 'block';
            calc(); // Force Recalc
        } else {
            // UNLOCK INPUT
            pfInput.removeAttribute('readonly');
            pfInput.style.backgroundColor = "#fff";
            hint.style.display = 'none';
        }
    }

    // --- 5. CALCULATION ---
    const fmt = (n) => n.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});

    function calc() {
        // Inputs
        let bs = parseFloat(document.getElementById('i-bs').value) || 0;
        let wday = parseFloat(document.getElementById('i-wday').value) || 0;
        let pday = parseFloat(document.getElementById('i-pday').value) || 0;
        
        // 1. Basic Payable
        let bp = (wday > 0) ? (bs / wday * pday) : 0;
        document.getElementById('i-bp').value = bp.toFixed(2);

        // 2. Variable
        let vhrs = parseFloat(document.getElementById('i-vhrs').value) || 0;
        let vrate = parseFloat(document.getElementById('i-vrate').value) || 0;
        let mv = vhrs * vrate;

        // 3. PF
        let pf = 0;
        const isAuto = document.getElementById('pfToggle').checked;
        if(isAuto) {
            pf = Math.round(bp * 0.12);
            // Only update value if auto, otherwise respect user input
            document.getElementById('i-pf').value = pf.toFixed(2);
        } else {
            // Manual: just read what user typed
            pf = parseFloat(document.getElementById('i-pf').value) || 0;
        }

        // 4. Totals
        let food = parseFloat(document.getElementById('i-food').value) || 0;
        let esi = parseFloat(document.getElementById('i-esi').value) || 0;
        let bus = parseFloat(document.getElementById('i-bus').value) || 0;

        let totEarn = bp + mv + food;
        let totDed = pf + esi + bus;
        let net = totEarn - totDed;

        updateTable(bs, bp, mv, pf, esi, bus, food, totEarn, totDed, net);
    }

    function updateTable(bs, bp, mv, pf, esi, bus, food, te, td, net) {
        // Text
        const ids = ['i-month', 'i-code', 'i-pfno', 'i-name', 'i-fname', 'i-doj', 'i-wday', 'i-pday', 'i-vhrs'];
        const targets = ['p-month', 'p-code', 'p-pfno', 'p-name', 'p-fname', 'p-doj', 'p-wday', 'p-pday', 'p-vhrs'];
        ids.forEach((id, i) => document.getElementById(targets[i]).innerText = document.getElementById(id).value);

        // Numbers
        document.getElementById('p-bs').innerText = fmt(bs);
        document.getElementById('p-bp').innerText = fmt(bp);
        document.getElementById('p-mv').innerText = fmt(mv);
        document.getElementById('p-food').innerText = fmt(food);
        document.getElementById('p-pf').innerText = fmt(pf);
        document.getElementById('p-esi').innerText = fmt(esi);
        document.getElementById('p-bus').innerText = bus;
        document.getElementById('p-tot-earn').innerText = fmt(te);
        document.getElementById('p-tot-ded').innerText = fmt(td);
        document.getElementById('p-net').innerText = fmt(net);
    }

    function downloadPng() {
        const el = document.getElementById("payslip-paper");
        document.getElementById("loader").style.display = "flex";
        setTimeout(() => {
            html2canvas(el, { scale: 3, backgroundColor: "#fff" }).then(c => {
                const a = document.createElement('a');
                a.download = `Payslip_${document.getElementById('i-name').value}.png`;
                a.href = c.toDataURL("image/png");
                a.click();
                document.getElementById("loader").style.display = "none";
            });
        }, 500);
    }

    function logout() { localStorage.clear(); window.location.href = 'index.html'; }
</script>

</body>
</html>
