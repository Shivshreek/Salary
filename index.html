<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Portal Pro | Shivshree Kumar - September 2025</title>
    
    <!-- Firebase SDKs (Fixed Versions) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics-compat.js"></script>
    
    <!-- Other dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
                        success: { 50: '#f0fdf4', 500: '#22c55e', 600: '#16a34a' },
                        warning: { 50: '#fefce8', 500: '#f59e0b', 600: '#d97706' },
                        danger: { 50: '#fef2f2', 500: '#ef4444', 600: '#dc2626' }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Keep all your existing CSS styles */
        /* ... existing CSS ... */
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 dark:from-slate-900 dark:to-slate-800 min-h-screen text-slate-800 dark:text-slate-200">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white dark:bg-slate-900">
        <div class="relative">
            <div class="w-20 h-20 border-4 border-primary-100 dark:border-slate-700 border-t-primary-600 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i data-lucide="calculator" class="w-8 h-8 text-primary-600 dark:text-primary-400"></i>
            </div>
        </div>
        <p class="mt-6 text-lg font-medium text-slate-600 dark:text-slate-400 animate-pulse">Initializing Salary Portal...</p>
    </div>

    <!-- Notification Toast -->
    <div id="notification-toast" class="fixed top-4 right-4 z-50 max-w-sm transition-all duration-300 transform translate-x-full"></div>

    <!-- Login Screen -->
    <div id="login-screen" class="hidden min-h-screen items-center justify-center p-4">
        <!-- Login content will be loaded here -->
    </div>

    <!-- Main App -->
    <div id="app-content" class="hidden">
        <!-- App content will be loaded here -->
    </div>

    <!-- Core Application Script -->
    <script>
        // ============================
        // FIREBASE CONFIGURATION
        // ============================
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCfltr6BuElOXV0_p07uBkDngd5fLU6c-U",
            authDomain: "salary-e8a20.firebaseapp.com",
            projectId: "salary-e8a20",
            storageBucket: "salary-e8a20.firebasestorage.app",
            messagingSenderId: "743650143598",
            appId: "1:743650143598:web:d2427c3cbf9587c460657f",
            measurementId: "G-Z006ERF0Y2"
        };

        // ============================
        // FIREBASE SERVICE
        // ============================
        class FirebaseService {
            constructor() {
                this.app = null;
                this.auth = null;
                this.db = null;
                this.analytics = null;
                this.currentUser = null;
                this.isInitialized = false;
            }

            async initialize() {
                try {
                    // Initialize Firebase
                    this.app = firebase.initializeApp(FIREBASE_CONFIG);
                    this.auth = firebase.auth();
                    this.db = firebase.firestore();
                    this.analytics = firebase.analytics();
                    
                    // Enable offline persistence
                    await this.db.enablePersistence({ synchronizeTabs: true });
                    
                    // Set up auth state listener
                    this.auth.onAuthStateChanged(async (user) => {
                        this.currentUser = user;
                        await this.handleAuthStateChange(user);
                    });
                    
                    this.isInitialized = true;
                    console.log('Firebase initialized successfully');
                    return true;
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    this.showError('Failed to initialize Firebase. Please refresh the page.');
                    return false;
                }
            }

            async handleAuthStateChange(user) {
                const ui = new UIManager();
                
                if (user) {
                    console.log('User signed in:', user.email);
                    
                    // Check if user is admin
                    const isAdmin = user.email === 'shivshreek@gmail.com';
                    
                    if (isAdmin) {
                        // Show admin dashboard directly
                        ui.showNotification('Welcome Admin', 'Loading dashboard...', 'success');
                        await new SalaryApp().showAdminDashboard();
                    } else {
                        // Check if user has an active session
                        const hasActiveSession = await this.checkActiveSession(user.uid);
                        
                        if (hasActiveSession) {
                            // User has active session, show calculator
                            ui.showNotification('Welcome Back', 'Loading your data...', 'success');
                            await new SalaryApp().showCalculator();
                        } else {
                            // New user or session expired, show OTP screen
                            await this.generateOTP(user);
                            ui.showNotification('OTP Required', 'Please enter OTP from admin', 'info');
                            await new SalaryApp().showOTPScreen(user);
                        }
                    }
                } else {
                    // No user, show login screen
                    ui.showLoginScreen();
                }
            }

            async checkActiveSession(uid) {
                try {
                    const sessionDoc = await this.db.collection('sessions').doc(uid).get();
                    if (!sessionDoc.exists) return false;
                    
                    const sessionData = sessionDoc.data();
                    const isActive = sessionData.status === 'active';
                    const isNotExpired = new Date(sessionData.expiresAt?.toDate()) > new Date();
                    
                    return isActive && isNotExpired;
                } catch (error) {
                    console.error('Session check error:', error);
                    return false;
                }
            }

            async generateOTP(user) {
                try {
                    const otp = Math.floor(100000 + Math.random() * 900000).toString();
                    const expiresAt = new Date(Date.now() + 10 * 60 * 1000); // 10 minutes
                    
                    await this.db.collection('sessions').doc(user.uid).set({
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        otp: otp,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        expiresAt: firebase.firestore.Timestamp.fromDate(expiresAt)
                    });
                    
                    console.log('OTP generated:', otp, 'for user:', user.email);
                    return otp;
                } catch (error) {
                    console.error('OTP generation error:', error);
                    throw error;
                }
            }

            async verifyOTP(uid, enteredOTP) {
                try {
                    const sessionDoc = await this.db.collection('sessions').doc(uid).get();
                    
                    if (!sessionDoc.exists) {
                        throw new Error('No OTP session found');
                    }
                    
                    const sessionData = sessionDoc.data();
                    
                    // Check if OTP is expired
                    if (new Date(sessionData.expiresAt?.toDate()) < new Date()) {
                        throw new Error('OTP has expired');
                    }
                    
                    // Verify OTP
                    if (sessionData.otp !== enteredOTP) {
                        throw new Error('Invalid OTP');
                    }
                    
                    // Update session to active
                    await this.db.collection('sessions').doc(uid).update({
                        status: 'active',
                        otpVerifiedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        expiresAt: firebase.firestore.Timestamp.fromDate(new Date(Date.now() + 24 * 60 * 60 * 1000)) // 24 hours
                    });
                    
                    return true;
                } catch (error) {
                    console.error('OTP verification error:', error);
                    throw error;
                }
            }

            async signInWithGoogle() {
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.addScope('profile');
                    provider.addScope('email');
                    
                    const result = await this.auth.signInWithPopup(provider);
                    return {
                        success: true,
                        user: result.user
                    };
                } catch (error) {
                    console.error('Google sign in error:', error);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }

            async signOut() {
                try {
                    if (this.currentUser) {
                        // Update session status
                        await this.db.collection('sessions').doc(this.currentUser.uid).update({
                            status: 'signed_out',
                            signedOutAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    await this.auth.signOut();
                    return { success: true };
                } catch (error) {
                    console.error('Sign out error:', error);
                    return { success: false, error: error.message };
                }
            }

            async savePayslip(data) {
                try {
                    if (!this.currentUser) {
                        throw new Error('User not authenticated');
                    }
                    
                    const payslipData = {
                        ...data,
                        userId: this.currentUser.uid,
                        userEmail: this.currentUser.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const docRef = await this.db.collection('payslips').add(payslipData);
                    return {
                        success: true,
                        id: docRef.id
                    };
                } catch (error) {
                    console.error('Save payslip error:', error);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }

            async getPayslipHistory(limit = 50) {
                try {
                    if (!this.currentUser) {
                        return [];
                    }
                    
                    const querySnapshot = await this.db.collection('payslips')
                        .where('userId', '==', this.currentUser.uid)
                        .orderBy('createdAt', 'desc')
                        .limit(limit)
                        .get();
                    
                    return querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                } catch (error) {
                    console.error('Get payslip history error:', error);
                    return [];
                }
            }

            async getPendingApprovals() {
                try {
                    const querySnapshot = await this.db.collection('sessions')
                        .where('status', '==', 'pending')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    return querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                } catch (error) {
                    console.error('Get pending approvals error:', error);
                    return [];
                }
            }

            async getActiveSessions() {
                try {
                    const querySnapshot = await this.db.collection('sessions')
                        .where('status', '==', 'active')
                        .orderBy('otpVerifiedAt', 'desc')
                        .get();
                    
                    return querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                } catch (error) {
                    console.error('Get active sessions error:', error);
                    return [];
                }
            }

            async approveUser(sessionId) {
                try {
                    await this.db.collection('sessions').doc(sessionId).update({
                        status: 'active',
                        approvedBy: this.currentUser.email,
                        approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        expiresAt: firebase.firestore.Timestamp.fromDate(new Date(Date.now() + 24 * 60 * 60 * 1000))
                    });
                    
                    return { success: true };
                } catch (error) {
                    console.error('Approve user error:', error);
                    return { success: false, error: error.message };
                }
            }

            async revokeAccess(sessionId) {
                try {
                    await this.db.collection('sessions').doc(sessionId).update({
                        status: 'revoked',
                        revokedBy: this.currentUser.email,
                        revokedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    return { success: true };
                } catch (error) {
                    console.error('Revoke access error:', error);
                    return { success: false, error: error.message };
                }
            }

            showError(message) {
                const ui = new UIManager();
                ui.showNotification('Firebase Error', message, 'danger');
            }
        }

        // ============================
        // UI MANAGER
        // ============================
        class UIManager {
            constructor() {
                this.firebase = new FirebaseService();
            }

            showLoading(show = true) {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.display = show ? 'flex' : 'none';
                }
            }

            showNotification(title, message, type = 'success') {
                const toast = document.getElementById('notification-toast');
                if (!toast) return;

                const typeConfig = {
                    success: { icon: 'check-circle', color: 'success' },
                    danger: { icon: 'alert-circle', color: 'danger' },
                    warning: { icon: 'alert-triangle', color: 'warning' },
                    info: { icon: 'info', color: 'primary' }
                }[type];

                toast.innerHTML = `
                    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-4 border-l-4 border-${typeConfig.color}-500">
                        <div class="flex items-start">
                            <i data-lucide="${typeConfig.icon}" class="w-6 h-6 text-${typeConfig.color}-500 mt-0.5"></i>
                            <div class="ml-3 flex-1">
                                <p class="font-semibold text-slate-900 dark:text-white">${title}</p>
                                <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">${message}</p>
                            </div>
                            <button onclick="this.parentElement.parentElement.style.transform='translateX(100%)'" 
                                    class="ml-4 text-slate-400 hover:text-slate-600">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                toast.style.transform = 'translateX(0)';
                lucide.createIcons();
                
                setTimeout(() => {
                    toast.style.transform = 'translateX(100%)';
                }, 5000);
            }

            showLoginScreen() {
                this.showLoading(false);
                
                const loginScreen = document.getElementById('login-screen');
                const appContent = document.getElementById('app-content');
                
                if (loginScreen) loginScreen.classList.remove('hidden');
                if (appContent) appContent.classList.add('hidden');
                
                this.renderLoginScreen();
            }

            renderLoginScreen() {
                const loginScreen = document.getElementById('login-screen');
                if (!loginScreen) return;

                loginScreen.innerHTML = `
                    <div class="w-full max-w-md">
                        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl overflow-hidden border border-slate-200/50 dark:border-slate-700/50">
                            <!-- Header -->
                            <div class="bg-gradient-to-r from-primary-600 to-primary-700 p-8 text-center">
                                <div class="w-20 h-20 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm border border-white/20">
                                    <i data-lucide="wallet" class="w-10 h-10 text-white"></i>
                                </div>
                                <h1 class="text-2xl font-bold text-white">Salary Portal Pro</h1>
                                <p class="text-primary-200 text-sm mt-1">Secure Access • Professional Tools</p>
                            </div>
                            
                            <!-- Login Form -->
                            <div class="p-8">
                                <div class="space-y-6">
                                    <div class="text-center">
                                        <h2 class="text-xl font-bold text-slate-800 dark:text-white">Welcome Back</h2>
                                        <p class="text-slate-600 dark:text-slate-400 mt-1">Sign in to access your salary tools</p>
                                    </div>
                                    
                                    <button onclick="window.handleGoogleLogin()" 
                                            class="w-full bg-white hover:bg-slate-50 text-slate-800 font-semibold py-3 px-4 rounded-xl transition-all duration-300 border border-slate-300 shadow-sm flex items-center justify-center gap-3">
                                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                                        <span>Continue with Google</span>
                                    </button>
                                    
                                    <div class="text-center pt-4 border-t border-slate-100 dark:border-slate-800">
                                        <p class="text-xs text-slate-500 dark:text-slate-500">
                                            © 2024 Salary Portal Pro • v2.2.0
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                lucide.createIcons();
            }

            showOTPScreen(user) {
                this.showLoading(false);
                
                const loginScreen = document.getElementById('login-screen');
                const appContent = document.getElementById('app-content');
                
                if (loginScreen) {
                    loginScreen.classList.remove('hidden');
                    loginScreen.innerHTML = `
                        <div class="w-full max-w-md">
                            <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl overflow-hidden border border-slate-200/50 dark:border-slate-700/50">
                                <!-- Header -->
                                <div class="bg-gradient-to-r from-primary-600 to-primary-700 p-8 text-center">
                                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary-100 dark:bg-primary-900/30 mb-4">
                                        <i data-lucide="shield-check" class="w-8 h-8 text-primary-600 dark:text-primary-400"></i>
                                    </div>
                                    <h2 class="text-xl font-bold text-white">Security Verification</h2>
                                    <p class="text-primary-200 text-sm mt-1">Enter the OTP provided by admin</p>
                                </div>
                                
                                <!-- OTP Form -->
                                <div class="p-8">
                                    <div class="space-y-6">
                                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 p-5 rounded-xl border border-blue-100 dark:border-blue-800">
                                            <div class="flex items-center gap-3 mb-3">
                                                <div class="flex-shrink-0">
                                                    <img src="${user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}&background=3b82f6&color=fff`}" 
                                                         class="w-12 h-12 rounded-full border-2 border-white shadow">
                                                </div>
                                                <div>
                                                    <p class="font-semibold text-slate-800 dark:text-white">${user.displayName || 'User'}</p>
                                                    <p class="text-sm text-slate-600 dark:text-slate-400">${user.email}</p>
                                                </div>
                                            </div>
                                            <p class="text-sm text-slate-700 dark:text-slate-300">
                                                <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                                                Contact <span class="font-semibold text-primary-600">admin@company.com</span> for your OTP code
                                            </p>
                                        </div>
                                        
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Enter 6-digit OTP</label>
                                                <div class="flex justify-center gap-2" id="otp-container">
                                                    ${Array.from({length: 6}).map((_, i) => `
                                                        <input type="text" maxlength="1" class="w-12 h-14 text-center text-xl font-semibold border-2 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500" 
                                                               data-index="${i}" oninput="window.handleOTPInput(this, ${i})">
                                                    `).join('')}
                                                </div>
                                            </div>
                                            
                                            <div id="otp-error" class="hidden bg-red-50 text-red-600 dark:bg-red-900/20 dark:text-red-400 p-3 rounded-lg text-sm"></div>
                                            
                                            <div class="space-y-3">
                                                <button onclick="window.handleVerifyOTP()" 
                                                        class="w-full bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-semibold py-3 rounded-xl transition-all duration-300 shadow-lg flex items-center justify-center gap-2">
                                                    <i data-lucide="shield" class="w-5 h-5"></i>
                                                    Verify & Continue
                                                </button>
                                                
                                                <button onclick="window.handleLogout()" 
                                                        class="w-full py-2.5 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-300 font-medium rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors flex items-center justify-center gap-2">
                                                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                                                    Use Different Account
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (appContent) appContent.classList.add('hidden');
                lucide.createIcons();
            }
        }

        // ============================
        // SALARY CALCULATOR
        // ============================
        class SalaryCalculator {
            constructor() {
                this.inputs = {
                    basic: 23541,
                    workingDays: 26,
                    presentDays: 25,
                    varHours: 131.24,
                    varRate: 105.00,
                    foodAllow: 3000,
                    otherEarn: 0,
                    busDed: 750
                };
            }

            calculate() {
                const basic = this.inputs.basic;
                const working = this.inputs.workingDays;
                const present = this.inputs.presentDays;
                const varHours = this.inputs.varHours;
                const varRate = this.inputs.varRate;
                const food = this.inputs.foodAllow;
                const bus = this.inputs.busDed;
                const other = this.inputs.otherEarn;

                // Calculations
                const earnedBasic = (basic / working) * present;
                const varAmt = varHours * varRate;
                const pf = earnedBasic * 0.12;
                const totalEarn = earnedBasic + varAmt + food + other;
                
                // ESI calculation
                let esi = 0;
                const structureGross = basic + food;
                if (structureGross <= 21000) {
                    esi = totalEarn * 0.0075;
                }
                
                const totalDed = pf + bus + esi;
                const net = totalEarn - totalDed;

                return {
                    earnedBasic,
                    varAmt,
                    food,
                    other,
                    pf,
                    esi,
                    bus,
                    totalEarn,
                    totalDed,
                    net,
                    working,
                    present,
                    varHours
                };
            }

            updateInput(id, value) {
                this.inputs[id] = parseFloat(value) || 0;
            }

            reset() {
                this.inputs = {
                    basic: 23541,
                    workingDays: 26,
                    presentDays: 25,
                    varHours: 131.24,
                    varRate: 105.00,
                    foodAllow: 3000,
                    otherEarn: 0,
                    busDed: 750
                };
            }
        }

        // ============================
        // MAIN APPLICATION
        // ============================
        class SalaryApp {
            constructor() {
                this.firebase = new FirebaseService();
                this.ui = new UIManager();
                this.calculator = new SalaryCalculator();
                this.currentOTP = '';
            }

            async initialize() {
                try {
                    // Initialize Firebase
                    const firebaseReady = await this.firebase.initialize();
                    if (!firebaseReady) {
                        throw new Error('Failed to initialize Firebase');
                    }
                    
                    // Initialize UI
                    this.ui.showLoading(false);
                    
                } catch (error) {
                    console.error('App initialization error:', error);
                    this.ui.showLoading(false);
                    this.ui.showNotification('Initialization Error', 'Please refresh the page', 'danger');
                }
            }

            async showCalculator() {
                this.ui.showLoading(false);
                
                const loginScreen = document.getElementById('login-screen');
                const appContent = document.getElementById('app-content');
                
                if (loginScreen) loginScreen.classList.add('hidden');
                if (appContent) {
                    appContent.classList.remove('hidden');
                    await this.renderCalculator();
                }
            }

            async showAdminDashboard() {
                this.ui.showLoading(false);
                
                const loginScreen = document.getElementById('login-screen');
                const appContent = document.getElementById('app-content');
                
                if (loginScreen) loginScreen.classList.add('hidden');
                if (appContent) {
                    appContent.classList.remove('hidden');
                    await this.renderAdminDashboard();
                }
            }

            async showOTPScreen(user) {
                this.ui.showOTPScreen(user);
                // Store the generated OTP for verification
                this.currentOTP = await this.firebase.generateOTP(user);
            }

            async renderCalculator() {
                const appContent = document.getElementById('app-content');
                if (!appContent) return;

                const results = this.calculator.calculate();
                
                appContent.innerHTML = `
                    <div class="max-w-7xl mx-auto p-4 md:p-6">
                        <!-- Navigation -->
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-3">
                                <div class="bg-gradient-to-r from-primary-500 to-primary-600 p-2 rounded-xl">
                                    <i data-lucide="wallet" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <h1 class="font-bold text-slate-800 dark:text-white text-lg">Salary Portal Pro</h1>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">Calculator</p>
                                </div>
                            </div>
                            <button onclick="window.handleLogout()" 
                                    class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg flex items-center gap-2">
                                <i data-lucide="log-out" class="w-4 h-4"></i>
                                Sign Out
                            </button>
                        </div>

                        <!-- Calculator Interface -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Input Panel -->
                            <div class="lg:col-span-1">
                                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6">
                                    <h2 class="text-xl font-bold mb-6">Salary Calculator</h2>
                                    <div class="space-y-4" id="calculator-inputs">
                                        <!-- Inputs will be added here -->
                                    </div>
                                    <div class="mt-6 space-y-3">
                                        <button onclick="window.calculateSalary()" 
                                                class="w-full py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium">
                                            Calculate
                                        </button>
                                        <button onclick="window.resetCalculator()" 
                                                class="w-full py-2.5 bg-slate-100 hover:bg-slate-200 rounded-lg font-medium">
                                            Reset
                                        </button>
                                        <button onclick="window.savePayslip()" 
                                                class="w-full py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium">
                                            Save Payslip
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Payslip Preview -->
                            <div class="lg:col-span-2">
                                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6">
                                    <div class="flex justify-between items-center mb-6">
                                        <h2 class="text-xl font-bold">Payslip Preview</h2>
                                        <div class="space-x-2">
                                            <button onclick="window.downloadPDF()" 
                                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                                                Download PDF
                                            </button>
                                            <button onclick="window.printPayslip()" 
                                                    class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg">
                                                Print
                                            </button>
                                        </div>
                                    </div>
                                    <div id="payslip-preview" class="border rounded-lg p-6">
                                        <!-- Payslip content will be rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Render calculator inputs
                this.renderCalculatorInputs();
                // Render payslip preview
                this.renderPayslipPreview(results);
                
                lucide.createIcons();
            }

            renderCalculatorInputs() {
                const container = document.getElementById('calculator-inputs');
                if (!container) return;

                const inputs = [
                    { id: 'basic', label: 'Basic Salary', value: this.calculator.inputs.basic, prefix: '₹' },
                    { id: 'workingDays', label: 'Working Days', value: this.calculator.inputs.workingDays },
                    { id: 'presentDays', label: 'Present Days', value: this.calculator.inputs.presentDays },
                    { id: 'varHours', label: 'Variable Hours', value: this.calculator.inputs.varHours, step: '0.01' },
                    { id: 'varRate', label: 'Variable Rate (₹)', value: this.calculator.inputs.varRate, step: '0.01' },
                    { id: 'foodAllow', label: 'Food Allowance', value: this.calculator.inputs.foodAllow, prefix: '₹' },
                    { id: 'otherEarn', label: 'Other Earnings', value: this.calculator.inputs.otherEarn, prefix: '₹' },
                    { id: 'busDed', label: 'Bus Deduction', value: this.calculator.inputs.busDed, prefix: '₹' }
                ];

                container.innerHTML = inputs.map(input => `
                    <div>
                        <label class="block text-sm font-medium mb-1">${input.label}</label>
                        <div class="relative">
                            ${input.prefix ? `<span class="absolute left-3 top-3 text-slate-500">${input.prefix}</span>` : ''}
                            <input type="number" 
                                   id="${input.id}" 
                                   value="${input.value}"
                                   ${input.step ? `step="${input.step}"` : ''}
                                   class="w-full ${input.prefix ? 'pl-8' : ''} px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                   oninput="window.updateCalculatorInput('${input.id}', this.value)">
                        </div>
                    </div>
                `).join('');
            }

            renderPayslipPreview(results) {
                const container = document.getElementById('payslip-preview');
                if (!container) return;

                const format = (num) => num.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                container.innerHTML = `
                    <div class="space-y-4">
                        <!-- Header -->
                        <div class="text-center border-b pb-4">
                            <h3 class="text-2xl font-bold">TECH SOLUTIONS INC.</h3>
                            <p class="text-lg">Salary Slip</p>
                            <p class="text-sm text-slate-600">September, 2025</p>
                        </div>
                        
                        <!-- Earnings -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold mb-2">EARNINGS</h4>
                                <div class="space-y-1">
                                    <div class="flex justify-between">
                                        <span>Basic Salary:</span>
                                        <span>₹${format(results.earnedBasic)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Variable Allowance:</span>
                                        <span>₹${format(results.varAmt)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Food Allowance:</span>
                                        <span>₹${format(results.food)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Other Earnings:</span>
                                        <span>₹${format(results.other)}</span>
                                    </div>
                                    <div class="flex justify-between font-bold border-t pt-1">
                                        <span>Total Earnings:</span>
                                        <span class="text-green-600">₹${format(results.totalEarn)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Deductions -->
                            <div>
                                <h4 class="font-semibold mb-2">DEDUCTIONS</h4>
                                <div class="space-y-1">
                                    <div class="flex justify-between">
                                        <span>Provident Fund (PF):</span>
                                        <span>₹${format(results.pf)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>ESI Contribution:</span>
                                        <span>₹${format(results.esi)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Bus Deduction:</span>
                                        <span>₹${format(results.bus)}</span>
                                    </div>
                                    <div class="flex justify-between font-bold border-t pt-1">
                                        <span>Total Deductions:</span>
                                        <span class="text-red-600">₹${format(results.totalDed)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Net Pay -->
                        <div class="bg-slate-100 dark:bg-slate-800 p-4 rounded-lg text-center">
                            <p class="text-sm text-slate-600">Net Payable Amount</p>
                            <p class="text-3xl font-bold text-green-600">₹${format(results.net)}</p>
                            <p class="text-sm text-slate-500 mt-2">${this.numberToWords(results.net)}</p>
                        </div>
                    </div>
                `;
            }

            numberToWords(num) {
                // Simplified number to words function
                if (num === 0) return "Zero Rupees Only";
                return "Amount in words";
            }

            async savePayslip() {
                try {
                    const results = this.calculator.calculate();
                    const payslipData = {
                        basic: this.calculator.inputs.basic,
                        workingDays: this.calculator.inputs.workingDays,
                        presentDays: this.calculator.inputs.presentDays,
                        varHours: this.calculator.inputs.varHours,
                        varRate: this.calculator.inputs.varRate,
                        foodAllow: this.calculator.inputs.foodAllow,
                        otherEarn: this.calculator.inputs.otherEarn,
                        busDed: this.calculator.inputs.busDed,
                        results: results,
                        month: 'September',
                        year: '2025',
                        netPay: `₹${results.net.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
                    };

                    const result = await this.firebase.savePayslip(payslipData);
                    
                    if (result.success) {
                        this.ui.showNotification('Success', 'Payslip saved successfully');
                    } else {
                        this.ui.showNotification('Error', result.error, 'danger');
                    }
                } catch (error) {
                    this.ui.showNotification('Error', 'Failed to save payslip', 'danger');
                }
            }

            async verifyOTP(enteredOTP) {
                try {
                    if (!this.firebase.currentUser) {
                        throw new Error('No user found');
                    }

                    const isValid = await this.firebase.verifyOTP(this.firebase.currentUser.uid, enteredOTP);
                    
                    if (isValid) {
                        this.ui.showNotification('Success', 'OTP verified successfully');
                        await this.showCalculator();
                    } else {
                        throw new Error('Invalid OTP');
                    }
                } catch (error) {
                    this.ui.showNotification('Error', error.message, 'danger');
                }
            }
        }

        // ============================
        // GLOBAL FUNCTIONS
        // ============================
        let salaryApp;

        window.handleGoogleLogin = async () => {
            if (!salaryApp) salaryApp = new SalaryApp();
            
            const googleBtn = document.querySelector('[onclick*="handleGoogleLogin"]');
            if (googleBtn) {
                googleBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> Connecting...';
                googleBtn.disabled = true;
            }

            const result = await salaryApp.firebase.signInWithGoogle();
            
            if (result.success) {
                // Auth state listener will handle the rest
            } else {
                salaryApp.ui.showNotification('Login Failed', result.error, 'danger');
                if (googleBtn) {
                    googleBtn.innerHTML = '<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Continue with Google';
                    googleBtn.disabled = false;
                }
            }
        };

        window.handleVerifyOTP = async () => {
            if (!salaryApp) return;

            const inputs = document.querySelectorAll('#otp-container input');
            const otp = Array.from(inputs).map(input => input.value).join('');
            
            if (otp.length !== 6) {
                const errorDiv = document.getElementById('otp-error');
                if (errorDiv) {
                    errorDiv.textContent = 'Please enter all 6 digits';
                    errorDiv.classList.remove('hidden');
                }
                return;
            }

            await salaryApp.verifyOTP(otp);
        };

        window.handleOTPInput = (input, index) => {
            const value = input.value;
            
            if (value.length === 1 && index < 5) {
                const nextInput = document.querySelector(`#otp-container input[data-index="${index + 1}"]`);
                if (nextInput) nextInput.focus();
            }

            // Auto-verify when all digits entered
            const inputs = document.querySelectorAll('#otp-container input');
            const otp = Array.from(inputs).map(input => input.value).join('');
            
            if (otp.length === 6) {
                setTimeout(() => window.handleVerifyOTP(), 300);
            }
        };

        window.handleLogout = async () => {
            if (!salaryApp) return;
            
            if (confirm('Are you sure you want to sign out?')) {
                await salaryApp.firebase.signOut();
                salaryApp.ui.showLoginScreen();
            }
        };

        window.updateCalculatorInput = (id, value) => {
            if (!salaryApp) return;
            salaryApp.calculator.updateInput(id, value);
        };

        window.calculateSalary = () => {
            if (!salaryApp) return;
            const results = salaryApp.calculator.calculate();
            salaryApp.renderPayslipPreview(results);
        };

        window.resetCalculator = () => {
            if (!salaryApp) return;
            salaryApp.calculator.reset();
            salaryApp.renderCalculatorInputs();
            const results = salaryApp.calculator.calculate();
            salaryApp.renderPayslipPreview(results);
            salaryApp.ui.showNotification('Reset', 'Calculator reset to default values', 'info');
        };

        window.savePayslip = () => {
            if (!salaryApp) return;
            salaryApp.savePayslip();
        };

        window.downloadPDF = () => {
            // PDF download implementation
            salaryApp.ui.showNotification('Info', 'PDF download feature', 'info');
        };

        window.printPayslip = () => {
            // Print implementation
            salaryApp.ui.showNotification('Info', 'Print feature', 'info');
        };

        // ============================
        // INITIALIZATION
        // ============================
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Lucide icons
            lucide.createIcons();
            
            // Create and initialize the app
            salaryApp = new SalaryApp();
            await salaryApp.initialize();
        });

        // Error handling
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            const ui = new UIManager();
            ui.showNotification('Error', 'An unexpected error occurred', 'danger');
        });
    </script>
</body>
</html>
