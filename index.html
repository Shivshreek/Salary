<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Portal Pro | Secure Access</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
                        success: { 50: '#f0fdf4', 500: '#22c55e', 600: '#16a34a' },
                        warning: { 50: '#fefce8', 500: '#f59e0b', 600: '#d97706' },
                        danger: { 50: '#fef2f2', 500: '#ef4444', 600: '#dc2626' }
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .dark .glass {
            background: rgba(30, 41, 59, 0.7);
        }
        
        .input-focus {
            transition: all 0.2s;
            border: 2px solid #e2e8f0;
        }
        .input-focus:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .dark .input-focus {
            border-color: #475569;
            background: #1e293b;
        }
        
        .btn-pop {
            transition: all 0.2s ease;
        }
        .btn-pop:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        
        @media print {
            body * { visibility: hidden; }
            #payslip-container, #payslip-container * { 
                visibility: visible; 
                color: black !important;
            }
            #payslip-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white !important;
            }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 dark:from-slate-900 dark:to-slate-800 min-h-screen text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <!-- LOADING SCREEN -->
    <div id="loading-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white dark:bg-slate-900">
        <div class="relative">
            <div class="w-20 h-20 border-4 border-primary-100 dark:border-slate-700 border-t-primary-600 dark:border-t-primary-500 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i data-lucide="wallet" class="w-8 h-8 text-primary-600 dark:text-primary-400"></i>
            </div>
        </div>
        <p class="mt-6 text-lg font-medium text-slate-600 dark:text-slate-400 animate-pulse">Initializing Portal...</p>
    </div>

    <!-- NOTIFICATION TOAST -->
    <div id="notification-toast" class="fixed top-4 right-4 z-50 max-w-sm transition-all duration-500 transform translate-x-full">
        <div class="glass rounded-xl shadow-2xl p-4 border-l-4 border-success-500">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i data-lucide="check-circle" class="w-6 h-6 text-success-500"></i>
                </div>
                <div class="ml-3">
                    <p id="notification-title" class="font-semibold"></p>
                    <p id="notification-message" class="text-sm text-slate-600 dark:text-slate-400 mt-1"></p>
                </div>
                <button onclick="hideNotification()" class="ml-4 text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="hidden min-h-screen flex items-center justify-center p-4 fade-in">
        <div class="w-full max-w-md">
            <div class="glass rounded-3xl shadow-2xl overflow-hidden border border-slate-200/50 dark:border-slate-700/50">
                <!-- Header -->
                <div class="bg-gradient-to-r from-primary-600 to-primary-700 p-8 text-center">
                    <div class="w-20 h-20 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm border border-white/20">
                        <i data-lucide="shield" class="w-10 h-10 text-white"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-white">Salary Portal Pro</h1>
                    <p class="text-primary-200 text-sm mt-1">Secure Employee Portal</p>
                </div>
                
                <!-- Login Form -->
                <div class="p-8">
                    <div id="login-form" class="space-y-6">
                        <div class="text-center">
                            <h2 class="text-xl font-bold text-slate-800 dark:text-white">Secure Login</h2>
                            <p class="text-slate-600 dark:text-slate-400 mt-1">Use your credentials to access</p>
                        </div>
                        
                        <button onclick="handleGoogleLogin()" id="google-btn" 
                                class="w-full btn-pop bg-white hover:bg-slate-50 text-slate-800 font-semibold py-3 px-4 rounded-xl border border-slate-300 shadow-sm flex items-center justify-center gap-3">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                            <span>Continue with Google</span>
                        </button>
                        
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <input type="checkbox" id="remember-me" class="w-4 h-4 text-primary-600 rounded focus:ring-primary-500 border-slate-300">
                                    <label for="remember-me" class="ml-2 text-sm text-slate-700 dark:text-slate-300">Remember me</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="dark-mode-toggle" class="w-4 h-4 text-primary-600 rounded focus:ring-primary-500 border-slate-300" onchange="toggleDarkMode()">
                                    <label for="dark-mode-toggle" class="ml-2 text-sm text-slate-700 dark:text-slate-300">Dark mode</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center pt-4 border-t border-slate-100 dark:border-slate-800">
                            <p class="text-xs text-slate-500 dark:text-slate-500">
                                Need help? Contact <span class="text-primary-600 font-medium">admin@company.com</span>
                            </p>
                        </div>
                    </div>

                    <!-- OTP Form -->
                    <div id="otp-form" class="hidden space-y-6">
                        <div class="text-center">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary-100 dark:bg-primary-900/30 mb-4">
                                <i data-lucide="shield-check" class="w-8 h-8 text-primary-600 dark:text-primary-400"></i>
                            </div>
                            <h2 class="text-xl font-bold text-slate-800 dark:text-white">Verification Required</h2>
                            <p class="text-slate-600 dark:text-slate-400 mt-1">Enter 6-digit OTP from admin</p>
                        </div>
                        
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 p-5 rounded-xl border border-blue-100 dark:border-blue-800">
                            <div class="flex items-center gap-3 mb-3">
                                <img id="user-avatar-otp" src="" class="w-12 h-12 rounded-full border-2 border-white shadow">
                                <div>
                                    <p id="user-name-otp" class="font-semibold text-slate-800 dark:text-white"></p>
                                    <p id="user-email-otp" class="text-sm text-slate-600 dark:text-slate-400"></p>
                                </div>
                            </div>
                            <p class="text-sm text-slate-700 dark:text-slate-300">
                                <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                                Contact admin at <span class="font-semibold text-primary-600">admin@company.com</span> for OTP
                            </p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Enter 6-digit OTP</label>
                                <div class="flex justify-center gap-2" id="otp-container">
                                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-xl border-2 border-slate-300 rounded-lg focus:border-primary-500 outline-none" data-index="0" oninput="moveToNext(this)">
                                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-xl border-2 border-slate-300 rounded-lg focus:border-primary-500 outline-none" data-index="1" oninput="moveToNext(this)">
                                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-xl border-2 border-slate-300 rounded-lg focus:border-primary-500 outline-none" data-index="2" oninput="moveToNext(this)">
                                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-xl border-2 border-slate-300 rounded-lg focus:border-primary-500 outline-none" data-index="3" oninput="moveToNext(this)">
                                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-xl border-2 border-slate-300 rounded-lg focus:border-primary-500 outline-none" data-index="4" oninput="moveToNext(this)">
                                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-xl border-2 border-slate-300 rounded-lg focus:border-primary-500 outline-none" data-index="5" oninput="moveToNext(this)">
                                </div>
                                <input type="hidden" id="otp-combined">
                            </div>
                            
                            <div id="otp-error" class="hidden bg-danger-50 text-danger-600 dark:bg-danger-900/20 dark:text-danger-400 p-3 rounded-lg text-sm"></div>
                            
                            <div class="space-y-3">
                                <button onclick="verifyOTP()" id="verify-btn"
                                        class="w-full btn-pop bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-semibold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2">
                                    <i data-lucide="shield" class="w-5 h-5"></i>
                                    Verify & Continue
                                </button>
                                
                                <button onclick="resetLogin()" 
                                        class="w-full py-2.5 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-300 font-medium rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors flex items-center justify-center gap-2">
                                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                                    Back to Login
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-center pt-4 border-t border-slate-100 dark:border-slate-800">
                            <p class="text-xs text-slate-500 dark:text-slate-500">
                                Test OTP: <span class="font-mono font-bold">000000</span> • OTP expires in 10 minutes
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-6">
                <p class="text-sm text-slate-500 dark:text-slate-500">
                    © 2024 Salary Portal Pro • v2.0
                </p>
            </div>
        </div>
    </div>

    <!-- EMPLOYEE DETAILS FORM -->
    <div id="employee-details-form" class="hidden min-h-screen flex items-center justify-center p-4 fade-in">
        <div class="w-full max-w-2xl">
            <div class="glass rounded-3xl shadow-2xl overflow-hidden border border-slate-200/50 dark:border-slate-700/50">
                <div class="bg-gradient-to-r from-primary-600 to-primary-700 p-6 text-center relative">
                    <div class="relative flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center backdrop-blur-sm border border-white/20">
                                <i data-lucide="user" class="w-6 h-6 text-white"></i>
                            </div>
                            <div class="text-left">
                                <h2 class="text-xl font-bold text-white">Employee Details</h2>
                                <p id="welcome-msg" class="text-primary-200 text-sm">Complete your profile</p>
                            </div>
                        </div>
                        <button onclick="goBackToLogin()" class="text-white/80 hover:text-white p-2 rounded-lg hover:bg-white/10 transition-colors">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <form id="employee-form" class="space-y-6">
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Employee Code *</label>
                                    <input type="text" id="emp-code" class="input-focus w-full px-4 py-3 rounded-xl" value="6138" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Employee Name *</label>
                                    <input type="text" id="emp-name" class="input-focus w-full px-4 py-3 rounded-xl" value="Shivshree Kumar" required>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Father/Husband Name *</label>
                                    <input type="text" id="father-name" class="input-focus w-full px-4 py-3 rounded-xl" value="Santosh Kumar" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Designation</label>
                                    <input type="text" id="designation" class="input-focus w-full px-4 py-3 rounded-xl" value="Senior Executive">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Department *</label>
                                    <select id="department" class="input-focus w-full px-4 py-3 rounded-xl" required>
                                        <option value="Production" selected>Production</option>
                                        <option value="IT">IT</option>
                                        <option value="HR">HR</option>
                                        <option value="Finance">Finance</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Date of Joining *</label>
                                    <input type="date" id="doj" class="input-focus w-full px-4 py-3 rounded-xl" value="2025-05-15" required>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Salary Month *</label>
                                    <select id="salary-month" class="input-focus w-full px-4 py-3 rounded-xl" required>
                                        <option value="September" selected>September</option>
                                        <option value="October">October</option>
                                        <option value="November">November</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Salary Year *</label>
                                    <select id="salary-year" class="input-focus w-full px-4 py-3 rounded-xl" required>
                                        <option value="2025" selected>2025</option>
                                        <option value="2026">2026</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pt-6 flex justify-between items-center border-t border-slate-200 dark:border-slate-700">
                            <button type="button" onclick="goBackToLogin()" 
                                    class="px-5 py-2.5 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-300 font-medium rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors flex items-center gap-2">
                                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                                Back to Login
                            </button>
                            <button type="submit" 
                                    class="btn-pop bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-semibold px-6 py-2.5 rounded-xl shadow-lg flex items-center gap-2">
                                Continue to Portal
                                <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="app-content" class="hidden p-4 md:p-6 fade-in">
        <div class="max-w-7xl mx-auto space-y-6">
            
            <!-- Top Navigation -->
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="glass rounded-2xl p-3 border border-slate-200/50 dark:border-slate-700/50">
                        <div class="flex items-center gap-3">
                            <div class="bg-gradient-to-r from-primary-500 to-primary-600 p-2 rounded-xl">
                                <i data-lucide="wallet" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h1 class="font-bold text-slate-800 dark:text-white text-lg">Salary Portal Pro</h1>
                                <p id="current-user-info" class="text-xs text-slate-500 dark:text-slate-400">Signed in as User</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="admin-badge" class="hidden">
                        <div class="glass rounded-full px-3 py-1.5 border border-purple-200 dark:border-purple-800">
                            <span class="text-xs font-semibold text-purple-700 dark:text-purple-300 flex items-center gap-1">
                                <i data-lucide="shield-check" class="w-3 h-3"></i>
                                ADMIN
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="toggleDarkMode()" class="glass btn-pop p-3 rounded-xl border border-slate-200/50 dark:border-slate-700/50 hover:bg-white/50 dark:hover:bg-slate-800/50 transition-all duration-300 group">
                        <i data-lucide="moon" class="w-5 h-5 text-slate-600 dark:hidden group-hover:text-primary-600"></i>
                        <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-yellow-400"></i>
                    </button>
                    
                    <div class="relative group">
                        <button class="glass btn-pop flex items-center gap-3 p-3 rounded-xl border border-slate-200/50 dark:border-slate-700/50 hover:bg-white/50 dark:hover:bg-slate-800/50 transition-all duration-300">
                            <img id="user-avatar-nav" src="" class="w-8 h-8 rounded-full border-2 border-white shadow">
                            <div class="text-left">
                                <p id="user-name-nav" class="text-sm font-semibold text-slate-800 dark:text-white">User</p>
                                <p id="user-role-nav" class="text-xs text-slate-500 dark:text-slate-400">Employee</p>
                            </div>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                        </button>
                        
                        <div class="absolute right-0 top-full mt-2 w-48 glass rounded-xl shadow-2xl border border-slate-200/50 dark:border-slate-700/50 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform translate-y-2 group-hover:translate-y-0 z-50">
                            <div class="p-2">
                                <div class="p-3 border-b border-slate-200/50 dark:border-slate-700/50">
                                    <p class="text-sm font-medium text-slate-800 dark:text-white">Signed in as</p>
                                    <p id="user-email-nav" class="text-xs text-slate-500 dark:text-slate-400 truncate">loading...</p>
                                </div>
                                <button onclick="handleLogout()" class="w-full text-left px-3 py-2.5 text-sm text-danger-600 hover:bg-danger-50 dark:hover:bg-danger-900/20 rounded-lg flex items-center gap-2">
                                    <i data-lucide="log-out" class="w-4 h-4"></i>
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ADMIN DASHBOARD -->
            <div id="admin-dashboard" class="hidden space-y-6">
                <div class="glass rounded-3xl p-6 border border-slate-200/50 dark:border-slate-700/50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-3 rounded-2xl">
                                <i data-lucide="shield-check" class="w-8 h-8 text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-slate-800 dark:text-white">Admin Dashboard</h2>
                                <p class="text-slate-600 dark:text-slate-400">Manage user access and OTPs</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass rounded-3xl p-6 border border-slate-200/50 dark:border-slate-700/50">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="bg-gradient-to-r from-green-500 to-green-600 p-2 rounded-xl">
                                    <i data-lucide="key-round" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-slate-800 dark:text-white">Generate OTP</h3>
                                    <p class="text-sm text-slate-600 dark:text-slate-400">Create OTP for new users</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-5">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">User Email</label>
                                    <input type="email" id="user-email-input" class="input-focus w-full px-4 py-3 rounded-xl" placeholder="employee@company.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">User Name</label>
                                    <input type="text" id="user-name-input" class="input-focus w-full px-4 py-3 rounded-xl" placeholder="John Doe">
                                </div>
                            </div>
                            
                            <button onclick="generateUserOTP()" 
                                    class="w-full btn-pop bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-3.5 rounded-xl shadow-lg flex items-center justify-center gap-3">
                                <i data-lucide="key" class="w-5 h-5"></i>
                                Generate OTP
                            </button>
                            
                            <div id="otp-result" class="hidden space-y-4 p-5 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-2xl border border-green-200 dark:border-green-800">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="check-circle" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
                                        <h4 class="font-bold text-green-800 dark:text-green-300">OTP Generated!</h4>
                                    </div>
                                    <button onclick="copyOTP()" class="text-sm bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-3 py-1.5 rounded-lg flex items-center gap-2">
                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                        Copy
                                    </button>
                                </div>
                                
                                <div class="space-y-3">
                                    <p class="text-sm text-green-700 dark:text-green-300">Share this OTP:</p>
                                    <div class="flex items-center justify-between gap-4">
                                        <div class="flex-1 bg-white dark:bg-slate-800 p-4 rounded-xl border-2 border-green-300 dark:border-green-700">
                                            <p class="text-3xl font-mono font-bold text-center text-green-700 dark:text-green-300 tracking-widest" id="generated-otp"></p>
                                        </div>
                                    </div>
                                    <p class="text-xs text-green-600 dark:text-green-400 text-center">
                                        <i data-lucide="clock" class="w-3 h-3 inline mr-1"></i>
                                        Valid for 10 minutes
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="glass rounded-3xl p-6 border border-slate-200/50 dark:border-slate-700/50">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="bg-gradient-to-r from-warning-500 to-warning-600 p-2 rounded-xl">
                                    <i data-lucide="clock" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-slate-800 dark:text-white">Pending Approvals</h3>
                                    <p class="text-sm text-slate-600 dark:text-slate-400">Users waiting for verification</p>
                                </div>
                            </div>
                            <div id="pending-badge" class="notification-badge hidden">0</div>
                        </div>
                        
                        <div id="pending-users-list" class="space-y-4 max-h-[300px] overflow-y-auto pr-2">
                            <div class="text-center py-8">
                                <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-slate-100 dark:bg-slate-800 mb-3">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-slate-400"></i>
                                </div>
                                <p class="text-slate-500 dark:text-slate-500">No pending approvals</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CALCULATOR INTERFACE -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-4 space-y-6">
                    <div class="glass rounded-3xl p-6 border border-slate-200/50 dark:border-slate-700/50">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="bg-gradient-to-r from-primary-500 to-primary-600 p-2 rounded-xl">
                                    <i data-lucide="calculator" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-slate-800 dark:text-white">Salary Calculator</h3>
                                    <p class="text-sm text-slate-600 dark:text-slate-400">Adjust values as needed</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="savePayslip()" id="save-btn" 
                                        class="glass btn-pop text-sm bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white px-4 py-2 rounded-xl flex items-center gap-2">
                                    <i data-lucide="save" class="w-4 h-4"></i>
                                    Save
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-5">
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Basic Salary</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-slate-500">₹</span>
                                    <input type="number" id="basic" value="23541" oninput="calculate()" 
                                           class="input-focus w-full pl-8 pr-4 py-3 rounded-xl">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400">Working Days</label>
                                    <input type="number" id="workingDays" value="26" oninput="calculate()" 
                                           class="input-focus w-full px-4 py-3 rounded-xl">
                                </div>
                                <div class="space-y-2">
                                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400">Present Days</label>
                                    <input type="number" id="presentDays" value="25" oninput="calculate()" 
                                           class="input-focus w-full px-4 py-3 rounded-xl">
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Variable Allowance</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Hours</label>
                                        <input type="number" id="varHours" value="131.24" step="0.01" oninput="calculate()" 
                                               class="input-focus w-full px-4 py-3 rounded-xl">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Rate (₹)</label>
                                        <input type="number" id="varRate" value="105.00" step="0.01" oninput="calculate()" 
                                               class="input-focus w-full px-4 py-3 rounded-xl">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Food Allowance</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-slate-500">₹</span>
                                    <input type="number" id="foodAllow" value="3000" oninput="calculate()" 
                                           class="input-focus w-full pl-8 pr-4 py-3 rounded-xl">
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Bus Deduction</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-danger-500">-</span>
                                    <input type="number" id="busDed" value="750" oninput="calculate()" 
                                           class="input-focus w-full pl-8 pr-4 py-3 rounded-xl border-danger-200 dark:border-danger-800 bg-danger-50/50 dark:bg-danger-900/10">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 pt-4">
                                <button onclick="resetCalculator()" 
                                        class="glass py-3 text-sm text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-300 border border-slate-200/50 dark:border-slate-700/50 rounded-xl hover:bg-white/50 dark:hover:bg-slate-800/50 transition-colors flex items-center justify-center gap-2">
                                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                    Reset
                                </button>
                                <button onclick="calculate()" 
                                        class="btn-pop bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-semibold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    Recalculate
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass rounded-3xl p-5 border border-slate-200/50 dark:border-slate-700/50">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="trending-up" class="w-5 h-5 text-green-500"></i>
                            <h4 class="font-semibold text-slate-800 dark:text-white">Quick Summary</h4>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-slate-600 dark:text-slate-400">Total Earnings</span>
                                <span class="font-semibold text-slate-800 dark:text-white" id="quick-earnings">₹39,415.78</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-slate-600 dark:text-slate-400">Total Deductions</span>
                                <span class="font-semibold text-slate-800 dark:text-white" id="quick-deductions">₹3,466.27</span>
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t border-slate-200 dark:border-slate-700">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Net Pay</span>
                                <span class="text-lg font-bold text-green-600 dark:text-green-400" id="quick-net">₹35,949.51</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8">
                    <div class="glass rounded-3xl p-6 md:p-8 border border-slate-200/50 dark:border-slate-700/50">
                        <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Salary Slip</h2>
                                <p id="slip-month-display" class="text-slate-600 dark:text-slate-400">September 2025</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="downloadPDF()" 
                                        class="glass btn-pop px-5 py-2.5 text-slate-800 dark:text-white font-semibold rounded-xl border border-slate-200/50 dark:border-slate-700/50 hover:bg-white/50 dark:hover:bg-slate-800/50 transition-all duration-300 flex items-center gap-2">
                                    <i data-lucide="download" class="w-5 h-5"></i>
                                    Download PDF
                                </button>
                                <button onclick="printPayslip()" 
                                        class="glass btn-pop px-5 py-2.5 text-slate-800 dark:text-white font-semibold rounded-xl border border-slate-200/50 dark:border-slate-700/50 hover:bg-white/50 dark:hover:bg-slate-800/50 transition-all duration-300 flex items-center gap-2">
                                    <i data-lucide="printer" class="w-5 h-5"></i>
                                    Print
                                </button>
                            </div>
                        </div>
                        
                        <div id="payslip-container" class="bg-white rounded-3xl shadow-2xl overflow-hidden border-2 border-slate-800">
                            <div class="bg-gradient-to-r from-primary-600 to-primary-700 text-white text-center py-6 px-4">
                                <h1 class="text-2xl font-bold uppercase tracking-wider" id="slipCompanyName">TECH SOLUTIONS INC.</h1>
                                <p class="text-lg opacity-90 mt-1">Salary Slip</p>
                                <p class="text-sm opacity-80 mt-1" id="slipMonthYear">September, 2025</p>
                                <p class="text-xs opacity-70 mt-2">123 Business Park, Delhi, India</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 border-b border-slate-300">
                                <div class="p-4 border-r border-slate-300 space-y-2">
                                    <div class="flex"><span class="w-32 text-slate-600">Emp Code:</span> <span class="font-semibold" id="slipEmpCode">6138</span></div>
                                    <div class="flex"><span class="w-32 text-slate-600">Emp Name:</span> <span class="font-semibold" id="slipEmpName">Shivshree Kumar</span></div>
                                    <div class="flex"><span class="w-32 text-slate-600">F/H Name:</span> <span class="font-semibold" id="slipFatherName">Santosh Kumar</span></div>
                                </div>
                                <div class="p-4 space-y-2">
                                    <div class="flex"><span class="w-32 text-slate-600">Department:</span> <span class="font-semibold" id="slipDepartment">Production</span></div>
                                    <div class="flex"><span class="w-32 text-slate-600">Designation:</span> <span class="font-semibold" id="slipDesignation">Senior Executive</span></div>
                                    <div class="flex"><span class="w-32 text-slate-600">D.O.J.:</span> <span class="font-semibold" id="slipDOJ">2025-05-15</span></div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 border-b border-slate-300 text-center">
                                <div class="p-3 border-r border-slate-300">
                                    <div class="text-xs text-slate-500 uppercase tracking-wider">Working Days</div>
                                    <div class="text-xl font-bold" id="slipWorkingDays">26</div>
                                </div>
                                <div class="p-3 border-r border-slate-300">
                                    <div class="text-xs text-slate-500 uppercase tracking-wider">Present Days</div>
                                    <div class="text-xl font-bold" id="slipPresentDays">25</div>
                                </div>
                                <div class="p-3">
                                    <div class="text-xs text-slate-500 uppercase tracking-wider">Variable Hours</div>
                                    <div class="text-xl font-bold"><span id="slipVarHours">131.24</span> Hr</div>
                                </div>
                            </div>
                            
                            <div class="p-4">
                                <table class="w-full">
                                    <thead>
                                        <tr class="bg-slate-100">
                                            <th class="text-left p-3 text-sm font-semibold text-slate-700">EARNINGS</th>
                                            <th class="text-right p-3 text-sm font-semibold text-slate-700">AMOUNT (₹)</th>
                                            <th class="text-left p-3 text-sm font-semibold text-slate-700">DEDUCTIONS</th>
                                            <th class="text-right p-3 text-sm font-semibold text-slate-700">AMOUNT (₹)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="border-b border-slate-200">
                                            <td class="p-3">Basic Salary</td>
                                            <td class="p-3 text-right font-semibold" id="slipPayableBasic">22,635.58</td>
                                            <td class="p-3">Provident Fund (PF)</td>
                                            <td class="p-3 text-right font-semibold" id="slipPF">2,716.27</td>
                                        </tr>
                                        <tr class="border-b border-slate-200">
                                            <td class="p-3">Variable Allowance</td>
                                            <td class="p-3 text-right" id="slipVarAmt">13,780.20</td>
                                            <td class="p-3">ESI Contribution</td>
                                            <td class="p-3 text-right" id="slipESI">0.00</td>
                                        </tr>
                                        <tr class="border-b border-slate-200">
                                            <td class="p-3">Food Allowance</td>
                                            <td class="p-3 text-right" id="slipPayableFood">3,000.00</td>
                                            <td class="p-3">Bus Deduction</td>
                                            <td class="p-3 text-right font-semibold" id="slipBus">750.00</td>
                                        </tr>
                                        <tr class="bg-slate-50 font-bold">
                                            <td class="p-3">Total Earnings</td>
                                            <td class="p-3 text-right text-green-700" id="slipTotalEarnings">39,415.78</td>
                                            <td class="p-3">Total Deductions</td>
                                            <td class="p-3 text-right text-red-700" id="slipTotalDeductions">3,466.27</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="bg-gradient-to-r from-slate-800 to-slate-900 text-white p-6 text-center">
                                <div class="mb-2">
                                    <div class="text-sm opacity-80">Net Payable Amount</div>
                                    <div class="text-3xl font-bold mt-1" id="slipNetPay">₹ 35,949.51</div>
                                </div>
                                <div class="text-sm opacity-90 italic border-t border-white/20 pt-3 mt-3">
                                    In Words: <span id="slipAmountWords" class="font-medium">Thirty Five Thousand Nine Hundred Forty Nine Rupees Fifty One Paise Only</span>
                                </div>
                            </div>
                            
                            <div class="p-4 text-center text-xs text-slate-500 bg-slate-50">
                                <p>This is a computer generated salary slip and does not require a signature.</p>
                                <p class="mt-1">Generated on <span id="generation-date"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center pt-8 border-t border-slate-200/50 dark:border-slate-700/50">
                <p class="text-sm text-slate-500 dark:text-slate-500">
                    © 2024 Salary Portal Pro • Secure Employee Portal • v2.0
                </p>
                <p class="text-xs text-slate-400 dark:text-slate-600 mt-1">
                    Protected • Professional • Reliable
                </p>
            </div>
        </div>
    </div>

    <!-- Firebase & Core Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, serverTimestamp, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCfltr6BuElOXV0_p07uBkDngd5fLU6c-U",
            authDomain: "salary-e8a20.firebaseapp.com",
            projectId: "salary-e8a20",
            storageBucket: "salary-e8a20.firebasestorage.app",
            messagingSenderId: "743650143598",
            appId: "1:743650143598:web:d2427c3cbf9587c460657f",
            measurementId: "G-Z006ERF0Y2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // App State
        let currentUser = null;
        let currentRole = 'user';
        let currentSessionId = null;
        let sessionUnsub = null;
        let pendingUnsub = null;
        const ADMIN_EMAIL = "shivshreek@gmail.com";

        // Global Functions
        window.handleGoogleLogin = handleGoogleLogin;
        window.verifyOTP = verifyOTP;
        window.resetLogin = resetLogin;
        window.moveToNext = moveToNext;
        window.goBackToLogin = goBackToLogin;
        window.handleLogout = handleLogout;
        window.generateUserOTP = generateUserOTP;
        window.copyOTP = copyOTP;
        window.toggleDarkMode = toggleDarkMode;
        window.calculate = calculate;
        window.resetCalculator = resetCalculator;
        window.savePayslip = savePayslip;
        window.downloadPDF = downloadPDF;
        window.printPayslip = printPayslip;

        // Initialize
        onAuthStateChanged(auth, (user) => {
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
                
                if (user) {
                    currentUser = user;
                    currentRole = user.email.toLowerCase() === ADMIN_EMAIL ? 'admin' : 'user';
                    
                    // Check for existing session
                    currentSessionId = localStorage.getItem('session_id');
                    if (currentSessionId) {
                        attachSessionListener(currentSessionId);
                    } else {
                        createNewSession(user);
                    }
                } else {
                    switchScreen('login-screen');
                }
            }, 1000);
        });

        // Session Management
        async function createNewSession(user) {
            const sessionData = {
                uid: user.uid,
                email: user.email,
                displayName: user.displayName,
                photoURL: user.photoURL,
                role: currentRole,
                status: currentRole === 'admin' ? 'active' : 'pending',
                otp: currentRole === 'admin' ? null : Math.floor(100000 + Math.random() * 900000).toString(),
                device: navigator.userAgent,
                loginTime: serverTimestamp(),
                expiresAt: new Date(Date.now() + 10 * 60 * 1000) // 10 minutes
            };

            try {
                const ref = await addDoc(collection(db, 'sessions'), sessionData);
                currentSessionId = ref.id;
                localStorage.setItem('session_id', currentSessionId);
                attachSessionListener(currentSessionId);
                
                if (currentRole === 'user') {
                    showNotification('Pending Approval', 'Please contact admin for OTP');
                }
            } catch (error) {
                console.error('Session creation error:', error);
                showNotification('Session Error', 'Please try again', 'error');
            }
        }

        function attachSessionListener(sid) {
            if (sessionUnsub) sessionUnsub();
            
            sessionUnsub = onSnapshot(doc(db, 'sessions', sid), (snap) => {
                if (!snap.exists()) {
                    handleLogout();
                    return;
                }

                const data = snap.data();
                switch(data.status) {
                    case 'active':
                        initializeAppUI(data);
                        break;
                    case 'pending':
                        showOTPForm(data);
                        break;
                    case 'kicked':
                    case 'inactive':
                        handleLogout();
                        break;
                }
            }, (error) => {
                console.error('Session listener error:', error);
                handleLogout();
            });
        }

        // Authentication
        async function handleGoogleLogin() {
            try {
                const btn = document.getElementById('google-btn');
                btn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> Connecting...';
                btn.disabled = true;
                
                await setPersistence(auth, browserLocalPersistence);
                const result = await signInWithPopup(auth, provider);
                
                // Role detection happens in onAuthStateChanged
                showNotification('Authentication Successful', 'Checking access permissions...');
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Login Failed', error.message, 'error');
                
                const btn = document.getElementById('google-btn');
                btn.innerHTML = '<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Continue with Google';
                btn.disabled = false;
            }
        }

        // OTP Handling
        function showOTPForm(data) {
            switchScreen('login-screen');
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('otp-form').classList.remove('hidden');
            
            window.currentOTP = data.otp;
            document.getElementById('user-name-otp').textContent = data.displayName || 'User';
            document.getElementById('user-email-otp').textContent = data.email;
            document.getElementById('user-avatar-otp').src = data.photoURL || `https://ui-avatars.com/api/?name=${data.displayName}&background=3b82f6&color=fff`;
            
            // Clear OTP inputs
            document.querySelectorAll('.otp-input').forEach(input => input.value = '');
        }

        async function verifyOTP() {
            const inputs = document.querySelectorAll('.otp-input');
            let enteredOTP = '';
            inputs.forEach(input => enteredOTP += input.value);
            
            const verifyBtn = document.getElementById('verify-btn');
            verifyBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> Verifying...';
            verifyBtn.disabled = true;
            
            if (enteredOTP === window.currentOTP || enteredOTP === '000000') {
                try {
                    await updateDoc(doc(db, 'sessions', currentSessionId), {
                        status: 'active',
                        otp: null,
                        otpVerifiedAt: serverTimestamp()
                    });
                    showNotification('Verified Successfully', 'Welcome to Salary Portal');
                } catch (error) {
                    showNotification('Verification Failed', error.message, 'error');
                    verifyBtn.innerHTML = '<i data-lucide="shield" class="w-5 h-5"></i> Verify & Continue';
                    verifyBtn.disabled = false;
                }
            } else {
                showOTPError('Invalid OTP. Please try again.');
                verifyBtn.innerHTML = '<i data-lucide="shield" class="w-5 h-5"></i> Verify & Continue';
                verifyBtn.disabled = false;
                
                document.getElementById('otp-container').classList.add('shake');
                setTimeout(() => {
                    document.getElementById('otp-container').classList.remove('shake');
                }, 500);
            }
        }

        function moveToNext(input) {
            const value = input.value;
            const index = parseInt(input.dataset.index);
            
            if (value.length === 1 && index < 5) {
                document.querySelector(`.otp-input[data-index="${index + 1}"]`).focus();
            }
            
            let combined = '';
            document.querySelectorAll('.otp-input').forEach(i => {
                combined += i.value;
            });
            
            if (combined.length === 6) {
                setTimeout(verifyOTP, 300);
            }
        }

        function resetLogin() {
            document.getElementById('otp-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.querySelectorAll('.otp-input').forEach(input => input.value = '');
        }

        // UI Initialization
        function initializeAppUI(userData) {
            // Update navigation
            document.getElementById('user-avatar-nav').src = userData.photoURL || `https://ui-avatars.com/api/?name=${userData.displayName}&background=3b82f6&color=fff`;
            document.getElementById('user-name-nav').textContent = userData.displayName;
            document.getElementById('user-email-nav').textContent = userData.email;
            document.getElementById('user-role-nav').textContent = userData.role === 'admin' ? 'Administrator' : 'Employee';
            document.getElementById('current-user-info').textContent = `Signed in as ${userData.email}`;
            
            // Show admin dashboard if admin
            if (userData.role === 'admin') {
                document.getElementById('admin-dashboard').classList.remove('hidden');
                document.getElementById('admin-badge').classList.remove('hidden');
                initializeAdminListeners();
            }
            
            // Show employee details form first
            switchScreen('employee-details-form');
            
            // Set welcome message
            document.getElementById('welcome-msg').textContent = `Welcome back, ${userData.displayName}`;
        }

        // Form Submission
        document.getElementById('employee-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            // Transfer form data to payslip
            document.getElementById('slipEmpCode').textContent = document.getElementById('emp-code').value;
            document.getElementById('slipEmpName').textContent = document.getElementById('emp-name').value;
            document.getElementById('slipFatherName').textContent = document.getElementById('father-name').value;
            document.getElementById('slipDesignation').textContent = document.getElementById('designation').value;
            document.getElementById('slipDepartment').textContent = document.getElementById('department').value;
            document.getElementById('slipDOJ').textContent = document.getElementById('doj').value;
            
            const month = document.getElementById('salary-month').value;
            const year = document.getElementById('salary-year').value;
            document.getElementById('slipMonthYear').textContent = `${month}, ${year}`;
            document.getElementById('slip-month-display').textContent = `${month} ${year}`;
            
            switchScreen('app-content');
            calculate(); // Initial calculation
        });

        // Admin Functions
        function initializeAdminListeners() {
            // Listen for pending users
            const pendingQuery = query(collection(db, 'sessions'), 
                where('status', '==', 'pending'),
                orderBy('loginTime', 'desc'));
            
            if (pendingUnsub) pendingUnsub();
            pendingUnsub = onSnapshot(pendingQuery, updatePendingList);
        }

        function updatePendingList(snapshot) {
            const pendingList = document.getElementById('pending-users-list');
            let pendingCount = 0;
            
            if (snapshot.empty) {
                pendingList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-slate-100 dark:bg-slate-800 mb-3">
                            <i data-lucide="check-circle" class="w-6 h-6 text-slate-400"></i>
                        </div>
                        <p class="text-slate-500 dark:text-slate-500">No pending approvals</p>
                    </div>
                `;
            } else {
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    pendingCount++;
                    
                    html += `
                        <div class="glass p-4 rounded-xl border border-warning-200 dark:border-warning-800">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <img src="${data.photoURL || 'https://ui-avatars.com/api/?name=' + (data.displayName || 'User')}" 
                                         class="w-10 h-10 rounded-full border-2 border-white shadow">
                                    <div>
                                        <p class="font-semibold text-slate-800 dark:text-white">${data.displayName || 'User'}</p>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">${data.email}</p>
                                    </div>
                                </div>
                                <span class="text-xs px-2 py-1 rounded bg-warning-100 text-warning-700 dark:bg-warning-900/30 dark:text-warning-400">
                                    Pending
                                </span>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="bg-warning-50 dark:bg-warning-900/20 p-3 rounded-lg">
                                    <p class="text-sm font-medium text-warning-700 dark:text-warning-300">Generated OTP</p>
                                    <p class="text-2xl font-mono font-bold text-center text-warning-700 dark:text-warning-300">${data.otp || 'N/A'}</p>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button onclick="approveUser('${doc.id}')" 
                                            class="flex-1 btn-pop bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-2 rounded-lg flex items-center justify-center gap-2">
                                        <i data-lucide="check" class="w-4 h-4"></i>
                                        Approve
                                    </button>
                                    <button onclick="rejectUser('${doc.id}')" 
                                            class="flex-1 btn-pop bg-gradient-to-r from-danger-600 to-danger-700 hover:from-danger-700 hover:to-danger-800 text-white font-semibold py-2 rounded-lg flex items-center justify-center gap-2">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                        Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                pendingList.innerHTML = html;
            }
            
            // Update badge
            const badge = document.getElementById('pending-badge');
            badge.textContent = pendingCount;
            badge.classList.toggle('hidden', pendingCount === 0);
        }

        window.approveUser = async (sessionId) => {
            if (confirm('Approve this user for access?')) {
                await updateDoc(doc(db, 'sessions', sessionId), {
                    status: 'active',
                    otp: null,
                    approvedBy: currentUser.email,
                    approvedAt: serverTimestamp()
                });
                showNotification('User Approved', 'User can now access the portal');
            }
        };

        window.rejectUser = async (sessionId) => {
            if (confirm('Reject this user?')) {
                await updateDoc(doc(db, 'sessions', sessionId), { status: 'kicked' });
                showNotification('User Rejected', 'User session has been terminated');
            }
        };

        async function generateUserOTP() {
            const userEmail = document.getElementById('user-email-input').value.trim();
            const userName = document.getElementById('user-name-input').value.trim();
            
            if (!userEmail || !userName) {
                showNotification('Please enter both email and name', 'Both fields are required', 'warning');
                return;
            }
            
            const otp = Math.floor(100000 + Math.random() * 900000).toString();
            
            try {
                const sessionData = {
                    uid: 'admin_gen_' + Date.now(),
                    email: userEmail,
                    displayName: userName,
                    photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=3b82f6&color=fff`,
                    role: 'user',
                    status: 'pending',
                    otp: otp,
                    device: 'Admin Generated',
                    loginTime: serverTimestamp(),
                    generatedBy: currentUser.email
                };
                
                await addDoc(collection(db, 'sessions'), sessionData);
                
                // Show OTP result
                document.getElementById('otp-result').classList.remove('hidden');
                document.getElementById('generated-otp').textContent = otp;
                
                // Clear inputs
                document.getElementById('user-email-input').value = '';
                document.getElementById('user-name-input').value = '';
                
                showNotification('OTP Generated', `OTP for ${userName} is ready to share`);
                
            } catch (error) {
                console.error('OTP generation error:', error);
                showNotification('Generation Failed', error.message, 'error');
            }
        }

        function copyOTP() {
            const otpText = document.getElementById('generated-otp').textContent;
            navigator.clipboard.writeText(otpText).then(() => {
                showNotification('Copied!', 'OTP copied to clipboard');
            });
        }

        // Logout
        async function handleLogout() {
            if (confirm('Are you sure you want to sign out?')) {
                if (currentSessionId) {
                    try {
                        await updateDoc(doc(db, 'sessions', currentSessionId), { status: 'inactive' });
                    } catch (error) {
                        console.error('Session update error:', error);
                    }
                }
                
                if (sessionUnsub) sessionUnsub();
                if (pendingUnsub) pendingUnsub();
                
                localStorage.removeItem('session_id');
                await signOut(auth);
                location.reload();
            }
        }

        // Helper Functions
        function switchScreen(screenId) {
            const screens = ['login-screen', 'employee-details-form', 'app-content'];
            screens.forEach(id => {
                const el = document.getElementById(id);
                if (id === screenId) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
            lucide.createIcons();
        }

        function showOTPError(message) {
            const errorDiv = document.getElementById('otp-error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function showNotification(title, message, type = 'success') {
            const toast = document.getElementById('notification-toast');
            const titleEl = document.getElementById('notification-title');
            const messageEl = document.getElementById('notification-message');
            const icon = toast.querySelector('i');
            
            let borderColor = 'border-success-500';
            let iconName = 'check-circle';
            
            if (type === 'error') {
                borderColor = 'border-danger-500';
                iconName = 'alert-circle';
            } else if (type === 'warning') {
                borderColor = 'border-warning-500';
                iconName = 'alert-triangle';
            }
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            icon.setAttribute('data-lucide', iconName);
            toast.className = `fixed top-4 right-4 z-50 max-w-sm transition-all duration-500 transform ${borderColor} rounded-xl shadow-2xl p-4 border-l-4`;
            
            toast.classList.remove('translate-x-full');
            lucide.createIcons();
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 5000);
        }

        function hideNotification() {
            const toast = document.getElementById('notification-toast');
            toast.classList.add('translate-x-full');
        }

        // Initialize icons
        lucide.createIcons();
    </script>

    <!-- Calculator Logic -->
    <script>
        // Initialize icons and date
        lucide.createIcons();
        document.getElementById('generation-date').textContent = new Date().toLocaleDateString('en-IN', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Dark mode toggle
        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
            document.getElementById('dark-mode-toggle').checked = isDark;
        }

        // Initialize dark mode
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark');
            document.getElementById('dark-mode-toggle').checked = true;
        }

        // Number to words conversion
        function numberToWords(num) {
            if (num === 0) return "Zero Rupees Only";
            
            const units = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine"];
            const teens = ["Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
            const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];
            
            function convertTwoDigits(n) {
                if (n === 0) return "";
                if (n < 10) return units[n];
                if (n < 20) return teens[n - 10];
                return tens[Math.floor(n / 10)] + (n % 10 !== 0 ? " " + units[n % 10] : "");
            }

            function convertThreeDigits(n) {
                let str = "";
                if (n > 99) {
                    str += units[Math.floor(n / 100)] + " Hundred ";
                    n %= 100;
                }
                str += convertTwoDigits(n);
                return str.trim();
            }

            let integerPart = Math.floor(num);
            let decimalPart = Math.round((num - integerPart) * 100);
            let words = "";
            
            // Convert integer part
            if (integerPart >= 10000000) {
                words += convertThreeDigits(Math.floor(integerPart / 10000000)) + " Crore ";
                integerPart %= 10000000;
            }
            if (integerPart >= 100000) {
                words += convertThreeDigits(Math.floor(integerPart / 100000)) + " Lakh ";
                integerPart %= 100000;
            }
            if (integerPart >= 1000) {
                words += convertThreeDigits(Math.floor(integerPart / 1000)) + " Thousand ";
                integerPart %= 1000;
            }
            words += convertThreeDigits(integerPart);
            
            // Add currency
            if (words.trim() === "") {
                words = "Zero";
            }
            
            words = words.trim() + " Rupees";
            
            // Add paise if any
            if (decimalPart > 0) {
                words += " " + convertTwoDigits(decimalPart) + " Paise";
            }
            
            return words + " Only";
        }

        // Format number with Indian formatting
        function formatNum(n) {
            return n.toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Main calculation function
        function calculate() {
            const basic = parseFloat(document.getElementById('basic').value) || 0;
            const working = parseFloat(document.getElementById('workingDays').value) || 26;
            const present = parseFloat(document.getElementById('presentDays').value) || 25;
            const varHours = parseFloat(document.getElementById('varHours').value) || 0;
            const varRate = parseFloat(document.getElementById('varRate').value) || 0;
            const food = parseFloat(document.getElementById('foodAllow').value) || 0;
            const bus = parseFloat(document.getElementById('busDed').value) || 0;

            // Calculations based on the provided payslip
            let earnedBasic = (basic / working) * present;
            let varAmt = varHours * varRate;
            let totalEarn = earnedBasic + varAmt + food;
            
            // PF calculation (12% of earned basic)
            let pf = earnedBasic * 0.12;
            
            // ESI calculation (0.75% of total earnings if structure <= 21000)
            let esi = 0;
            let structureGross = basic + food;
            if (structureGross <= 21000) {
                esi = totalEarn * 0.0075;
            }
            
            let totalDed = pf + bus + esi;
            let net = totalEarn - totalDed;

            // Update payslip display
            document.getElementById('slipPayableBasic').textContent = formatNum(earnedBasic);
            document.getElementById('slipVarAmt').textContent = formatNum(varAmt);
            document.getElementById('slipPayableFood').textContent = formatNum(food);
            document.getElementById('slipPF').textContent = formatNum(pf);
            document.getElementById('slipESI').textContent = formatNum(esi);
            document.getElementById('slipBus').textContent = formatNum(bus);
            document.getElementById('slipTotalEarnings').textContent = formatNum(totalEarn);
            document.getElementById('slipTotalDeductions').textContent = formatNum(totalDed);
            document.getElementById('slipNetPay').textContent = "₹ " + formatNum(net);
            document.getElementById('slipAmountWords').textContent = numberToWords(net);
            
            document.getElementById('slipWorkingDays').textContent = working;
            document.getElementById('slipPresentDays').textContent = present;
            document.getElementById('slipVarHours').textContent = varHours.toFixed(2);

            // Update quick stats
            document.getElementById('quick-earnings').textContent = `₹${formatNum(totalEarn)}`;
            document.getElementById('quick-deductions').textContent = `₹${formatNum(totalDed)}`;
            document.getElementById('quick-net').textContent = `₹${formatNum(net)}`;
        }

        function resetCalculator() {
            // Reset to original values from the payslip image
            document.getElementById('basic').value = 23541;
            document.getElementById('workingDays').value = 26;
            document.getElementById('presentDays').value = 25;
            document.getElementById('varHours').value = 131.24;
            document.getElementById('varRate').value = 105.00;
            document.getElementById('foodAllow').value = 3000;
            document.getElementById('busDed').value = 750;
            calculate();
            showNotification('Reset Complete', 'All values restored to original payslip data');
        }

        async function savePayslip() {
            const btn = document.getElementById('save-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Saving...';
            btn.disabled = true;
            
            // Simulate save
            setTimeout(() => {
                showNotification('Saved Successfully', 'Payslip added to your history');
                btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> Saved!';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    lucide.createIcons();
                }, 2000);
            }, 1000);
        }

        // PDF Generation
        function downloadPDF() {
            const element = document.getElementById('payslip-container');
            const opt = {
                margin: 0.5,
                filename: `Salary_Slip_${document.getElementById('slipMonthYear').textContent.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                },
                jsPDF: { 
                    unit: 'in', 
                    format: 'letter', 
                    orientation: 'portrait' 
                }
            };
            
            html2pdf().set(opt).from(element).save();
            showNotification('PDF Downloaded', 'Salary slip saved to your device');
        }

        function printPayslip() {
            const element = document.getElementById('payslip-container');
            const originalContent = document.body.innerHTML;
            const printContent = element.outerHTML;
            
            document.body.innerHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Print Salary Slip</title>
                    <style>
                        body { margin: 0; padding: 20px; background: white !important; }
                        @page { size: auto; margin: 0mm; }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 100);
                        }
                    <\/script>
                </body>
                </html>
            `;
            
            window.print();
            setTimeout(() => {
                document.body.innerHTML = originalContent;
                lucide.createIcons();
                calculate();
            }, 500);
        }

        // Initialize calculator
        calculate();

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl + R to reset
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                resetCalculator();
            }
            // Ctrl + P to print
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                printPayslip();
            }
            // Ctrl + D for dark mode
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                toggleDarkMode();
            }
        });

        // Auto-calculate on input changes
        document.querySelectorAll('#basic, #workingDays, #presentDays, #varHours, #varRate, #foodAllow, #busDed').forEach(input => {
            input.addEventListener('input', calculate);
        });
    </script>
</body>
</html>
