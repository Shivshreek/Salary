<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Slip Management System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            createUserWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            collection, 
            query, 
            where, 
            onSnapshot,
            getDocs,
            deleteDoc,
            addDoc,
            orderBy,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // Your Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCfltr6BuElOXV0_p07uBkDngd5fLU6c-U",
            authDomain: "salary-e8a20.firebaseapp.com",
            projectId: "salary-e8a20",
            storageBucket: "salary-e8a20.firebasestorage.app",
            messagingSenderId: "743650143598",
            appId: "1:743650143598:web:d2427c3cbf9587c460657f",
            measurementId: "G-Z006ERF0Y2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        const ADMIN_EMAIL = 'shivshreek@gmail.com';
        let currentUser = null;
        let currentRole = 'employee';
        let userSessionListener = null;
        let adminUsersListener = null;
        let salaryHistoryListener = null;
        let currentTheme = 'light';
        let currentSalaryData = null;
        let currentCalculations = null;

        // Initialize theme from localStorage
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            currentTheme = savedTheme;
            
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-toggle-icon').setAttribute('name', 'sun');
                document.getElementById('theme-toggle-text').textContent = 'Light Mode';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('theme-toggle-icon').setAttribute('name', 'moon');
                document.getElementById('theme-toggle-text').textContent = 'Dark Mode';
            }
        }

        // Toggle theme
        window.toggleTheme = function() {
            if (currentTheme === 'light') {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                currentTheme = 'dark';
                document.getElementById('theme-toggle-icon').setAttribute('name', 'sun');
                document.getElementById('theme-toggle-text').textContent = 'Light Mode';
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                currentTheme = 'light';
                document.getElementById('theme-toggle-icon').setAttribute('name', 'moon');
                document.getElementById('theme-toggle-text').textContent = 'Dark Mode';
            }
        };

        // Screen management
        function switchScreen(screenName) {
            // Hide all screens first
            const screens = ['login-screen', 'app-content', 'loading-screen', 'otp-screen', 'admin-dashboard', 'salary-history-modal', 'add-user-modal', 'user-management'];
            screens.forEach(screen => {
                const element = document.getElementById(screen);
                if (element) element.classList.add('hidden');
            });
            
            // Show requested screen
            const targetScreen = document.getElementById(screenName);
            if (targetScreen) targetScreen.classList.remove('hidden');
            
            // Special handling for logout
            if (screenName === 'login-screen') {
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) logoutBtn.classList.add('hidden');
            }
        }

        // Initialize admin dashboard
        async function initAdminDashboard() {
            const pendingUsersList = document.getElementById('pending-users-list');
            const activeUsersList = document.getElementById('active-users-list');
            const allUsersList = document.getElementById('all-users-list');
            
            // Clear existing listeners
            if (adminUsersListener) {
                adminUsersListener();
            }
            
            // Listen for all users
            adminUsersListener = onSnapshot(
                collection(db, 'users'),
                (snapshot) => {
                    pendingUsersList.innerHTML = '';
                    activeUsersList.innerHTML = '';
                    allUsersList.innerHTML = '';
                    
                    let totalUsers = 0;
                    let pendingUsers = 0;
                    let activeUsers = 0;
                    
                    snapshot.docs.forEach(doc => {
                        const userData = doc.data();
                        const listItem = createUserListItem(doc.id, userData);
                        const allUsersItem = createAllUserListItem(doc.id, userData);
                        
                        if (userData.status === 'pending_otp') {
                            pendingUsersList.appendChild(listItem);
                            pendingUsers++;
                        } else if (userData.status === 'active') {
                            activeUsersList.appendChild(listItem);
                            activeUsers++;
                        }
                        
                        allUsersList.appendChild(allUsersItem);
                        totalUsers++;
                    });
                    
                    // Update counters
                    document.getElementById('total-users').textContent = totalUsers;
                    document.getElementById('pending-count').textContent = pendingUsers;
                    document.getElementById('active-count').textContent = activeUsers;
                    document.getElementById('pending-actions').textContent = pendingUsers;
                    
                    // Show empty state if no users
                    if (pendingUsers === 0) {
                        pendingUsersList.innerHTML = '<li class="text-center text-gray-500 dark:text-gray-400 py-8">No pending approvals</li>';
                    }
                    if (activeUsers === 0) {
                        activeUsersList.innerHTML = '<li class="text-center text-gray-500 dark:text-gray-400 py-8">No active users</li>';
                    }
                    if (totalUsers === 0) {
                        allUsersList.innerHTML = '<li class="text-center text-gray-500 dark:text-gray-400 py-8">No users found</li>';
                    }
                }
            );
            
            // Add admin badge
            document.getElementById('admin-badge').classList.remove('hidden');
        }

        // Create user list item for admin
        function createUserListItem(userId, userData) {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-700';
            
            li.innerHTML = `
                <div class="flex-1">
                    <div class="font-semibold text-gray-800 dark:text-gray-200">${userData.email}</div>
                    <div class="text-sm ${userData.status === 'pending_otp' ? 'text-yellow-600' : 'text-green-600'}">
                        Status: ${userData.status === 'pending_otp' ? 'Pending Approval' : 'Active'}
                    </div>
                    ${userData.monthlySalary ? `<div class="text-sm text-gray-600 dark:text-gray-400">Salary: ₹${userData.monthlySalary}</div>` : ''}
                    ${userData.employeeName ? `<div class="text-sm text-gray-600 dark:text-gray-400">Name: ${userData.employeeName}</div>` : ''}
                </div>
                <div class="flex gap-2 ml-4">
                    ${userData.status === 'pending_otp' ? 
                        `<button onclick="approveUser('${userId}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded transition">
                            Approve
                        </button>` : ''
                    }
                    <button onclick="deleteUser('${userId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded transition">
                        Delete
                    </button>
                </div>
            `;
            
            return li;
        }

        // Create all users list item
        function createAllUserListItem(userId, userData) {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow dark:shadow-gray-700 mb-2';
            
            li.innerHTML = `
                <div class="flex-1">
                    <div class="font-semibold text-gray-800 dark:text-gray-200">${userData.email}</div>
                    <div class="flex items-center gap-3 mt-1">
                        <span class="text-sm px-2 py-1 rounded ${userData.status === 'active' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-300' : 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-300'}">
                            ${userData.status === 'active' ? 'Active' : 'Pending'}
                        </span>
                        ${userData.role === 'admin' ? 
                            '<span class="text-sm bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-300 px-2 py-1 rounded">Admin</span>' : ''
                        }
                    </div>
                    ${userData.employeeName ? `<div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Name: ${userData.employeeName}</div>` : ''}
                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                        Last Login: ${userData.lastLogin ? new Date(userData.lastLogin).toLocaleDateString() : 'Never'}
                    </div>
                </div>
                <div class="flex gap-2 ml-4">
                    ${userData.status === 'pending_otp' ? 
                        `<button onclick="approveUser('${userId}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded transition">
                            Approve
                        </button>` : ''
                    }
                    <button onclick="deleteUser('${userId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded transition">
                        Delete
                    </button>
                    ${userData.role !== 'admin' ? 
                        `<button onclick="makeAdmin('${userId}')" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded transition">
                            Make Admin
                        </button>` : ''
                    }
                </div>
            `;
            
            return li;
        }

        // Admin functions (exposed globally)
        window.approveUser = async function(userId) {
            try {
                await updateDoc(doc(db, 'users', userId), {
                    status: 'active',
                    lastUpdated: new Date().toISOString()
                });
                
                // Show success message
                showNotification('User approved successfully!', 'success');
            } catch (error) {
                console.error('Error approving user:', error);
                showNotification('Error approving user', 'error');
            }
        };

        window.makeAdmin = async function(userId) {
            if (confirm('Are you sure you want to make this user an admin?')) {
                try {
                    await updateDoc(doc(db, 'users', userId), {
                        role: 'admin',
                        lastUpdated: new Date().toISOString()
                    });
                    
                    showNotification('User promoted to admin successfully!', 'success');
                } catch (error) {
                    console.error('Error making user admin:', error);
                    showNotification('Error making user admin', 'error');
                }
            }
        };

        window.deleteUser = async function(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    await deleteDoc(doc(db, 'users', userId));
                    showNotification('User deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting user:', error);
                    showNotification('Error deleting user', 'error');
                }
            }
        };

        // Show add user modal
        window.showAddUserModal = function() {
            document.getElementById('add-user-modal').classList.remove('hidden');
        };

        // Close add user modal
        window.closeAddUserModal = function() {
            document.getElementById('add-user-modal').classList.add('hidden');
            document.getElementById('add-user-form').reset();
            document.getElementById('add-user-error').classList.add('hidden');
        };

        // Add new user
        window.addNewUser = async function(event) {
            event.preventDefault();
            
            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-password').value;
            const name = document.getElementById('new-user-name').value;
            const salary = document.getElementById('new-user-salary').value;
            const errorDiv = document.getElementById('add-user-error');
            
            // Validate email
            if (!email || !password || !name) {
                errorDiv.textContent = 'Please fill all required fields';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                // Show loading
                const addBtn = document.getElementById('add-user-btn');
                const originalText = addBtn.innerHTML;
                addBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Adding...';
                addBtn.disabled = true;
                
                // Create user in Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const newUser = userCredential.user;
                
                // Save user data to Firestore
                await setDoc(doc(db, 'users', newUser.uid), {
                    email: email,
                    employeeName: name,
                    monthlySalary: salary ? parseFloat(salary) : 0,
                    status: 'active',
                    role: 'employee',
                    createdBy: currentUser.email,
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                });
                
                // Reset form and close modal
                document.getElementById('add-user-form').reset();
                addBtn.innerHTML = originalText;
                addBtn.disabled = false;
                closeAddUserModal();
                
                showNotification(`User ${email} added successfully!`, 'success');
                
            } catch (error) {
                console.error('Error adding user:', error);
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                
                // Reset button
                const addBtn = document.getElementById('add-user-btn');
                addBtn.innerHTML = '<i data-lucide="user-plus"></i> Add User';
                addBtn.disabled = false;
            }
        };

        // Show user management
        window.showUserManagement = function() {
            switchScreen('user-management');
        };

        // Back to admin dashboard
        window.backToAdminDashboard = function() {
            switchScreen('admin-dashboard');
        };

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 
                          type === 'error' ? 'bg-red-500' : 
                          'bg-blue-500';
            
            notification.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg fixed top-4 right-4 z-50 transform transition-transform duration-300 translate-x-full`;
            notification.id = 'temp-notification';
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info'}" class="w-5 h-5"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
                notification.classList.add('translate-x-0');
            }, 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.remove('translate-x-0');
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
            
            // Reinitialize icons
            lucide.createIcons();
        }

        // Login function - Fixed credentials
        window.handleLogin = async function(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginError = document.getElementById('login-error');
            
            try {
                // Show loading
                switchScreen('loading-screen');
                
                // Special handling for admin login
                if (email === ADMIN_EMAIL) {
                    // Try to sign in with provided password
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    currentUser = userCredential.user;
                    
                    // Ensure admin user exists in Firestore
                    await setDoc(doc(db, 'users', currentUser.uid), {
                        email: email,
                        status: 'active',
                        role: 'admin',
                        lastLogin: new Date().toISOString(),
                        employeeName: 'System Administrator'
                    }, { merge: true });
                    
                    // Show admin dashboard
                    switchScreen('admin-dashboard');
                    initAdminDashboard();
                    showNotification('Welcome Admin!', 'success');
                    return;
                }
                
                // For other users, try to login
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                
                // Check user status in Firestore
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                
                if (!userDoc.exists()) {
                    // First time login - create active session
                    await setDoc(doc(db, 'users', currentUser.uid), {
                        email: email,
                        status: 'active',
                        role: 'employee',
                        lastLogin: new Date().toISOString(),
                        createdAt: new Date().toISOString()
                    });
                    
                    // Show app content
                    switchScreen('app-content');
                    await loadUserSalaryData();
                    showNotification('Welcome! Account created successfully.', 'success');
                } else {
                    const userData = userDoc.data();
                    
                    if (userData.status === 'active') {
                        // Update last login
                        await updateDoc(doc(db, 'users', currentUser.uid), {
                            lastLogin: new Date().toISOString()
                        });
                        
                        // Show app content
                        switchScreen('app-content');
                        await loadUserSalaryData();
                        showNotification('Welcome back!', 'success');
                    } else if (userData.status === 'pending_otp') {
                        // Pending approval - show OTP screen
                        switchScreen('otp-screen');
                    }
                }
                
            } catch (error) {
                console.error('Login error:', error);
                
                // Special case: If user doesn't exist, create with default password
                if (error.code === 'auth/user-not-found') {
                    try {
                        // Create new user
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        currentUser = userCredential.user;
                        
                        // Add to Firestore
                        await setDoc(doc(db, 'users', currentUser.uid), {
                            email: email,
                            status: 'active',
                            role: 'employee',
                            lastLogin: new Date().toISOString(),
                            createdAt: new Date().toISOString(),
                            employeeName: email.split('@')[0] // Use email prefix as name
                        });
                        
                        // Show app content
                        switchScreen('app-content');
                        await loadUserSalaryData();
                        showNotification('New account created successfully!', 'success');
                        return;
                    } catch (createError) {
                        error = createError;
                    }
                }
                
                loginError.textContent = error.message;
                loginError.classList.remove('hidden');
                switchScreen('login-screen');
                showNotification('Login failed. Please check credentials.', 'error');
            }
        };

        // OTP verification function
        window.verifyOTP = async function() {
            const otp = document.getElementById('otp-input').value;
            const otpError = document.getElementById('otp-error');
            
            if (otp.length !== 6) {
                otpError.textContent = 'Please enter a valid 6-digit OTP';
                otpError.classList.remove('hidden');
                return;
            }
            
            try {
                // In a real app, you would verify the OTP with Firebase Auth or your backend
                // For demo, we'll just approve if OTP is 123456
                if (otp === '123456') {
                    await updateDoc(doc(db, 'users', currentUser.uid), {
                        status: 'active',
                        lastUpdated: new Date().toISOString(),
                        lastLogin: new Date().toISOString()
                    });
                    
                    // Show app content
                    switchScreen('app-content');
                    await loadUserSalaryData();
                    showNotification('OTP verified successfully!', 'success');
                } else {
                    otpError.textContent = 'Invalid OTP. Try 123456 for demo.';
                    otpError.classList.remove('hidden');
                    showNotification('Invalid OTP. Please try again.', 'error');
                }
            } catch (error) {
                console.error('OTP verification error:', error);
                otpError.textContent = error.message;
                otpError.classList.remove('hidden');
                showNotification('OTP verification failed', 'error');
            }
        };

        // Load user salary data
        async function loadUserSalaryData() {
            try {
                // Fetch user data
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const userData = userDoc.data();
                
                // Set user email and name
                document.getElementById('user-email').textContent = userData.email;
                document.getElementById('user-name').textContent = userData.employeeName || userData.email.split('@')[0];
                
                // Load salary history
                await loadSalaryHistory();
                
                // Generate current month salary slip
                await generateCurrentSalarySlip(userData);
                
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Generate current month salary slip
        async function generateCurrentSalarySlip(userData) {
            const salaryData = {
                employeeName: userData.employeeName || "John Doe",
                employeeId: userData.employeeId || "EMP001",
                designation: userData.designation || "Software Engineer",
                department: userData.department || "Engineering",
                bankAccount: userData.bankAccount || "XXXXXX1234",
                panNumber: userData.panNumber || "ABCDE1234F",
                payPeriod: new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
                paidDays: 31,
                lossOfPayDays: 0,
                
                // Earnings (use user's monthly salary if available)
                basic: userData.monthlySalary ? Math.round(userData.monthlySalary * 0.5) : 30000,
                hra: userData.monthlySalary ? Math.round(userData.monthlySalary * 0.4) : 12000,
                conveyanceAllowance: 1600,
                medicalAllowance: 1250,
                specialAllowance: userData.monthlySalary ? Math.round(userData.monthlySalary * 0.1) : 15350,
                overtime: 2000,
                bonus: 5000,
                
                // Deductions
                professionalTax: 200,
                tds: 1500,
                loanRecovery: 1000
            };
            
            // Adjust to match monthly salary if provided
            if (userData.monthlySalary) {
                const totalEarnings = salaryData.basic + salaryData.hra + salaryData.conveyanceAllowance + 
                                    salaryData.medicalAllowance + salaryData.specialAllowance;
                const difference = userData.monthlySalary - totalEarnings;
                if (difference > 0) {
                    salaryData.specialAllowance += difference;
                }
            }
            
            // Store current salary data globally
            currentSalaryData = salaryData;
            
            // Calculate and display
            updateSalaryDisplay(salaryData);
        }

        // Update salary display
        function updateSalaryDisplay(salaryData) {
            // Store current data
            currentSalaryData = salaryData;
            
            // Calculations
            const totalEarnings = salaryData.basic + salaryData.hra + salaryData.conveyanceAllowance + 
                                salaryData.medicalAllowance + salaryData.specialAllowance + 
                                salaryData.overtime + salaryData.bonus;
            
            // PF Calculation (12% of Basic)
            const pf = Math.round(salaryData.basic * 0.12);
            
            // ESI Calculation (0.75% of Gross if Gross <= 21000)
            let esi = 0;
            if (totalEarnings <= 21000) {
                esi = Math.round(totalEarnings * 0.0075);
            }
            
            const totalDeductions = salaryData.professionalTax + salaryData.tds + 
                                  salaryData.loanRecovery + pf + esi;
            
            const netPay = totalEarnings - totalDeductions;
            
            // Store calculations
            currentCalculations = {
                totalEarnings,
                pf,
                esi,
                totalDeductions,
                netPay
            };
            
            // Display data
            document.getElementById('employee-name').textContent = salaryData.employeeName;
            document.getElementById('employee-id').textContent = salaryData.employeeId;
            document.getElementById('designation').textContent = salaryData.designation;
            document.getElementById('department').textContent = salaryData.department;
            document.getElementById('bank-account').textContent = salaryData.bankAccount;
            document.getElementById('pan-number').textContent = salaryData.panNumber;
            document.getElementById('pay-period').textContent = salaryData.payPeriod;
            document.getElementById('paid-days').textContent = salaryData.paidDays;
            document.getElementById('lop-days').textContent = salaryData.lossOfPayDays;
            
            // Earnings table
            document.getElementById('basic-amount').textContent = salaryData.basic.toLocaleString();
            document.getElementById('hra-amount').textContent = salaryData.hra.toLocaleString();
            document.getElementById('conveyance-amount').textContent = salaryData.conveyanceAllowance.toLocaleString();
            document.getElementById('medical-amount').textContent = salaryData.medicalAllowance.toLocaleString();
            document.getElementById('special-amount').textContent = salaryData.specialAllowance.toLocaleString();
            document.getElementById('overtime-amount').textContent = salaryData.overtime.toLocaleString();
            document.getElementById('bonus-amount').textContent = salaryData.bonus.toLocaleString();
            document.getElementById('total-earnings').textContent = totalEarnings.toLocaleString();
            
            // Deductions table
            document.getElementById('pf-amount').textContent = pf.toLocaleString();
            document.getElementById('esi-amount').textContent = esi.toLocaleString();
            document.getElementById('pt-amount').textContent = salaryData.professionalTax.toLocaleString();
            document.getElementById('tds-amount').textContent = salaryData.tds.toLocaleString();
            document.getElementById('loan-amount').textContent = salaryData.loanRecovery.toLocaleString();
            document.getElementById('total-deductions').textContent = totalDeductions.toLocaleString();
            
            // Net pay
            document.getElementById('net-pay').textContent = `₹${netPay.toLocaleString()}`;
            document.getElementById('net-pay-words').textContent = numberToWords(netPay);
            
            // Update WhatsApp message
            updateWhatsAppMessage(salaryData.payPeriod, netPay);
        }

        // Save salary slip to history
        window.saveSalaryToHistory = async function() {
            if (!currentSalaryData || !currentCalculations) {
                showNotification('No salary data to save!', 'error');
                return;
            }
            
            try {
                // Show saving indicator
                const saveBtn = document.getElementById('save-salary-btn');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Saving...';
                saveBtn.disabled = true;
                
                // Save to history
                await addDoc(collection(db, `users/${currentUser.uid}/salaryHistory`), {
                    ...currentSalaryData,
                    netPay: currentCalculations.netPay,
                    createdAt: Timestamp.now(),
                    monthYear: currentSalaryData.payPeriod,
                    totalEarnings: currentCalculations.totalEarnings,
                    totalDeductions: currentCalculations.totalDeductions,
                    pf: currentCalculations.pf,
                    esi: currentCalculations.esi,
                    userId: currentUser.uid,
                    userEmail: currentUser.email
                });
                
                // Reset button
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                
                // Show success
                showNotification('Salary slip saved to history!', 'success');
                
                // Refresh history list
                await loadSalaryHistory();
                
                // Reinitialize icons
                lucide.createIcons();
                
            } catch (error) {
                console.error('Error saving salary history:', error);
                showNotification('Error saving salary slip', 'error');
                
                // Reset button
                const saveBtn = document.getElementById('save-salary-btn');
                saveBtn.innerHTML = '<i data-lucide="save"></i> Save Slip';
                saveBtn.disabled = false;
            }
        };

        // Load salary history
        async function loadSalaryHistory() {
            try {
                const historyList = document.getElementById('salary-history-list');
                historyList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-12 h-12 border-4 border-gray-300 border-t-blue-500 rounded-full animate-spin mx-auto"></div>
                        <p class="mt-4 text-gray-500 dark:text-gray-400">Loading history...</p>
                    </div>
                `;
                
                // Query salary history
                const historyQuery = query(
                    collection(db, `users/${currentUser.uid}/salaryHistory`),
                    orderBy('createdAt', 'desc')
                );
                
                // Clear previous listener
                if (salaryHistoryListener) {
                    salaryHistoryListener();
                }
                
                // Set up real-time listener
                salaryHistoryListener = onSnapshot(historyQuery, (snapshot) => {
                    if (snapshot.empty) {
                        historyList.innerHTML = `
                            <div class="text-center py-12">
                                <i data-lucide="file-text" class="w-16 h-16 text-gray-300 dark:text-gray-600 mx-auto"></i>
                                <p class="mt-4 text-gray-500 dark:text-gray-400">No salary history yet</p>
                                <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">Generate and save your first salary slip!</p>
                            </div>
                        `;
                        lucide.createIcons();
                        return;
                    }
                    
                    historyList.innerHTML = '';
                    
                    snapshot.docs.forEach((doc, index) => {
                        const data = doc.data();
                        const historyItem = createHistoryListItem(doc.id, data, index);
                        historyList.appendChild(historyItem);
                    });
                    
                    // Update history stats
                    updateHistoryStats(snapshot.docs);
                });
                
            } catch (error) {
                console.error('Error loading salary history:', error);
                document.getElementById('salary-history-list').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i data-lucide="alert-circle" class="w-12 h-12 mx-auto"></i>
                        <p class="mt-4">Error loading history</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        // Create history list item
        function createHistoryListItem(docId, data, index) {
            const div = document.createElement('div');
            div.className = 'p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition cursor-pointer group';
            div.onclick = () => loadHistoryToCalculator(docId);
            
            const netPay = data.netPay || calculateNetPayFromData(data);
            
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <h3 class="font-semibold text-gray-800 dark:text-gray-200 group-hover:text-blue-600 dark:group-hover:text-blue-400">${data.payPeriod || 'Salary Slip'}</h3>
                            <span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-300 px-2 py-1 rounded">Saved</span>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                            ${data.createdAt?.toDate().toLocaleDateString('en-IN', { 
                                day: 'numeric', 
                                month: 'short', 
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) || 'No date'}
                        </p>
                        <div class="flex items-center gap-4 mt-2 text-sm">
                            <span class="text-gray-600 dark:text-gray-400">Basic: ₹${data.basic?.toLocaleString() || '0'}</span>
                            <span class="text-gray-600 dark:text-gray-400">HRA: ₹${data.hra?.toLocaleString() || '0'}</span>
                        </div>
                    </div>
                    <div class="text-right ml-4">
                        <div class="text-xl font-bold text-green-600">₹${netPay.toLocaleString()}</div>
                        <div class="flex gap-2 mt-2">
                            <button onclick="event.stopPropagation(); loadHistoryToCalculator('${docId}')" 
                                    class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300"
                                    title="Load into Calculator">
                                <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
                            </button>
                            <button onclick="event.stopPropagation(); shareOnWhatsAppFromHistory('${docId}')" 
                                    class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300"
                                    title="Share on WhatsApp">
                                <i data-lucide="message-circle" class="w-4 h-4"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteHistoryItem('${docId}')" 
                                    class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"
                                    title="Delete">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Calculate net pay from data
        function calculateNetPayFromData(data) {
            const totalEarnings = data.basic + data.hra + data.conveyanceAllowance + 
                                data.medicalAllowance + data.specialAllowance + 
                                data.overtime + data.bonus;
            
            const pf = Math.round(data.basic * 0.12);
            let esi = 0;
            if (totalEarnings <= 21000) {
                esi = Math.round(totalEarnings * 0.0075);
            }
            
            const totalDeductions = data.professionalTax + data.tds + 
                                  data.loanRecovery + pf + esi;
            
            return totalEarnings - totalDeductions;
        }

        // Update history statistics
        function updateHistoryStats(docs) {
            let totalEarnings = 0;
            let totalDeductions = 0;
            let totalNetPay = 0;
            
            docs.forEach(doc => {
                const data = doc.data();
                const netPay = data.netPay || calculateNetPayFromData(data);
                const earnings = data.totalEarnings || calculateTotalEarningsFromData(data);
                const deductions = data.totalDeductions || calculateTotalDeductionsFromData(data);
                
                totalEarnings += earnings;
                totalDeductions += deductions;
                totalNetPay += netPay;
            });
            
            document.getElementById('history-count').textContent = docs.length;
            document.getElementById('total-saved-earnings').textContent = `₹${totalEarnings.toLocaleString()}`;
            document.getElementById('total-saved-deductions').textContent = `₹${totalDeductions.toLocaleString()}`;
            document.getElementById('total-saved-netpay').textContent = `₹${totalNetPay.toLocaleString()}`;
        }

        function calculateTotalEarningsFromData(data) {
            return data.basic + data.hra + data.conveyanceAllowance + 
                   data.medicalAllowance + data.specialAllowance + 
                   data.overtime + data.bonus;
        }

        function calculateTotalDeductionsFromData(data) {
            const totalEarnings = calculateTotalEarningsFromData(data);
            const pf = Math.round(data.basic * 0.12);
            let esi = 0;
            if (totalEarnings <= 21000) {
                esi = Math.round(totalEarnings * 0.0075);
            }
            
            return data.professionalTax + data.tds + 
                   data.loanRecovery + pf + esi;
        }

        // Load history item into calculator
        window.loadHistoryToCalculator = async function(docId) {
            try {
                const docRef = doc(db, `users/${currentUser.uid}/salaryHistory`, docId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Update current display with historical data
                    updateSalaryDisplay(data);
                    
                    // Scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    
                    showNotification(`Loaded ${data.payPeriod} salary slip into calculator`, 'success');
                }
            } catch (error) {
                console.error('Error loading history item:', error);
                showNotification('Error loading salary slip', 'error');
            }
        };

        // Delete history item
        window.deleteHistoryItem = async function(docId) {
            if (confirm('Are you sure you want to delete this salary slip from history?')) {
                try {
                    await deleteDoc(doc(db, `users/${currentUser.uid}/salaryHistory`, docId));
                    showNotification('Salary slip deleted from history', 'success');
                } catch (error) {
                    console.error('Error deleting history item:', error);
                    showNotification('Error deleting salary slip', 'error');
                }
            }
        };

        // Share on WhatsApp from history
        window.shareOnWhatsAppFromHistory = async function(docId) {
            try {
                const docRef = doc(db, `users/${currentUser.uid}/salaryHistory`, docId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const netPay = data.netPay || calculateNetPayFromData(data);
                    
                    const message = `Hello, Please find attached my Salary Slip for ${data.payPeriod || 'this month'}. Net Payable: ₹${netPay.toLocaleString()}.`;
                    
                    const encodedMessage = encodeURIComponent(message);
                    const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
                    
                    window.open(whatsappUrl, '_blank');
                    
                    showNotification('WhatsApp share opened!', 'success');
                }
            } catch (error) {
                console.error('Error sharing via WhatsApp:', error);
                showNotification('Error sharing on WhatsApp', 'error');
            }
        };

        // Update WhatsApp message
        function updateWhatsAppMessage(payPeriod, netPay) {
            const message = `Hello, Please find attached my Salary Slip for ${payPeriod}. Net Payable: ₹${netPay.toLocaleString()}.`;
            document.getElementById('whatsapp-message').value = message;
        }

        // Share on WhatsApp function
        window.shareOnWhatsApp = function() {
            const message = document.getElementById('whatsapp-message').value;
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
            showNotification('Opening WhatsApp...', 'info');
        };

        // Show salary history modal
        window.showSalaryHistory = function() {
            document.getElementById('salary-history-modal').classList.remove('hidden');
        };

        // Close salary history modal
        window.closeSalaryHistory = function() {
            document.getElementById('salary-history-modal').classList.add('hidden');
        };

        // Number to words conversion
        function numberToWords(num) {
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            
            if (num === 0) return 'Zero';
            
            function convertLessThanThousand(n) {
                if (n === 0) return '';
                
                let words = '';
                
                if (n >= 100) {
                    words += ones[Math.floor(n / 100)] + ' Hundred ';
                    n %= 100;
                }
                
                if (n >= 20) {
                    words += tens[Math.floor(n / 10)] + ' ';
                    n %= 10;
                }
                
                if (n >= 10 && n < 20) {
                    words += teens[n - 10] + ' ';
                    return words;
                }
                
                if (n > 0) {
                    words += ones[n] + ' ';
                }
                
                return words;
            }
            
            let result = '';
            let crore = Math.floor(num / 10000000);
            let lakh = Math.floor((num % 10000000) / 100000);
            let thousand = Math.floor((num % 100000) / 1000);
            let remainder = num % 1000;
            
            if (crore > 0) {
                result += convertLessThanThousand(crore) + 'Crore ';
            }
            
            if (lakh > 0) {
                result += convertLessThanThousand(lakh) + 'Lakh ';
            }
            
            if (thousand > 0) {
                result += convertLessThanThousand(thousand) + 'Thousand ';
            }
            
            result += convertLessThanThousand(remainder);
            
            return result.trim() + ' Rupees Only';
        }

        // Print function
        window.printSalarySlip = function() {
            window.print();
        };

        // Logout function
        window.handleLogout = async function() {
            try {
                if (userSessionListener) {
                    userSessionListener();
                }
                if (adminUsersListener) {
                    adminUsersListener();
                }
                if (salaryHistoryListener) {
                    salaryHistoryListener();
                }
                
                await signOut(auth);
                currentUser = null;
                currentRole = 'employee';
                
                // Reset UI
                document.getElementById('admin-badge').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.add('hidden');
                
                // Clear any notifications
                const notification = document.getElementById('temp-notification');
                if (notification) notification.remove();
                
                // Show login screen
                switchScreen('login-screen');
                
                showNotification('Logged out successfully', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Error during logout', 'error');
            }
        };

        // Initialize app with pre-filled credentials
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme
            initTheme();
            
            // Initialize icons
            lucide.createIcons();
            
            // Auto-fill demo credentials
            document.getElementById('login-email').value = ADMIN_EMAIL;
            document.getElementById('login-password').value = 'Hare Krishna';
            
            // Setup auth state listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    
                    // Check if admin
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        
                        if (userData.role === 'admin') {
                            currentRole = 'admin';
                            switchScreen('admin-dashboard');
                            initAdminDashboard();
                            showNotification('Welcome back, Admin!', 'success');
                            return;
                        }
                    }
                    
                    // For regular users
                    switchScreen('app-content');
                    await loadUserSalaryData();
                    showNotification('Welcome back!', 'success');
                    
                } else {
                    // No user is signed in
                    currentUser = null;
                    switchScreen('login-screen');
                }
            });
            
            // Initially show login screen
            switchScreen('login-screen');
        });
    </script>
    
    <style>
        .hidden {
            display: none !important;
        }
        
        .salary-table {
            border-collapse: collapse;
            width: 100%;
        }
        
        .salary-table th, .salary-table td {
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            text-align: left;
        }
        
        .salary-table th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        
        .salary-table tr:hover {
            background-color: #f9fafb;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Dark mode styles */
        .dark .salary-table th,
        .dark .salary-table td {
            border-color: #374151;
        }
        
        .dark .salary-table th {
            background-color: #1f2937;
            color: #f9fafb;
        }
        
        .dark .salary-table tr:hover {
            background-color: #1f2937;
        }
        
        /* Skeleton loading animation */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        
        .dark .skeleton {
            background: linear-gradient(90deg, #2d3748 25%, #4a5568 50%, #2d3748 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        
        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .bg-white, .shadow-lg, .rounded-xl {
                background: white !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                border: 1px solid #000 !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-200">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white dark:bg-gray-900 z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
            <p class="mt-4 text-gray-600 dark:text-gray-400">Loading...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-800 dark:to-gray-900 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="dollar-sign" class="w-10 h-10 text-blue-600 dark:text-blue-400"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Salary Portal</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-2">Sign in to access your salary slips</p>
            </div>
            
            <form onsubmit="handleLogin(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email Address</label>
                        <input id="login-email" type="email" required 
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                               placeholder="Enter your email">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password</label>
                        <input id="login-password" type="password" required 
                               class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                               placeholder="Enter your password">
                    </div>
                    
                    <div id="login-error" class="bg-red-50 dark:bg-red-900/50 text-red-600 dark:text-red-400 p-3 rounded-lg hidden"></div>
                    
                    <button type="submit" 
                            class="w-full bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-800 text-white py-3 rounded-lg font-semibold transition duration-200">
                        Sign In
                    </button>
                </div>
            </form>
            
            <div class="mt-6 text-center text-sm text-gray-600 dark:text-gray-400">
                <p class="font-semibold">Demo Credentials:</p>
                <p>Admin: shivshreek@gmail.com</p>
                <p>Password: Hare Krishna</p>
                <p class="mt-4 text-xs text-gray-500">Note: Admin can add new users via User Management</p>
            </div>
        </div>
    </div>

    <!-- OTP Verification Screen -->
    <div id="otp-screen" class="hidden min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-800 dark:to-gray-900 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="shield-check" class="w-10 h-10 text-green-600 dark:text-green-400"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">OTP Verification</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-2">Please enter the OTP sent to your registered email</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">6-digit OTP</label>
                    <input id="otp-input" type="text" maxlength="6" pattern="\d{6}" 
                           class="w-full px-4 py-3 text-center text-2xl tracking-widest rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                           placeholder="000000">
                </div>
                
                <div id="otp-error" class="bg-red-50 dark:bg-red-900/50 text-red-600 dark:text-red-400 p-3 rounded-lg hidden"></div>
                
                <button onclick="verifyOTP()" 
                        class="w-full bg-green-600 hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-800 text-white py-3 rounded-lg font-semibold transition duration-200">
                    Verify OTP
                </button>
                
                <button onclick="handleLogout()" 
                        class="w-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-white py-3 rounded-lg font-semibold transition duration-200">
                    Back to Login
                </button>
            </div>
            
            <div class="mt-6 text-center text-sm text-gray-600 dark:text-gray-400">
                <p>Demo OTP: <span class="font-mono font-bold">123456</span></p>
            </div>
        </div>
    </div>

    <!-- Main App Content -->
    <div id="app-content" class="hidden min-h-screen bg-gray-50 dark:bg-gray-900">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <i data-lucide="dollar-sign" class="w-8 h-8 text-blue-600 dark:text-blue-400"></i>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800 dark:text-white">Salary Slip Portal</h1>
                            <p class="text-sm text-gray-600 dark:text-gray-400" id="user-name">Welcome</p>
                        </div>
                        <span id="admin-badge" class="hidden bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-300 text-xs font-semibold px-2.5 py-0.5 rounded">
                            Admin
                        </span>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <button onclick="toggleTheme()" 
                                class="flex items-center space-x-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white transition">
                            <i data-lucide="moon" id="theme-toggle-icon" class="w-5 h-5"></i>
                            <span id="theme-toggle-text">Dark Mode</span>
                        </button>
                        <button onclick="showSalaryHistory()"
                                class="flex items-center space-x-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white transition">
                            <i data-lucide="history" class="w-5 h-5"></i>
                            <span>History</span>
                        </button>
                        <span id="user-email" class="text-gray-600 dark:text-gray-400"></span>
                        <button onclick="handleLogout()" 
                                class="flex items-center space-x-2 bg-red-50 dark:bg-red-900/50 text-red-600 dark:text-red-400 px-4 py-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900 transition">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Salary Slip Card -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                <!-- Header -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="text-2xl font-bold">SALARY SLIP</h1>
                            <p class="text-blue-100 mt-1" id="pay-period">January 2024</p>
                        </div>
                        <div class="flex gap-2">
                            <button id="save-salary-btn" onclick="saveSalaryToHistory()"
                                    class="flex items-center space-x-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition no-print">
                                <i data-lucide="save" class="w-4 h-4"></i>
                                <span>Save Slip</span>
                            </button>
                            <button onclick="shareOnWhatsApp()"
                                    class="flex items-center space-x-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition no-print">
                                <i data-lucide="message-circle" class="w-4 h-4"></i>
                                <span>WhatsApp</span>
                            </button>
                            <button onclick="printSalarySlip()"
                                    class="flex items-center space-x-2 bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition no-print">
                                <i data-lucide="printer" class="w-4 h-4"></i>
                                <span>Print</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Employee Details -->
                <div class="p-6 border-b dark:border-gray-700">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Employee Name</p>
                            <p class="font-semibold text-gray-800 dark:text-white" id="employee-name">John Doe</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Designation</p>
                            <p class="font-semibold text-gray-800 dark:text-white" id="designation">Software Engineer</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Department</p>
                            <p class="font-semibold text-gray-800 dark:text-white" id="department">Engineering</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Bank Account</p>
                            <p class="font-semibold text-gray-800 dark:text-white" id="bank-account">XXXXXX1234</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Paid Days</p>
                            <p class="font-semibold text-gray-800 dark:text-white" id="paid-days">31</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Loss of Pay Days</p>
                            <p class="font-semibold text-gray-800 dark:text-white" id="lop-days">0</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">PAN Number</p>
                            <p class="font-semibold text-gray-800 dark:text-white" id="pan-number">ABCDE1234F</p>
                        </div>
                    </div>
                </div>

                <!-- Salary Details Table -->
                <div class="overflow-x-auto">
                    <table class="salary-table">
                        <thead>
                            <tr>
                                <th colspan="2" class="text-center bg-blue-50 dark:bg-gray-700">EARNINGS</th>
                                <th colspan="2" class="text-center bg-blue-50 dark:bg-gray-700">DEDUCTIONS</th>
                            </tr>
                            <tr>
                                <th class="dark:text-gray-200">Particulars</th>
                                <th class="dark:text-gray-200">Amount (₹)</th>
                                <th class="dark:text-gray-200">Particulars</th>
                                <th class="dark:text-gray-200">Amount (₹)</th>
                            </tr>
                        </thead>
                        <tbody class="dark:text-gray-300">
                            <tr>
                                <td>Basic</td>
                                <td id="basic-amount">30,000</td>
                                <td>Provident Fund</td>
                                <td id="pf-amount">3,600</td>
                            </tr>
                            <tr>
                                <td>House Rent Allowance</td>
                                <td id="hra-amount">12,000</td>
                                <td>ESI</td>
                                <td id="esi-amount">0</td>
                            </tr>
                            <tr>
                                <td>Conveyance Allowance</td>
                                <td id="conveyance-amount">1,600</td>
                                <td>Professional Tax</td>
                                <td id="pt-amount">200</td>
                            </tr>
                            <tr>
                                <td>Medical Allowance</td>
                                <td id="medical-amount">1,250</td>
                                <td>TDS</td>
                                <td id="tds-amount">1,500</td>
                            </tr>
                            <tr>
                                <td>Special Allowance</td>
                                <td id="special-amount">15,350</td>
                                <td>Loan Recovery</td>
                                <td id="loan-amount">1,000</td>
                            </tr>
                            <tr>
                                <td>Overtime</td>
                                <td id="overtime-amount">2,000</td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>Bonus</td>
                                <td id="bonus-amount">5,000</td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr class="font-semibold bg-gray-50 dark:bg-gray-700">
                                <td class="dark:text-white">Total Earnings</td>
                                <td class="dark:text-white" id="total-earnings">66,200</td>
                                <td class="dark:text-white">Total Deductions</td>
                                <td class="dark:text-white" id="total-deductions">6,300</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Net Pay Section -->
                <div class="p-6 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-gray-700 dark:to-gray-800">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">NET PAYABLE</p>
                            <p class="text-3xl font-bold text-green-700 dark:text-green-400" id="net-pay">₹59,900</p>
                            <p class="text-gray-600 dark:text-gray-400 italic mt-1" id="net-pay-words">
                                Fifty Nine Thousand Nine Hundred Rupees Only
                            </p>
                        </div>
                        <div class="text-right space-x-2 no-print">
                            <!-- WhatsApp Message Input -->
                            <div class="mb-3">
                                <textarea id="whatsapp-message" rows="2" 
                                          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-white text-sm"
                                          placeholder="WhatsApp message will auto-generate..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="hidden min-h-screen bg-gray-50 dark:bg-gray-900">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <i data-lucide="shield-check" class="w-8 h-8 text-purple-600 dark:text-purple-400"></i>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800 dark:text-white">Admin Dashboard</h1>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Logged in as: shivshreek@gmail.com</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <button onclick="toggleTheme()" 
                                class="flex items-center space-x-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white transition">
                            <i data-lucide="moon" class="w-5 h-5"></i>
                            <span>Dark Mode</span>
                        </button>
                        <button onclick="showUserManagement()"
                                class="flex items-center space-x-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                            <i data-lucide="users" class="w-4 h-4"></i>
                            <span>User Management</span>
                        </button>
                        <button onclick="handleLogout()" 
                                class="flex items-center space-x-2 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Admin Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Total Users</p>
                            <p class="text-2xl font-bold text-gray-800 dark:text-white" id="total-users">0</p>
                        </div>
                        <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-lg">
                            <i data-lucide="users" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Pending Approvals</p>
                            <p class="text-2xl font-bold text-gray-800 dark:text-white" id="pending-actions">0</p>
                        </div>
                        <div class="bg-yellow-100 dark:bg-yellow-900 p-3 rounded-lg">
                            <i data-lucide="alert-circle" class="w-6 h-6 text-yellow-600 dark:text-yellow-400"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">System Status</p>
                            <p class="text-2xl font-bold text-green-600 dark:text-green-400">Active</p>
                        </div>
                        <div class="bg-green-100 dark:bg-green-900 p-3 rounded-lg">
                            <i data-lucide="check-circle" class="w-6 h-6 text-green-600 dark:text-green-400"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pending Approvals -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 dark:text-white">Pending Approvals</h2>
                        <p class="text-gray-600 dark:text-gray-400">Users waiting for OTP verification</p>
                    </div>
                    <div class="bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-300 text-sm font-semibold px-3 py-1 rounded-full">
                        <span id="pending-count">0</span> Pending
                    </div>
                </div>
                
                <div class="space-y-4 max-h-96 overflow-y-auto scrollbar-hide">
                    <ul id="pending-users-list" class="space-y-3">
                        <!-- Users will be loaded here dynamically -->
                        <li class="text-center text-gray-500 dark:text-gray-400 py-8">No pending approvals</li>
                    </ul>
                </div>
            </div>

            <!-- Active Users -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 dark:text-white">Active Users</h2>
                        <p class="text-gray-600 dark:text-gray-400">Users with access to the portal</p>
                    </div>
                    <div class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-300 text-sm font-semibold px-3 py-1 rounded-full">
                        <span id="active-count">0</span> Active
                    </div>
                </div>
                
                <div class="space-y-4 max-h-96 overflow-y-auto scrollbar-hide">
                    <ul id="active-users-list" class="space-y-3">
                        <!-- Users will be loaded here dynamically -->
                        <li class="text-center text-gray-500 dark:text-gray-400 py-8">No active users</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <!-- User Management Screen -->
    <div id="user-management" class="hidden min-h-screen bg-gray-50 dark:bg-gray-900">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <button onclick="backToAdminDashboard()"
                                class="flex items-center space-x-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white transition">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                            <span>Back</span>
                        </button>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800 dark:text-white">User Management</h1>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Add, edit, and manage system users</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <button onclick="showAddUserModal()"
                                class="flex items-center space-x-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                            <i data-lucide="user-plus" class="w-4 h-4"></i>
                            <span>Add User</span>
                        </button>
                        <button onclick="handleLogout()" 
                                class="flex items-center space-x-2 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- User Management Content -->
        <main class="container mx-auto px-4 py-8">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-6">All Users</h2>
                
                <div class="overflow-x-auto">
                    <ul id="all-users-list" class="space-y-3">
                        <!-- All users will be loaded here dynamically -->
                        <li class="text-center text-gray-500 dark:text-gray-400 py-8">No users found</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <!-- Salary History Modal -->
    <div id="salary-history-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">Salary History</h2>
                    <button onclick="closeSalaryHistory()" 
                            class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                <!-- History Stats -->
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg text-center">
                        <div class="text-sm text-gray-600 dark:text-gray-400">Total Saved</div>
                        <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="history-count">0</div>
                    </div>
                    <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg text-center">
                        <div class="text-sm text-gray-600 dark:text-gray-400">Total Earnings</div>
                        <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="total-saved-earnings">₹0</div>
                    </div>
                    <div class="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg text-center">
                        <div class="text-sm text-gray-600 dark:text-gray-400">Net Pay</div>
                        <div class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="total-saved-netpay">₹0</div>
                    </div>
                </div>
                
                <!-- History List -->
                <div class="space-y-4" id="salary-history-list">
                    <!-- Salary history will be loaded here dynamically -->
                    <div class="text-center py-12">
                        <i data-lucide="file-text" class="w-16 h-16 text-gray-300 dark:text-gray-600 mx-auto"></i>
                        <p class="mt-4 text-gray-500 dark:text-gray-400">No salary history yet</p>
                        <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">Generate and save your first salary slip!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
            <div class="p-6 border-b dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">Add New User</h2>
                    <button onclick="closeAddUserModal()" 
                            class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            
            <form id="add-user-form" onsubmit="addNewUser(event)" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email Address *</label>
                        <input id="new-user-email" type="email" required 
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                               placeholder="user@example.com">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password *</label>
                        <input id="new-user-password" type="password" required 
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                               placeholder="Enter password">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Full Name *</label>
                        <input id="new-user-name" type="text" required 
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                               placeholder="John Doe">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Monthly Salary (Optional)</label>
                        <input id="new-user-salary" type="number" 
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                               placeholder="50000">
                    </div>
                    
                    <div id="add-user-error" class="bg-red-50 dark:bg-red-900/50 text-red-600 dark:text-red-400 p-3 rounded-lg hidden"></div>
                    
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeAddUserModal()"
                                class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white px-4 py-3 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                            Cancel
                        </button>
                        <button id="add-user-btn" type="submit"
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-semibold transition flex items-center justify-center space-x-2">
                            <i data-lucide="user-plus" class="w-4 h-4"></i>
                            <span>Add User</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize icons after page loads
        lucide.createIcons();
    </script>
</body>
</html>
