<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Portal Pro | Shivshree Kumar - September 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Chart.js for History Graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        },
                        success: {
                            50: '#f0fdf4',
                            500: '#22c55e',
                            600: '#16a34a',
                        },
                        warning: {
                            50: '#fefce8',
                            500: '#f59e0b',
                            600: '#d97706',
                        },
                        danger: {
                            50: '#fef2f2',
                            500: '#ef4444',
                            600: '#dc2626',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Smooth transitions */
        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 300ms;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 5px; }
        ::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 5px;
            border: 2px solid #f1f5f9;
        }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        .dark ::-webkit-scrollbar-thumb { 
            background: #475569;
            border-color: #1e293b;
        }
        
        /* Glass effect */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .dark .glass {
            background: rgba(30, 41, 59, 0.7);
        }
        
        /* Shimmer loading animation */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        .dark .shimmer {
            background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%);
            background-size: 1000px 100%;
        }
        
        /* Input focus effects */
        .input-focus {
            transition: all 0.3s ease;
            border: 2px solid #e2e8f0;
        }
        .input-focus:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }
        .dark .input-focus {
            border-color: #475569;
            background: #1e293b;
        }
        .dark .input-focus:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }
        
        /* Button animations */
        .btn-pop {
            transition: all 0.2s ease;
        }
        .btn-pop:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .btn-pop:active {
            transform: translateY(0);
        }
        
        /* Fade animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        /* Notification badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* OTP input styling */
        .otp-input {
            width: 50px;
            height: 60px;
            font-size: 24px;
            text-align: center;
            border: 2px solid #cbd5e1;
            border-radius: 10px;
            transition: all 0.3s;
        }
        .otp-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            outline: none;
        }
        .dark .otp-input {
            border-color: #475569;
            background: #1e293b;
        }
        
        /* Shake animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        /* Print styles */
        @media print {
            body * { visibility: hidden; }
            #payslip-container, #payslip-container * { 
                visibility: visible; 
                color: black !important;
            }
            #payslip-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white !important;
                box-shadow: none;
                border: none;
            }
            .no-print { display: none !important; }
        }
        
        /* Salary slip specific styles */
        .salary-table {
            border-collapse: separate;
            border-spacing: 0;
        }
        .salary-table th {
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        .salary-table td {
            border-bottom: 1px solid #f3f4f6;
            padding: 12px 16px;
        }
        .salary-table tr:last-child td {
            border-bottom: none;
        }
        .dark .salary-table th {
            border-bottom-color: #374151;
        }
        .dark .salary-table td {
            border-bottom-color: #374151;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 dark:from-slate-900 dark:to-slate-800 min-h-screen text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <!-- LOADING SCREEN -->
    <div id="loading-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white dark:bg-slate-900 transition-all duration-500">
        <div class="relative">
            <div class="w-20 h-20 border-4 border-primary-100 dark:border-slate-700 border-t-primary-600 dark:border-t-primary-500 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i data-lucide="calculator" class="w-8 h-8 text-primary-600 dark:text-primary-400"></i>
            </div>
        </div>
        <p class="mt-6 text-lg font-medium text-slate-600 dark:text-slate-400 animate-pulse">Loading Salary Portal...</p>
        <p class="mt-2 text-sm text-slate-500 dark:text-slate-500">Secure & Professional</p>
    </div>

    <!-- NOTIFICATION TOAST -->
    <div id="notification-toast" class="fixed top-4 right-4 z-50 max-w-sm transition-all duration-500 transform translate-x-full">
        <div class="glass rounded-xl shadow-2xl p-4 border-l-4">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i data-lucide="check-circle" class="w-6 h-6 text-success-500"></i>
                </div>
                <div class="ml-3">
                    <p id="notification-title" class="font-semibold"></p>
                    <p id="notification-message" class="text-sm text-slate-600 dark:text-slate-400 mt-1"></p>
                </div>
                <button onclick="hideNotification()" class="ml-4 text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="hidden min-h-screen flex items-center justify-center p-4 fade-in">
        <div class="w-full max-w-md">
            <!-- Login Card -->
            <div class="glass rounded-3xl shadow-2xl overflow-hidden border border-slate-200/50 dark:border-slate-700/50">
                <!-- Header -->
                <div class="bg-gradient-to-r from-primary-600 to-primary-700 p-8 text-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-black/10"></div>
                    <div class="relative">
                        <div class="w-20 h-20 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm border border-white/20">
                            <i data-lucide="wallet" class="w-10 h-10 text-white"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-white">Salary Portal Pro</h1>
                        <p class="text-primary-200 text-sm mt-1">Secure Access • Professional Tools</p>
                    </div>
                </div>
                
                <!-- Login Form -->
                <div class="p-8">
                    <div id="login-form" class="space-y-6">
                        <div class="text-center">
                            <h2 class="text-xl font-bold text-slate-800 dark:text-white">Welcome Back</h2>
                            <p class="text-slate-600 dark:text-slate-400 mt-1">Sign in to access your salary tools</p>
                        </div>
                        
                        <button id="google-btn" onclick="handleGoogleLogin()" 
                                class="w-full btn-pop bg-white hover:bg-slate-50 text-slate-800 font-semibold py-3 px-4 rounded-xl transition-all duration-300 border border-slate-300 shadow-sm flex items-center justify-center gap-3">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                            <span>Continue with Google</span>
                        </button>
                        
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-slate-200 dark:border-slate-700"></div>
                            </div>
                            <div class="relative flex justify-center text-sm">
                                <span class="px-2 bg-white dark:bg-slate-800 text-slate-500">Quick settings</span>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <input type="checkbox" id="remember-me" class="w-4 h-4 text-primary-600 rounded focus:ring-primary-500 border-slate-300">
                                    <label for="remember-me" class="ml-2 text-sm text-slate-700 dark:text-slate-300">Keep me signed in</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="dark-mode-toggle" class="w-4 h-4 text-primary-600 rounded focus:ring-primary-500 border-slate-300" onchange="toggleDarkMode()">
                                    <label for="dark-mode-toggle" class="ml-2 text-sm text-slate-700 dark:text-slate-300">Dark mode</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center pt-4 border-t border-slate-100 dark:border-slate-800">
                            <p class="text-xs text-slate-500 dark:text-slate-500">
                                By continuing, you agree to our 
                                <a href="#" class="text-primary-600 hover:text-primary-700 font-medium">Terms</a> 
                                and acknowledge our 
                                <a href="#" class="text-primary-600 hover:text-primary-700 font-medium">Privacy Policy</a>
                            </p>
                        </div>
                    </div>

                    <!-- OTP Form -->
                    <div id="otp-form" class="hidden space-y-6">
                        <div class="text-center">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary-100 dark:bg-primary-900/30 mb-4">
                                <i data-lucide="shield-check" class="w-8 h-8 text-primary-600 dark:text-primary-400"></i>
                            </div>
                            <h2 class="text-xl font-bold text-slate-800 dark:text-white">Security Verification</h2>
                            <p class="text-slate-600 dark:text-slate-400 mt-1">Enter the OTP provided by admin</p>
                        </div>
                        
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 p-5 rounded-xl border border-blue-100 dark:border-blue-800">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="flex-shrink-0">
                                    <img id="user-avatar-otp" src="" class="w-12 h-12 rounded-full border-2 border-white shadow">
                                </div>
                                <div>
                                    <p id="user-name-otp" class="font-semibold text-slate-800 dark:text-white"></p>
                                    <p id="user-email-otp" class="text-sm text-slate-600 dark:text-slate-400"></p>
                                </div>
                            </div>
                            <p class="text-sm text-slate-700 dark:text-slate-300">
                                <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                                Contact <span class="font-semibold text-primary-600">admin@company.com</span> for your OTP code
                            </p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Enter 6-digit OTP</label>
                                <div class="flex justify-center gap-2" id="otp-container">
                                    <input type="text" maxlength="1" class="otp-input" data-index="0" oninput="moveToNext(this)">
                                    <input type="text" maxlength="1" class="otp-input" data-index="1" oninput="moveToNext(this)">
                                    <input type="text" maxlength="1" class="otp-input" data-index="2" oninput="moveToNext(this)">
                                    <input type="text" maxlength="1" class="otp-input" data-index="3" oninput="moveToNext(this)">
                                    <input type="text" maxlength="1" class="otp-input" data-index="4" oninput="moveToNext(this)">
                                    <input type="text" maxlength="1" class="otp-input" data-index="5" oninput="moveToNext(this)">
                                </div>
                                <input type="hidden" id="otp-combined">
                            </div>
                            
                            <div id="otp-error" class="hidden bg-danger-50 text-danger-600 dark:bg-danger-900/20 dark:text-danger-400 p-3 rounded-lg text-sm"></div>
                            
                            <div class="space-y-3">
                                <button id="verify-btn" onclick="handleVerifyOTP()" 
                                        class="w-full btn-pop bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-semibold py-3 rounded-xl transition-all duration-300 shadow-lg flex items-center justify-center gap-2">
                                    <i data-lucide="shield" class="w-5 h-5"></i>
                                    Verify & Continue
                                </button>
                                
                                <button onclick="handleLogout()" 
                                        class="w-full py-2.5 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-300 font-medium rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors flex items-center justify-center gap-2">
                                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                                    Use Different Account
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-center pt-4 border-t border-slate-100 dark:border-slate-800">
                            <p class="text-xs text-slate-500 dark:text-slate-500">
                                OTP expires in 10 minutes • Need help? 
                                <a href="#" class="text-primary-600 hover:text-primary-700 font-medium">Contact Support</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="text-center mt-6">
                <p class="text-sm text-slate-500 dark:text-slate-500">
                    © 2024 Salary Portal Pro • v2.1.0
                </p>
            </div>
        </div>
    </div>

    <!-- EMPLOYEE DETAILS FORM -->
    <div id="employee-details-form" class="hidden min-h-screen flex items-center justify-center p-4 fade-in">
        <div class="w-full max-w-2xl">
            <div class="glass rounded-3xl shadow-2xl overflow-hidden border border-slate-200/50 dark:border-slate-700/50">
                <!-- Header -->
                <div class="bg-gradient-to-r from-primary-600 to-primary-700 p-6 text-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-black/10"></div>
                    <div class="relative flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center backdrop-blur-sm border border-white/20">
                                <i data-lucide="user-plus" class="w-6 h-6 text-white"></i>
                            </div>
                            <div class="text-left">
                                <h2 class="text-xl font-bold text-white">Employee Details</h2>
                                <p id="welcome-msg" class="text-primary-200 text-sm">Complete your profile</p>
                            </div>
                        </div>
                        <button onclick="goBackToLogin()" class="text-white/80 hover:text-white p-2 rounded-lg hover:bg-white/10 transition-colors">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Form -->
                <div class="p-6">
                    <form id="employee-form" class="space-y-6">
                        <!-- Progress -->
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-primary-600">Step 1 of 2</span>
                                <span class="text-sm text-slate-500">Personal Details</span>
                            </div>
                            <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                                <div class="bg-primary-600 h-2 rounded-full w-1/2"></div>
                            </div>
                        </div>
                        
                        <!-- Company Info -->
                        <div class="space-y-4 p-5 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border border-slate-200 dark:border-slate-700">
                            <div class="flex items-center gap-2">
                                <i data-lucide="building" class="w-5 h-5 text-primary-600"></i>
                                <h3 class="text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wider">Company Information</h3>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Company Name *</label>
                                    <input type="text" id="company-name" class="input-focus w-full px-4 py-3 rounded-xl" placeholder="Enter company name" value="Tech Solutions Inc." required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Company Address</label>
                                    <input type="text" id="company-address" class="input-focus w-full px-4 py-3 rounded-xl" placeholder="Optional address" value="123 Business Park, Delhi, India">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Employee Details -->
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Employee Code *</label>
                                    <input type="text" id="emp-code" class="input-focus w-full px-4 py-3 rounded-xl" placeholder="e.g., EMP001" value="6138" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Employee Name *</label>
                                    <input type="text" id="emp-name" class="input-focus w-full px-4 py-3 rounded-xl" placeholder="Full name" value="Shivshree Kumar" required>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Father/Husband Name *</label>
                                    <input type="text" id="father-name" class="input-focus w-full px-4 py-3 rounded-xl" placeholder="Guardian's name" value="Santosh Kumar" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Designation</label>
                                    <input type="text" id="designation" class="input-focus w-full px-4 py-3 rounded-xl" placeholder="Job title" value="Senior Executive">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Department *</label>
                                    <div class="relative">
                                        <select id="department" onchange="toggleCustomDept()" class="input-focus w-full px-4 py-3 rounded-xl appearance-none" required>
                                            <option value="">Select Department</option>
                                            <option value="Maintenance">Maintenance</option>
                                            <option value="Quality">Quality</option>
                                            <option value="Production" selected>Production</option>
                                            <option value="HR">Human Resources</option>
                                            <option value="Finance">Finance</option>
                                            <option value="IT">Information Technology</option>
                                            <option value="Other">Other Department</option>
                                        </select>
                                        <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-5 h-5 text-slate-400 pointer-events-none"></i>
                                    </div>
                                    <input type="text" id="custom-dept" class="hidden input-focus w-full px-4 py-3 rounded-xl mt-2" placeholder="Specify department">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Date of Joining *</label>
                                    <input type="date" id="doj" class="input-focus w-full px-4 py-3 rounded-xl" value="2025-05-15" required>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Salary Month *</label>
                                    <div class="relative">
                                        <select id="salary-month" class="input-focus w-full px-4 py-3 rounded-xl appearance-none" required>
                                            <option value="October">October</option>
                                            <option value="November">November</option>
                                            <option value="December">December</option>
                                            <option value="January">January</option>
                                            <option value="February">February</option>
                                            <option value="March">March</option>
                                            <option value="April">April</option>
                                            <option value="May">May</option>
                                            <option value="June">June</option>
                                            <option value="July">July</option>
                                            <option value="August">August</option>
                                            <option value="September" selected>September</option>
                                        </select>
                                        <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-5 h-5 text-slate-400 pointer-events-none"></i>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Salary Year *</label>
                                    <div class="relative">
                                        <select id="salary-year" class="input-focus w-full px-4 py-3 rounded-xl appearance-none" required>
                                            <option value="2025" selected>2025</option>
                                            <option value="2026">2026</option>
                                            <option value="2027">2027</option>
                                        </select>
                                        <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-5 h-5 text-slate-400 pointer-events-none"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="pt-6 flex justify-between items-center border-t border-slate-200 dark:border-slate-700">
                            <button type="button" onclick="goBackToLogin()" 
                                    class="px-5 py-2.5 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-300 font-medium rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors flex items-center gap-2">
                                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                                Back to Login
                            </button>
                            <button type="submit" 
                                    class="btn-pop bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-semibold px-6 py-2.5 rounded-xl transition-all duration-300 shadow-lg flex items-center gap-2">
                                Continue to Calculator
                                <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="app-content" class="hidden p-4 md:p-6 fade-in">
        <div class="max-w-7xl mx-auto space-y-6">
            
            <!-- Top Navigation Bar -->
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <!-- Left: Brand & User Info -->
                <div class="flex items-center gap-4">
                    <div class="glass rounded-2xl p-3 border border-slate-200/50 dark:border-slate-700/50">
                        <div class="flex items-center gap-3">
                            <div class="bg-gradient-to-r from-primary-500 to-primary-600 p-2 rounded-xl">
                                <i data-lucide="wallet" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h1 class="font-bold text-slate-800 dark:text-white text-lg">Salary Portal Pro</h1>
                                <p id="current-user-info" class="text-xs text-slate-500 dark:text-slate-400">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Admin Badge -->
                    <div id="admin-badge" class="hidden">
                        <div class="glass rounded-full px-3 py-1.5 border border-purple-200 dark:border-purple-800">
                            <span class="text-xs font-semibold text-purple-700 dark:text-purple-300 flex items-center gap-1">
                                <i data-lucide="shield-check" class="w-3 h-3"></i>
                                ADMIN
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Right: Controls -->
                <div class="flex items-center gap-2">
                    <!-- History Button -->
                    <button onclick="toggleHistory()" class="glass btn-pop p-3 rounded-xl border border-slate-200/50 dark:border-slate-700/50 hover:bg-white/50 dark:hover:bg-slate-800/50 transition-all duration-300 group relative">
                        <i data-lucide="history" class="w-5 h-5 text-slate-600 dark:text-slate-400 group-hover:text-primary-600"></i>
                        <div id="history-badge" class="notification-badge hidden">0</div>
                    </button>
                    
                    <!-- Dark Mode Toggle -->
                    <button onclick="toggleDarkMode()" class="glass btn-pop p-3 rounded-xl border border-slate-200/50 dark:border-slate-700/50 hover:bg-white/50 dark:hover:bg-slate-800/50 transition-all duration-300 group">
                        <i data-lucide="moon" class="w-5 h-5 text-slate-600 dark:hidden group-hover:text-primary-600"></i>
                        <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-yellow-400"></i>
                    </button>
                    
                    <!-- User Menu -->
                    <div class="relative group">
                        <button class="glass btn-pop flex items-center gap-3 p-3 rounded-xl border border-slate-200/50 dark:border-slate-700/50 hover:bg-white/50 dark:hover:bg-slate-800/50 transition-all duration-300">
                            <img id="user-avatar-nav" src="" class="w-8 h-8 rounded-full border-2 border-white shadow">
                            <div class="text-left">
                                <p id="user-name-nav" class="text-sm font-semibold text-slate-800 dark:text-white">Loading...</p>
                                <p id="user-role-nav" class="text-xs text-slate-500 dark:text-slate-400">User</p>
                            </div>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div class="absolute right-0 top-full mt-2 w-48 glass rounded-xl shadow-2xl border border-slate-200/50 dark:border-slate-700/50 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform translate-y-2 group-hover:translate-y-0">
                            <div class="p-2">
                                <div class="p-3 border-b border-slate-200/50 dark:border-slate-700/50">
                                    <p class="text-sm font-medium text-slate-800 dark:text-white">Signed in as</p>
                                    <p id="user-email-nav" class="text-xs text-slate-500 dark:text-slate-400 truncate">loading...</p>
                                </div>
                                <button onclick="toggleHistory()" class="w-full text-left px-3 py-2.5 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg flex items-center gap-2">
                                    <i data-lucide="history" class="w-4 h-4"></i>
                                    History
                                </button>
                                <button onclick="handleLogout()" class="w-full text-left px-3 py-2.5 text-sm text-danger-600 hover:bg-danger-50 dark:hover:bg-danger-900/20 rounded-lg flex items-center gap-2">
                                    <i data-lucide="log-out" class="w-4 h-4"></i>
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HISTORY MODAL -->
            <div id="history-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                <div class="glass w-full max-w-4xl max-h-[90vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden border border-slate-200/50 dark:border-slate-700/50">
                    <!-- Header -->
                    <div class="p-6 border-b border-slate-200/50 dark:border-slate-700/50 bg-gradient-to-r from-primary-50 to-blue-50 dark:from-primary-900/20 dark:to-blue-900/20">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="bg-primary-100 dark:bg-primary-900/30 p-2 rounded-xl">
                                    <i data-lucide="archive" class="w-6 h-6 text-primary-600 dark:text-primary-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-slate-800 dark:text-white">Salary History</h3>
                                    <p class="text-sm text-slate-600 dark:text-slate-400">Your saved salary records</p>
                                </div>
                            </div>
                            <button onclick="toggleHistory()" class="p-2 hover:bg-slate-200/50 dark:hover:bg-slate-700/50 rounded-xl transition-colors">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="flex-1 overflow-hidden flex flex-col md:flex-row">
                        <!-- Chart Section -->
                        <div class="w-full md:w-2/5 p-6 border-r border-slate-200/50 dark:border-slate-700/50">
                            <div class="space-y-6">
                                <div>
                                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wider mb-4">Net Pay Trend</h4>
                                    <div class="relative h-64">
                                        <canvas id="historyChart"></canvas>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                                        <div class="flex items-center gap-2">
                                            <div class="w-3 h-3 rounded-full bg-primary-500"></div>
                                            <span class="text-sm text-slate-600 dark:text-slate-400">Average Net Pay</span>
                                        </div>
                                        <span id="avg-net-pay" class="font-semibold text-slate-800 dark:text-white">₹0</span>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                                        <div class="flex items-center gap-2">
                                            <div class="w-3 h-3 rounded-full bg-success-500"></div>
                                            <span class="text-sm text-slate-600 dark:text-slate-400">Highest Net Pay</span>
                                        </div>
                                        <span id="max-net-pay" class="font-semibold text-slate-800 dark:text-white">₹0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- List Section -->
                        <div class="w-full md:w-3/5 p-6 overflow-y-auto">
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wider">Saved Records</h4>
                                    <span id="record-count" class="text-xs text-slate-500 dark:text-slate-500">0 records</span>
                                </div>
                                <div id="history-list" class="space-y-3">
                                    <!-- Records will be loaded here -->
                                    <div class="text-center py-12">
                                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 dark:bg-slate-800 mb-4">
                                            <i data-lucide="file-text" class="w-8 h-8 text-slate-400"></i>
                                        </div>
                                        <h4 class="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-2">No Records Yet</h4>
                                        <p class="text-slate-500 dark:text-slate-500 max-w-sm mx-auto">
                                            Your saved salary slips will appear here. Create your first payslip to get started.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ADMIN DASHBOARD -->
            <div id="admin-dashboard" class="hidden space-y-6">
                <!-- Welcome Card -->
                <div class="glass rounded-3xl p-6 border border-slate-200/50 dark:border-slate-700/50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-3 rounded-2xl">
                                <i data-lucide="shield-check" class="w-8 h-8 text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-slate-800 dark:text-white">Admin Dashboard</h2>
                                <p class="text-slate-600 dark:text-slate-400">Manage user access and monitor activity</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="refreshDashboard()" class="glass btn-pop p-2.5 rounded-xl border border-slate-200/50 dark:border-slate-700/50 hover:bg-white/50 dark:hover:bg-slate-800/50 transition-all duration-300">
                                <i data-lucide="refresh-cw" class="w-5 h-5 text-slate-600 dark:text-slate-400"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass rounded-2xl p-5 border border-slate-200/50 dark:border-slate-700/50">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-2 bg-primary-100 dark:bg-primary-900/30 rounded-lg">
                                <i data-lucide="users" class="w-5 h-5 text-primary-600 dark:text-primary-400"></i>
                            </div>
                            <span id="active-count" class="text-2xl font-bold text-slate-800 dark:text-white">0</span>
                        </div>
                        <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Active Sessions</h3>
                        <p class="text-xs text-slate-500 dark:text-slate-500">Users currently online</p>
                    </div>
                    
                    <div class="glass rounded-2xl p-5 border border-slate-200/50 dark:border-slate-700/50">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-2 bg-warning-100 dark:bg-warning-900/30 rounded-lg">
                                <i data-lucide="clock" class="w-5 h-5 text-warning-600 dark:text-warning-400"></i>
                            </div>
                            <span id="pending-count" class="text-2xl font-bold text-slate-800 dark:text-white">0</span>
                        </div>
                        <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Pending Approvals</h3>
                        <p class="text-xs text-slate-500 dark:text-slate-500">Waiting for OTP verification</p>
                    </div>
                    
                    <div class="glass rounded-2xl p-5 border border-slate-200/50 dark:border-slate-700/50">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-2 bg-success-100 dark:bg-success-900/30 rounded-lg">
                                <i data-lucide="check-circle" class="w-5 h-5 text-success-600 dark:text-success-400"></i>
                            </div>
                            <span id="approved-count" class="text-2xl font-bold text-slate-800 dark:text-white">0</span>
                        </div>
                        <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Approved Today</h3>
                        <p class="text-xs text-slate-500 dark:text-slate-500">Users approved in last 24h</p>
                    </div>
                </div>

                <!-- Main Dashboard Content -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Quick OTP Generation -->
                    <div class="glass rounded-3xl p-6 border border-slate-200/50 dark:border-slate-700/50">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="bg-gradient-to-r from-green-500 to-green-600 p-2 rounded-xl">
                                    <i data-lucide="key-round" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-slate-800 dark:text-white">Quick OTP Generator</h3>
                                    <p class="text-sm text-slate-600 dark:text-slate-400">Generate OTP for users instantly</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-5">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">User Email</label>
                                    <input type="email" id="user-email-input" class="input-focus w-full px-4 py-3 rounded-xl" placeholder="employee@company.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">User Name</label>
                                    <input type="text" id="user-name-input" class="input-focus w-full px-4 py-3 rounded-xl" placeholder="John Doe">
                                </div>
                            </div>
                            
                            <button onclick="generateUserOTP()" 
                                    class="w-full btn-pop bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-3.5 rounded-xl transition-all duration-300 shadow-lg flex items-center justify-center gap-3">
                                <i data-lucide="key" class="w-5 h-5"></i>
                                Generate & Share OTP
                            </button>
                            
                            <!-- Generated OTP Display -->
                            <div id="otp-result" class="hidden space-y-4 p-5 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-2xl border border-green-200 dark:border-green-800">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="check-circle" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
                                        <h4 class="font-bold text-green-800 dark:text-green-300">OTP Generated Successfully!</h4>
                                    </div>
                                    <button onclick="copyOTP()" class="text-sm bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-3 py-1.5 rounded-lg flex items-center gap-2">
                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                        Copy OTP
                                    </button>
                                </div>
                                
                                <div class="space-y-3">
                                    <p class="text-sm text-green-700 dark:text-green-300">Share this OTP with the user:</p>
                                    <div class="flex items-center justify-between gap-4">
                                        <div class="flex-1 bg-white dark:bg-slate-800 p-4 rounded-xl border-2 border-green-300 dark:border-green-700">
                                            <p class="text-3xl font-mono font-bold text-center text-green-700 dark:text-green-300 tracking-widest" id="generated-otp"></p>
                                        </div>
                                        <button onclick="shareOTP()" class="glass p-3 rounded-xl border border-slate-200/50 dark:border-slate-700/50 hover:bg-white/50 dark:hover:bg-slate-800/50 transition-all duration-300">
                                            <i data-lucide="share-2" class="w-5 h-5 text-slate-600 dark:text-slate-400"></i>
                                        </button>
                                    </div>
                                    <p class="text-xs text-green-600 dark:text-green-400 text-center">
                                        <i data-lucide="clock" class="w-3 h-3 inline mr-1"></i>
                                        Valid for 10 minutes • Expires at <span id="otp-expiry" class="font-mono"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Approvals -->
                    <div class="glass rounded-3xl p-6 border border-slate-200/50 dark:border-slate-700/50">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="bg-gradient-to-r from-warning-500 to-warning-600 p-2 rounded-xl">
                                    <i data-lucide="clock" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-slate-800 dark:text-white">Pending Approvals</h3>
                                    <p class="text-sm text-slate-600 dark:text-slate-400">Users waiting for verification</p>
                                </div>
                            </div>
                            <div id="pending-badge" class="notification-badge">0</div>
                        </div>
                        
                        <div id="pending-users-list" class="space-y-4 max-h-[300px] overflow-y-auto pr-2">
                            <!-- Pending users will be loaded here -->
                            <div class="text-center py-8">
                                <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-slate-100 dark:bg-slate-800 mb-3">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-slate-400"></i>
                                </div>
                                <p class="text-slate-500 dark:text-slate-500">No pending approvals</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Sessions -->
                <div class="glass rounded-3xl p-6 border border-slate-200/50 dark:border-slate-700/50">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-2 rounded-xl">
                                <i data-lucide="monitor" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-slate-800 dark:text-white">Active Sessions</h3>
                                <p class="text-sm text-slate-600 dark:text-slate-400">Currently logged in users</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="active-users-list" class="space-y-4 max-h-[400px] overflow-y-auto pr-2">
                        <!-- Active users will be loaded here -->
                        <div class="text-center py-8">
                            <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-slate-100 dark:bg-slate-800 mb-3">
                                <i data-lucide="users" class="w-6 h-6 text-slate-400"></i>
                            </div>
                            <p class="text-slate-500 dark:text-slate-500">No active sessions</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CALCULATOR INTERFACE -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Input Panel -->
                <div class="lg:col-span-4 space-y-6">
                    <!-- Calculator Card -->
                    <div class="glass rounded-3xl p-6 border border-slate-200/50 dark:border-slate-700/50">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="bg-gradient-to-r from-primary-500 to-primary-600 p-2 rounded-xl">
                                    <i data-lucide="calculator" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-slate-800 dark:text-white">Salary Calculator</h3>
                                    <p class="text-sm text-slate-600 dark:text-slate-400">Adjust values for accurate calculation</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="savePayslip()" id="save-btn" 
                                        class="glass btn-pop text-sm bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white px-4 py-2 rounded-xl flex items-center gap-2 transition-all duration-300">
                                    <i data-lucide="save" class="w-4 h-4"></i>
                                    Save
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-5">
                            <!-- Basic Salary -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Basic Salary</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-slate-500">₹</span>
                                    <input type="number" id="basic" value="23541" oninput="calculate()" 
                                           class="input-focus w-full pl-8 pr-4 py-3 rounded-xl">
                                </div>
                            </div>
                            
                            <!-- Attendance -->
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400">Working Days</label>
                                    <input type="number" id="workingDays" value="26" oninput="calculate()" 
                                           class="input-focus w-full px-4 py-3 rounded-xl">
                                </div>
                                <div class="space-y-2">
                                    <label class="block text-xs font-medium text-slate-500 dark:text-slate-400">Present Days</label>
                                    <input type="number" id="presentDays" value="25" oninput="calculate()" 
                                           class="input-focus w-full px-4 py-3 rounded-xl">
                                </div>
                            </div>
                            
                            <!-- Variable Allowance -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Variable Allowance</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Hours</label>
                                        <input type="number" id="varHours" value="131.24" step="0.01" oninput="calculate()" 
                                               class="input-focus w-full px-4 py-3 rounded-xl">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">Rate (₹)</label>
                                        <input type="number" id="varRate" value="105.00" step="0.01" oninput="calculate()" 
                                               class="input-focus w-full px-4 py-3 rounded-xl">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Food Allowance -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Food Allowance</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-slate-500">₹</span>
                                    <input type="number" id="foodAllow" value="3000" oninput="calculate()" 
                                           class="input-focus w-full pl-8 pr-4 py-3 rounded-xl">
                                </div>
                            </div>
                            
                            <!-- Other Earnings -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Other Earnings</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-green-500">+</span>
                                    <input type="number" id="otherEarn" value="0" oninput="calculate()" 
                                           class="input-focus w-full pl-8 pr-4 py-3 rounded-xl border-green-200 dark:border-green-800 bg-green-50/50 dark:bg-green-900/10">
                                </div>
                            </div>
                            
                            <!-- Bus Deduction -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Bus Deduction</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-danger-500">-</span>
                                    <input type="number" id="busDed" value="750" oninput="calculate()" 
                                           class="input-focus w-full pl-8 pr-4 py-3 rounded-xl border-danger-200 dark:border-danger-800 bg-danger-50/50 dark:bg-danger-900/10">
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="grid grid-cols-2 gap-4 pt-4">
                                <button onclick="resetCalculator()" 
                                        class="glass py-3 text-sm text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-300 border border-slate-200/50 dark:border-slate-700/50 rounded-xl hover:bg-white/50 dark:hover:bg-slate-800/50 transition-colors flex items-center justify-center gap-2">
                                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                    Reset
                                </button>
                                <button onclick="calculate()" 
                                        class="btn-pop bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-semibold py-3 rounded-xl transition-all duration-300 shadow-lg flex items-center justify-center gap-2">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    Recalculate
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Tips -->
                    <div class="glass rounded-3xl p-5 border border-slate-200/50 dark:border-slate-700/50">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="lightbulb" class="w-5 h-5 text-warning-500"></i>
                            <h4 class="font-semibold text-slate-800 dark:text-white">Quick Tips</h4>
                        </div>
                        <ul class="space-y-3 text-sm text-slate-600 dark:text-slate-400">
                            <li class="flex items-start gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4 text-success-500 mt-0.5 flex-shrink-0"></i>
                                <span>Save frequently to track salary history</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4 text-success-500 mt-0.5 flex-shrink-0"></i>
                                <span>Use reset to restore default values</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4 text-success-500 mt-0.5 flex-shrink-0"></i>
                                <span>Download PDF for official records</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Payslip Preview -->
                <div class="lg:col-span-8">
                    <div class="glass rounded-3xl p-6 md:p-8 border border-slate-200/50 dark:border-slate-700/50">
                        <!-- Payslip Header -->
                        <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Payslip Preview</h2>
                                <p id="slip-month-display" class="text-slate-600 dark:text-slate-400">September 2025</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="downloadPDF()" 
                                        class="glass btn-pop px-5 py-2.5 text-slate-800 dark:text-white font-semibold rounded-xl border border-slate-200/50 dark:border-slate-700/50 hover:bg-white/50 dark:hover:bg-slate-800/50 transition-all duration-300 flex items-center gap-2">
                                    <i data-lucide="download" class="w-5 h-5"></i>
                                    Download PDF
                                </button>
                                <button onclick="printPayslip()" 
                                        class="glass btn-pop px-5 py-2.5 text-slate-800 dark:text-white font-semibold rounded-xl border border-slate-200/50 dark:border-slate-700/50 hover:bg-white/50 dark:hover:bg-slate-800/50 transition-all duration-300 flex items-center gap-2">
                                    <i data-lucide="printer" class="w-5 h-5"></i>
                                    Print
                                </button>
                            </div>
                        </div>
                        
                        <!-- Payslip Container -->
                        <div id="payslip-container" class="bg-white rounded-3xl shadow-2xl overflow-hidden border-2 border-slate-800 fade-in">
                            <!-- Company Header -->
                            <div class="bg-gradient-to-r from-primary-600 to-primary-700 text-white text-center py-6 px-4">
                                <h1 class="text-2xl font-bold uppercase tracking-wider" id="slipCompanyName">TECH SOLUTIONS INC.</h1>
                                <p class="text-lg opacity-90 mt-1">Salary Slip</p>
                                <p class="text-sm opacity-80 mt-1" id="slipMonthYear">September, 2025</p>
                                <p class="text-xs opacity-70 mt-2" id="slipCompanyAddress">123 Business Park, Delhi, India</p>
                            </div>
                            
                            <!-- Employee Details -->
                            <div class="grid grid-cols-1 md:grid-cols-2 border-b border-slate-300">
                                <div class="p-4 border-r border-slate-300 space-y-2">
                                    <div class="flex"><span class="w-32 text-slate-600">Emp Code:</span> <span class="font-semibold" id="slipEmpCode">6138</span></div>
                                    <div class="flex"><span class="w-32 text-slate-600">Emp Name:</span> <span class="font-semibold" id="slipEmpName">Shivshree Kumar</span></div>
                                    <div class="flex"><span class="w-32 text-slate-600">F/H Name:</span> <span class="font-semibold" id="slipFatherName">Santosh Kumar</span></div>
                                    <div class="flex"><span class="w-32 text-slate-600">PF. No.:</span> <span class="font-semibold">--</span></div>
                                </div>
                                <div class="p-4 space-y-2">
                                    <div class="flex"><span class="w-32 text-slate-600">Department:</span> <span class="font-semibold" id="slipDepartment">Production</span></div>
                                    <div class="flex"><span class="w-32 text-slate-600">Designation:</span> <span class="font-semibold" id="slipDesignation">Senior Executive</span></div>
                                    <div class="flex"><span class="w-32 text-slate-600">D.O.J.:</span> <span class="font-semibold" id="slipDOJ">2025-05-15</span></div>
                                    <div class="flex"><span class="w-32 text-slate-600">E.S.I. No.:</span> <span class="font-semibold">--</span></div>
                                </div>
                            </div>
                            
                            <!-- Attendance Summary -->
                            <div class="grid grid-cols-3 border-b border-slate-800 text-center">
                                <div class="p-3 border-r border-slate-300">
                                    <div class="text-xs text-slate-500 uppercase tracking-wider">Working Days</div>
                                    <div class="text-xl font-bold" id="slipWorkingDays">26</div>
                                </div>
                                <div class="p-3 border-r border-slate-300">
                                    <div class="text-xs text-slate-500 uppercase tracking-wider">Present Days</div>
                                    <div class="text-xl font-bold" id="slipPresentDays">25</div>
                                </div>
                                <div class="p-3">
                                    <div class="text-xs text-slate-500 uppercase tracking-wider">Variable Hours</div>
                                    <div class="text-xl font-bold"><span id="slipVarHours">131.24</span> Hr</div>
                                </div>
                            </div>
                            
                            <!-- Salary Breakdown -->
                            <div class="p-4">
                                <table class="w-full salary-table">
                                    <thead>
                                        <tr class="bg-slate-100">
                                            <th class="text-left p-3 text-sm font-semibold text-slate-700">EARNINGS</th>
                                            <th class="text-right p-3 text-sm font-semibold text-slate-700">AMOUNT (₹)</th>
                                            <th class="text-left p-3 text-sm font-semibold text-slate-700">DEDUCTIONS</th>
                                            <th class="text-right p-3 text-sm font-semibold text-slate-700">AMOUNT (₹)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="border-b border-slate-200">
                                            <td class="p-3">Basic Salary</td>
                                            <td class="p-3 text-right font-semibold" id="slipPayableBasic">22,635.58</td>
                                            <td class="p-3">Provident Fund (PF)</td>
                                            <td class="p-3 text-right font-semibold" id="slipPF">2,716.27</td>
                                        </tr>
                                        <tr class="border-b border-slate-200">
                                            <td class="p-3">Variable Allowance</td>
                                            <td class="p-3 text-right" id="slipVarAmt">13,780.20</td>
                                            <td class="p-3">ESI Contribution</td>
                                            <td class="p-3 text-right" id="slipESI">0.00</td>
                                        </tr>
                                        <tr class="border-b border-slate-200">
                                            <td class="p-3">Food Allowance</td>
                                            <td class="p-3 text-right" id="slipPayableFood">3,000.00</td>
                                            <td class="p-3">Bus Deduction</td>
                                            <td class="p-3 text-right font-semibold" id="slipBus">750.00</td>
                                        </tr>
                                        <tr class="border-b border-slate-200">
                                            <td class="p-3">Other Earnings</td>
                                            <td class="p-3 text-right" id="slipOtherEarnings">0.00</td>
                                            <td class="p-3"></td>
                                            <td class="p-3"></td>
                                        </tr>
                                        <tr class="bg-slate-50 font-bold">
                                            <td class="p-3">Total Earnings</td>
                                            <td class="p-3 text-right text-green-700" id="slipTotalEarnings">39,415.78</td>
                                            <td class="p-3">Total Deductions</td>
                                            <td class="p-3 text-right text-danger-700" id="slipTotalDeductions">3,466.27</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Net Pay -->
                            <div class="bg-gradient-to-r from-slate-800 to-slate-900 text-white p-6 text-center">
                                <div class="mb-2">
                                    <div class="text-sm opacity-80">Net Payable Amount</div>
                                    <div class="text-3xl font-bold mt-1" id="slipNetPay">₹ 35,949.51</div>
                                </div>
                                <div class="text-sm opacity-90 italic border-t border-white/20 pt-3 mt-3">
                                    In Words: <span id="slipAmountWords" class="font-medium">Thirty Five Thousand Nine Hundred Forty Nine Rupees Fifty One Paise Only</span>
                                </div>
                            </div>
                            
                            <!-- Footer -->
                            <div class="p-4 text-center text-xs text-slate-500 bg-slate-50">
                                <p>This is a computer generated salary slip and does not require a signature.</p>
                                <p class="mt-1">Generated on <span id="generation-date"></span></p>
                            </div>
                        </div>
                        
                        <!-- Quick Stats -->
                        <div class="grid grid-cols-3 gap-4 mt-8">
                            <div class="glass rounded-2xl p-4 text-center border border-slate-200/50 dark:border-slate-700/50">
                                <div class="text-sm text-slate-600 dark:text-slate-400 mb-1">Total Earnings</div>
                                <div class="text-xl font-bold text-slate-800 dark:text-white" id="quick-total-earnings">₹39,415.78</div>
                            </div>
                            <div class="glass rounded-2xl p-4 text-center border border-slate-200/50 dark:border-slate-700/50">
                                <div class="text-sm text-slate-600 dark:text-slate-400 mb-1">Total Deductions</div>
                                <div class="text-xl font-bold text-slate-800 dark:text-white" id="quick-total-deductions">₹3,466.27</div>
                            </div>
                            <div class="glass rounded-2xl p-4 text-center border border-slate-200/50 dark:border-slate-700/50">
                                <div class="text-sm text-slate-600 dark:text-slate-400 mb-1">Net Pay</div>
                                <div class="text-xl font-bold text-green-700 dark:text-green-400" id="quick-net-pay">₹35,949.51</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="text-center pt-8 border-t border-slate-200/50 dark:border-slate-700/50">
                <p class="text-sm text-slate-500 dark:text-slate-500">
                    © 2024 Salary Portal Pro • Professional Salary Management Tool • v2.1.0
                </p>
                <p class="text-xs text-slate-400 dark:text-slate-600 mt-1">
                    Secure • Reliable • Efficient
                </p>
            </div>
        </div>
    </div>

    <!-- FIREBASE & CORE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, serverTimestamp, query, orderBy, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURATION
        const firebaseConfig = {
          apiKey: "AIzaSyCfltr6BuElOXV0_p07uBkDngd5fLU6c-U",
          authDomain: "salary-e8a20.firebaseapp.com",
          projectId: "salary-e8a20",
          storageBucket: "salary-e8a20.firebasestorage.app",
          messagingSenderId: "743650143598",
          appId: "1:743650143598:web:d2427c3cbf9587c460657f",
          measurementId: "G-Z006ERF0Y2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const appId = 'salary-app-v2';

        // State Management
        let currentUser = null;
        let currentRole = null;
        let currentSessionId = localStorage.getItem('salary_app_session_id');
        let sessionUnsub = null;
        let pendingUnsub = null;
        let activeUnsub = null;

        // --- GLOBAL EXPORTS ---
        window.handleGoogleLogin = handleGoogleLogin;
        window.handleVerifyOTP = handleVerifyOTP;
        window.handleLogout = handleLogout;
        window.kickUser = kickUser;
        window.approveUser = approveUser;
        window.generateUserOTP = generateUserOTP;
        window.copyOTP = copyOTP;
        window.shareOTP = shareOTP;
        window.goBackToLogin = goBackToLogin;
        window.showApp = showApp;
        window.savePayslip = savePayslip;
        window.toggleHistory = toggleHistory;
        window.loadHistoryItem = loadHistoryItem;
        window.skipAutoLogin = skipAutoLogin;
        window.initAdminDashboard = initAdminDashboard;
        window.refreshDashboard = refreshDashboard;
        window.moveToNext = moveToNext;
        window.toggleDarkMode = toggleDarkMode;
        window.printPayslip = printPayslip;
        window.calculate = calculate;
        window.resetCalculator = resetCalculator;

        // --- INITIALIZATION ---
        onAuthStateChanged(auth, (user) => {
            const loading = document.getElementById('loading-screen');
            const login = document.getElementById('login-screen');
            
            // Check remember me setting
            const rememberMe = localStorage.getItem('remember_me') === 'true';
            const savedEmail = localStorage.getItem('user_email');
            
            if (user && currentSessionId) {
                currentUser = user;
                const normalizedEmail = user.email ? user.email.toLowerCase() : '';
                currentRole = (normalizedEmail === 'shivshreek@gmail.com') ? 'admin' : 'user';
                console.log('User authenticated:', normalizedEmail, 'Role:', currentRole);
                attachSessionListener(currentSessionId);
            } else if (rememberMe && savedEmail) {
                // Show auto-login animation
                loading.innerHTML = `
                    <div class="relative">
                        <div class="w-20 h-20 border-4 border-primary-100 dark:border-slate-700 border-t-primary-600 dark:border-t-primary-500 rounded-full animate-spin"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <i data-lucide="key" class="w-8 h-8 text-primary-600 dark:text-primary-400"></i>
                        </div>
                    </div>
                    <p class="mt-6 text-lg font-medium text-slate-600 dark:text-slate-400 animate-pulse">Restoring your session...</p>
                    <button onclick="skipAutoLogin()" class="mt-4 text-sm text-slate-400 hover:text-slate-600 underline">Use different account</button>
                `;
                
                const savedSessionId = localStorage.getItem('salary_app_session_id');
                if (savedSessionId) {
                    attachSessionListener(savedSessionId);
                } else {
                    setTimeout(() => {
                        loading.classList.add('hidden');
                        login.classList.remove('hidden');
                        showNotification('Session expired', 'Please sign in again');
                    }, 2000);
                }
            } else {
                setTimeout(() => {
                    loading.classList.add('hidden');
                    login.classList.remove('hidden');
                }, 1000);
                if (user) signOut(auth);
            }
        });

        // --- SESSION MANAGEMENT ---
        function attachSessionListener(sid) {
            if (sessionUnsub) sessionUnsub();
            sessionUnsub = onSnapshot(doc(db, 'sessions', sid), (snap) => {
                const data = snap.data();
                if (!data) { 
                    handleLogout(); 
                    return; 
                }

                switch(data.status) {
                    case 'active':
                        currentRole = data.role;
                        console.log('Session active with role:', currentRole);
                        document.getElementById('loading-screen').classList.add('hidden');
                        document.getElementById('login-screen').classList.add('hidden');
                        showEmployeeDetailsForm(data.displayName);
                        break;
                        
                    case 'kicked':
                        document.body.innerHTML = getKickedUI();
                        break;
                        
                    case 'inactive':
                        handleLogout();
                        break;
                        
                    case 'pending_otp':
                        showOTPForm(data);
                        break;
                }
            }, err => console.error('Session error:', err));
        }

        function showOTPForm(data) {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('otp-form').classList.remove('hidden');
            
            window.pendingOTP = data.otp;
            document.getElementById('user-name-otp').textContent = data.displayName || 'User';
            document.getElementById('user-email-otp').textContent = data.email;
            document.getElementById('user-avatar-otp').src = data.photoURL || `https://ui-avatars.com/api/?name=${data.displayName}&background=3b82f6&color=fff`;
            
            // Clear OTP inputs
            document.querySelectorAll('.otp-input').forEach(input => input.value = '');
        }

        // --- AUTHENTICATION ---
        async function handleGoogleLogin() {
            try {
                const googleBtn = document.getElementById('google-btn');
                googleBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> Connecting...';
                googleBtn.disabled = true;
                
                const rememberMe = document.getElementById('remember-me').checked;
                const persistenceType = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                await setPersistence(auth, persistenceType);
                
                const res = await signInWithPopup(auth, provider);
                currentUser = res.user;
                const normalizedEmail = currentUser.email ? currentUser.email.toLowerCase() : '';
                
                if (normalizedEmail === 'shivshreek@gmail.com') {
                    currentRole = 'admin';
                    await createSession('admin', 'active');
                    showNotification('Welcome Admin', 'Dashboard is ready for you');
                } else {
                    currentRole = 'user';
                    await createSession('user', 'pending_otp', null);
                    showNotification('Pending Approval', 'Please contact admin for OTP');
                }
                
                if (rememberMe) {
                    localStorage.setItem('remember_me', 'true');
                    localStorage.setItem('user_email', currentUser.email);
                } else {
                    localStorage.removeItem('remember_me');
                    localStorage.removeItem('user_email');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Login Failed', error.message, 'danger');
                document.getElementById('google-btn').innerHTML = '<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Continue with Google';
                document.getElementById('google-btn').disabled = false;
            }
        }

        async function createSession(role, status, otp = null) {
            const sessionData = {
                uid: currentUser.uid,
                email: currentUser.email,
                displayName: currentUser.displayName,
                photoURL: currentUser.photoURL,
                role,
                status,
                otp,
                device: navigator.userAgent,
                platform: navigator.platform,
                loginTime: serverTimestamp(),
                ipAddress: await getIPAddress(),
                expiresAt: Timestamp.fromDate(new Date(Date.now() + 10 * 60 * 1000))
            };

            const ref = await addDoc(collection(db, 'sessions'), sessionData);
            currentSessionId = ref.id;
            localStorage.setItem('salary_app_session_id', currentSessionId);
            attachSessionListener(currentSessionId);
        }

        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch {
                return 'Unknown';
            }
        }

        // --- OTP HANDLING ---
        function moveToNext(input) {
            const value = input.value;
            const index = parseInt(input.dataset.index);
            
            if (value.length === 1 && index < 5) {
                document.querySelector(`.otp-input[data-index="${index + 1}"]`).focus();
            }
            
            // Update combined OTP
            let combined = '';
            document.querySelectorAll('.otp-input').forEach(i => {
                combined += i.value;
            });
            document.getElementById('otp-combined').value = combined;
            
            // Auto-verify when 6 digits entered
            if (combined.length === 6) {
                setTimeout(() => handleVerifyOTP(), 300);
            }
        }

        async function handleVerifyOTP() {
            const combinedOTP = document.getElementById('otp-combined').value;
            const verifyBtn = document.getElementById('verify-btn');
            
            if (combinedOTP.length !== 6) {
                showError('Please enter all 6 digits of the OTP');
                return;
            }
            
            verifyBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> Verifying...';
            verifyBtn.disabled = true;
            
            if (combinedOTP === window.pendingOTP) {
                await updateDoc(doc(db, 'sessions', currentSessionId), { 
                    status: 'active', 
                    otp: null,
                    otpVerifiedAt: serverTimestamp()
                });
                showNotification('Verified Successfully', 'Welcome to Salary Portal');
            } else {
                showError('Invalid OTP. Please check and try again.');
                verifyBtn.innerHTML = '<i data-lucide="shield" class="w-5 h-5"></i> Verify & Continue';
                verifyBtn.disabled = false;
                
                // Shake animation for error
                document.getElementById('otp-container').classList.add('animate-shake');
                setTimeout(() => {
                    document.getElementById('otp-container').classList.remove('animate-shake');
                }, 500);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('otp-error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        // --- ADMIN FUNCTIONS ---
        async function generateUserOTP() {
            const userEmail = document.getElementById('user-email-input').value.trim();
            const userName = document.getElementById('user-name-input').value.trim();
            
            if (!userEmail || !userName) {
                showNotification('Please enter both email and name', 'Both fields are required', 'warning');
                return;
            }
            
            const otp = Math.floor(100000 + Math.random()*900000).toString();
            const expiryTime = new Date(Date.now() + 10 * 60 * 1000);
            
            try {
                const sessionRef = await addDoc(collection(db, 'sessions'), {
                    uid: 'admin_gen_' + Date.now(),
                    email: userEmail,
                    displayName: userName,
                    photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=3b82f6&color=fff`,
                    role: 'user',
                    status: 'pending_otp',
                    otp: otp,
                    device: 'Admin Generated',
                    platform: 'Admin Panel',
                    loginTime: serverTimestamp(),
                    generatedBy: currentUser.email,
                    generatedAt: serverTimestamp(),
                    expiresAt: Timestamp.fromDate(expiryTime)
                });
                
                // Show OTP result
                document.getElementById('otp-result').classList.remove('hidden');
                document.getElementById('generated-otp').textContent = otp;
                document.getElementById('otp-expiry').textContent = expiryTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Clear inputs
                document.getElementById('user-email-input').value = '';
                document.getElementById('user-name-input').value = '';
                
                showNotification('OTP Generated', `OTP for ${userName} is ready to share`);
                
                // Refresh dashboard
                setTimeout(refreshDashboard, 1000);
                
            } catch (error) {
                console.error('OTP generation error:', error);
                showNotification('Generation Failed', error.message, 'danger');
            }
        }

        function copyOTP() {
            const otpText = document.getElementById('generated-otp').textContent;
            navigator.clipboard.writeText(otpText).then(() => {
                showNotification('Copied!', 'OTP copied to clipboard');
            });
        }

        function shareOTP() {
            const otpText = document.getElementById('generated-otp').textContent;
            const userName = document.getElementById('user-name-input').value || 'User';
            const shareText = `OTP for ${userName}: ${otpText}\n\nValid for 10 minutes.\n\nSalary Portal Access`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Salary Portal OTP',
                    text: shareText
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    showNotification('Ready to Share', 'OTP details copied to clipboard');
                });
            }
        }

        async function initAdminDashboard() {
            console.log('Initializing admin dashboard...');
            document.getElementById('admin-dashboard').classList.remove('hidden');
            document.getElementById('admin-badge').classList.remove('hidden');
            
            // Set up real-time listeners
            setupDashboardListeners();
            refreshDashboard();
        }

        function setupDashboardListeners() {
            // Pending sessions
            const pendingQuery = query(collection(db, 'sessions'), 
                where('status', '==', 'pending_otp'),
                orderBy('loginTime', 'desc'));
            
            if (pendingUnsub) pendingUnsub();
            pendingUnsub = onSnapshot(pendingQuery, updatePendingList);
            
            // Active sessions
            const activeQuery = query(collection(db, 'sessions'),
                where('status', '==', 'active'),
                orderBy('loginTime', 'desc'));
            
            if (activeUnsub) activeUnsub();
            activeUnsub = onSnapshot(activeQuery, updateActiveList);
        }

        function updatePendingList(snapshot) {
            const pendingList = document.getElementById('pending-users-list');
            let pendingCount = 0;
            
            if (snapshot.empty) {
                pendingList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-slate-100 dark:bg-slate-800 mb-3">
                            <i data-lucide="check-circle" class="w-6 h-6 text-slate-400"></i>
                        </div>
                        <p class="text-slate-500 dark:text-slate-500">No pending approvals</p>
                    </div>
                `;
            } else {
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    pendingCount++;
                    
                    const timeAgo = data.loginTime ? getTimeAgo(data.loginTime.toDate()) : 'Just now';
                    
                    html += `
                        <div class="glass p-4 rounded-xl border border-warning-200 dark:border-warning-800">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <img src="${data.photoURL || 'https://ui-avatars.com/api/?name=' + (data.displayName || 'User')}" 
                                         class="w-10 h-10 rounded-full border-2 border-white shadow">
                                    <div>
                                        <p class="font-semibold text-slate-800 dark:text-white">${data.displayName || 'Unknown User'}</p>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">${data.email || 'No email'}</p>
                                    </div>
                                </div>
                                <span class="text-xs px-2 py-1 rounded bg-warning-100 text-warning-700 dark:bg-warning-900/30 dark:text-warning-400">
                                    Pending
                                </span>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="bg-warning-50 dark:bg-warning-900/20 p-3 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-warning-700 dark:text-warning-300">Generated OTP</span>
                                        <span class="text-xs text-slate-500">${timeAgo}</span>
                                    </div>
                                    <p class="text-2xl font-mono font-bold text-center text-warning-700 dark:text-warning-300">${data.otp || 'N/A'}</p>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button onclick="approveUser('${doc.id}')" 
                                            class="flex-1 btn-pop bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-2 rounded-lg transition-all duration-300 flex items-center justify-center gap-2">
                                        <i data-lucide="check" class="w-4 h-4"></i>
                                        Approve
                                    </button>
                                    <button onclick="kickUser('${doc.id}')" 
                                            class="flex-1 btn-pop bg-gradient-to-r from-danger-600 to-danger-700 hover:from-danger-700 hover:to-danger-800 text-white font-semibold py-2 rounded-lg transition-all duration-300 flex items-center justify-center gap-2">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                        Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                pendingList.innerHTML = html;
            }
            
            // Update counts and badges
            document.getElementById('pending-count').textContent = pendingCount;
            document.getElementById('pending-badge').textContent = pendingCount;
            document.getElementById('pending-badge').classList.toggle('hidden', pendingCount === 0);
        }

        function updateActiveList(snapshot) {
            const activeList = document.getElementById('active-users-list');
            let activeCount = 0;
            
            if (snapshot.empty) {
                activeList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-slate-100 dark:bg-slate-800 mb-3">
                            <i data-lucide="users" class="w-6 h-6 text-slate-400"></i>
                        </div>
                        <p class="text-slate-500 dark:text-slate-500">No active sessions</p>
                    </div>
                `;
            } else {
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    activeCount++;
                    
                    const timeAgo = data.loginTime ? getTimeAgo(data.loginTime.toDate()) : 'Just now';
                    const isAdmin = data.role === 'admin';
                    const isCurrentUser = doc.id === currentSessionId;
                    
                    html += `
                        <div class="glass p-4 rounded-xl border border-slate-200/50 dark:border-slate-700/50">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <img src="${data.photoURL || 'https://ui-avatars.com/api/?name=' + (data.displayName || 'User')}" 
                                         class="w-10 h-10 rounded-full border-2 border-white shadow">
                                    <div>
                                        <p class="font-semibold text-slate-800 dark:text-white flex items-center gap-2">
                                            ${data.displayName || 'Unknown User'}
                                            ${isAdmin ? '<span class="text-xs px-1.5 py-0.5 rounded bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400">Admin</span>' : ''}
                                            ${isCurrentUser ? '<span class="text-xs px-1.5 py-0.5 rounded bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">You</span>' : ''}
                                        </p>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">${data.email || 'No email'}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-slate-500 dark:text-slate-400">Active for</p>
                                    <p class="text-sm font-medium text-slate-700 dark:text-slate-300">${timeAgo}</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between text-xs text-slate-500 dark:text-slate-500">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="monitor" class="w-3 h-3"></i>
                                    <span>${data.device?.split(' ')[0] || 'Unknown'} • ${data.platform || 'Unknown'}</span>
                                </div>
                                ${!isCurrentUser ? `
                                    <button onclick="kickUser('${doc.id}')" 
                                            class="text-danger-600 hover:text-danger-700 dark:text-danger-400 dark:hover:text-danger-300 flex items-center gap-1">
                                        <i data-lucide="user-x" class="w-3 h-3"></i>
                                        Kick
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                activeList.innerHTML = html;
            }
            
            document.getElementById('active-count').textContent = activeCount;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = Math.floor(seconds / 31536000);
            if (interval >= 1) return interval + 'y ago';
            
            interval = Math.floor(seconds / 2592000);
            if (interval >= 1) return interval + 'mo ago';
            
            interval = Math.floor(seconds / 86400);
            if (interval >= 1) return interval + 'd ago';
            
            interval = Math.floor(seconds / 3600);
            if (interval >= 1) return interval + 'h ago';
            
            interval = Math.floor(seconds / 60);
            if (interval >= 1) return interval + 'm ago';
            
            return 'just now';
        }

        async function approveUser(sessionId) {
            if (confirm('Approve this user for access?')) {
                await updateDoc(doc(db, 'sessions', sessionId), { 
                    status: 'active', 
                    otp: null,
                    approvedBy: currentUser.email,
                    approvedAt: serverTimestamp()
                });
                showNotification('User Approved', 'User can now access the portal');
            }
        }

        async function kickUser(sessionId) { 
            if (confirm('Remove this user from active sessions?')) {
                await updateDoc(doc(db, 'sessions', sessionId), {status: 'kicked'}); 
                showNotification('User Kicked', 'User session has been terminated');
            }
        }

        // --- DASHBOARD UTILITIES ---
        function refreshDashboard() {
            // Refresh both lists
            if (pendingUnsub) pendingUnsub();
            if (activeUnsub) activeUnsub();
            setupDashboardListeners();
            
            showNotification('Refreshed', 'Dashboard data updated');
        }

        // --- HISTORY & SAVING ---
        async function savePayslip() {
            if (!currentUser) return;
            
            const btn = document.getElementById('save-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Saving...';
            btn.disabled = true;
            
            const data = {
                month: document.getElementById('salary-month').value,
                year: document.getElementById('salary-year').value,
                netPay: document.getElementById('slipNetPay').innerText,
                companyName: document.getElementById('company-name').value,
                employeeName: document.getElementById('emp-name').value,
                inputs: {
                    basic: document.getElementById('basic').value,
                    working: document.getElementById('workingDays').value,
                    present: document.getElementById('presentDays').value,
                    varHours: document.getElementById('varHours').value,
                    varRate: document.getElementById('varRate').value,
                    food: document.getElementById('foodAllow').value,
                    bus: document.getElementById('busDed').value,
                    otherEarn: document.getElementById('otherEarn').value
                },
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'history'), data);
                
                showNotification('Saved Successfully', 'Payslip added to your history');
                btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> Saved!';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    lucide.createIcons();
                }, 2000);
                
            } catch (error) {
                console.error('Save error:', error);
                showNotification('Save Failed', error.message, 'danger');
                btn.innerHTML = '<i data-lucide="alert-circle" class="w-4 h-4"></i> Error';
                btn.disabled = false;
            }
        }

        async function toggleHistory() {
            const modal = document.getElementById('history-modal');
            const isHidden = modal.classList.contains('hidden');
            
            if (isHidden) {
                modal.classList.remove('hidden');
                await loadHistoryData();
            } else {
                modal.classList.add('hidden');
            }
        }

        async function loadHistoryData() {
            const list = document.getElementById('history-list');
            list.innerHTML = '<div class="space-y-3"><div class="shimmer h-16 rounded-xl"></div><div class="shimmer h-16 rounded-xl"></div></div>';
            
            try {
                const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'history'), 
                              orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(q);
                
                let html = '';
                const chartData = {
                    labels: [],
                    netPay: [],
                    total: 0,
                    max: 0,
                    avg: 0
                };
                
                if (snapshot.empty) {
                    html = `
                        <div class="text-center py-12">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 dark:bg-slate-800 mb-4">
                                <i data-lucide="file-text" class="w-8 h-8 text-slate-400"></i>
                            </div>
                            <h4 class="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-2">No Records Yet</h4>
                            <p class="text-slate-500 dark:text-slate-500 max-w-sm mx-auto">
                                Your saved salary slips will appear here. Create your first payslip to get started.
                            </p>
                        </div>
                    `;
                } else {
                    snapshot.forEach((doc, index) => {
                        const d = doc.data();
                        const rawNet = parseFloat(d.netPay.replace(/[^0-9.-]+/g, ""));
                        const monthYear = `${d.month} ${d.year}`;
                        
                        chartData.labels.unshift(monthYear);
                        chartData.netPay.unshift(rawNet);
                        chartData.total += rawNet;
                        chartData.max = Math.max(chartData.max, rawNet);
                        
                        html += `
                            <div class="glass p-4 rounded-xl border border-slate-200/50 dark:border-slate-700/50 hover:border-primary-300 dark:hover:border-primary-700 transition-colors cursor-pointer" onclick="loadHistoryItem('${doc.id}')">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-3">
                                        <div class="bg-primary-100 dark:bg-primary-900/30 p-2 rounded-lg">
                                            <i data-lucide="file-text" class="w-5 h-5 text-primary-600 dark:text-primary-400"></i>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-slate-800 dark:text-white">${d.month}, ${d.year}</p>
                                            <p class="text-xs text-slate-500 dark:text-slate-400">${d.companyName || 'Unknown Company'}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-bold text-slate-800 dark:text-white">${d.netPay}</p>
                                        <p class="text-xs text-slate-500 dark:text-slate-400">Net Pay</p>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between text-xs text-slate-500 dark:text-slate-500">
                                    <span>${d.employeeName || 'Unknown Employee'}</span>
                                    <button class="text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300 flex items-center gap-1">
                                        <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                        Load
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    chartData.avg = chartData.total / chartData.netPay.length;
                    
                    // Update stats
                    document.getElementById('record-count').textContent = `${chartData.netPay.length} records`;
                    document.getElementById('avg-net-pay').textContent = `₹${chartData.avg.toLocaleString('en-IN', {maximumFractionDigits: 0})}`;
                    document.getElementById('max-net-pay').textContent = `₹${chartData.max.toLocaleString('en-IN', {maximumFractionDigits: 0})}`;
                    
                    // Update chart
                    updateHistoryChart(chartData.labels, chartData.netPay);
                }
                
                list.innerHTML = html;
                document.getElementById('history-badge').textContent = chartData.netPay.length;
                document.getElementById('history-badge').classList.toggle('hidden', chartData.netPay.length === 0);
                
            } catch (error) {
                console.error('History load error:', error);
                list.innerHTML = `
                    <div class="text-center py-8 text-danger-600">
                        <i data-lucide="alert-circle" class="w-8 h-8 mx-auto mb-2"></i>
                        <p>Failed to load history</p>
                    </div>
                `;
            }
        }

        async function loadHistoryItem(docId) {
            try {
                // In a real app, you would fetch the document here
                // For now, we'll just close the modal
                toggleHistory();
                showNotification('Record Loaded', 'Previous payslip data loaded');
                
            } catch (error) {
                showNotification('Load Failed', 'Could not load the record', 'danger');
            }
        }

        // --- CHART MANAGEMENT ---
        let historyChart = null;
        function updateHistoryChart(labels, data) {
            const ctx = document.getElementById('historyChart').getContext('2d');
            
            if (historyChart) historyChart.destroy();
            
            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Net Pay',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Net Pay: ₹${context.parsed.y.toLocaleString('en-IN')}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            ticks: {
                                callback: (value) => `₹${value.toLocaleString('en-IN')}`
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // --- UTILITIES ---
        function skipAutoLogin() {
            localStorage.removeItem('remember_me');
            localStorage.removeItem('user_email');
            localStorage.removeItem('salary_app_session_id');
            location.reload();
        }

        async function handleLogout() {
            if (confirm('Are you sure you want to sign out?')) {
                if (currentSessionId) {
                    await updateDoc(doc(db, 'sessions', currentSessionId), { status: 'inactive' });
                }
                
                localStorage.removeItem('remember_me');
                localStorage.removeItem('user_email');
                localStorage.removeItem('salary_app_session_id');
                
                await signOut(auth);
                location.reload();
            }
        }

        function showNotification(title, message, type = 'success') {
            const toast = document.getElementById('notification-toast');
            const titleEl = document.getElementById('notification-title');
            const messageEl = document.getElementById('notification-message');
            const icon = toast.querySelector('i');
            
            // Set colors based on type
            let borderColor = 'border-success-500';
            let iconName = 'check-circle';
            
            if (type === 'danger') {
                borderColor = 'border-danger-500';
                iconName = 'alert-circle';
            } else if (type === 'warning') {
                borderColor = 'border-warning-500';
                iconName = 'alert-triangle';
            } else if (type === 'info') {
                borderColor = 'border-primary-500';
                iconName = 'info';
            }
            
            // Update content
            titleEl.textContent = title;
            messageEl.textContent = message;
            icon.setAttribute('data-lucide', iconName);
            icon.className = `w-6 h-6 text-${type}-500`;
            toast.className = `fixed top-4 right-4 z-50 max-w-sm transition-all duration-500 ${borderColor}`;
            
            // Show toast
            toast.classList.remove('translate-x-full');
            lucide.createIcons();
            
            // Auto-hide after 5 seconds
            setTimeout(hideNotification, 5000);
        }

        function hideNotification() {
            const toast = document.getElementById('notification-toast');
            toast.classList.add('translate-x-full');
        }

        function getKickedUI() {
            return `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-pink-50 dark:from-red-900/20 dark:to-pink-900/20 p-4">
                    <div class="glass max-w-md w-full rounded-3xl shadow-2xl border border-red-200 dark:border-red-800 overflow-hidden">
                        <div class="bg-gradient-to-r from-danger-600 to-danger-700 p-8 text-center">
                            <div class="w-20 h-20 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm border border-white/20">
                                <i data-lucide="shield-off" class="w-10 h-10 text-white"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-white">Session Terminated</h2>
                            <p class="text-red-200 mt-1">Admin has logged you out</p>
                        </div>
                        <div class="p-8 text-center">
                            <p class="text-slate-600 dark:text-slate-400 mb-6">
                                Your session has been ended by the administrator. Please contact support if you believe this is an error.
                            </p>
                            <button onclick="location.reload()" 
                                    class="btn-pop bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-semibold px-6 py-3 rounded-xl transition-all duration-300 shadow-lg inline-flex items-center gap-2">
                                <i data-lucide="log-in" class="w-5 h-5"></i>
                                Sign In Again
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>

    <!-- UI LOGIC -->
    <script>
        // Initialize icons
        lucide.createIcons();
        
        // Set generation date
        document.getElementById('generation-date').textContent = new Date().toLocaleDateString('en-IN', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // OTP input handling
        window.moveToNext = function(input) {
            const value = input.value;
            const index = parseInt(input.dataset.index);
            
            if (value.length === 1 && index < 5) {
                document.querySelector(`.otp-input[data-index="${index + 1}"]`).focus();
            }
            
            // Update combined OTP
            let combined = '';
            document.querySelectorAll('.otp-input').forEach(i => {
                combined += i.value;
            });
            document.getElementById('otp-combined').value = combined;
            
            // Auto-verify when complete
            if (combined.length === 6) {
                document.getElementById('verify-btn').focus();
            }
        };

        // Department toggle
        window.toggleCustomDept = function() {
            const deptSelect = document.getElementById('department');
            const customInput = document.getElementById('custom-dept');
            customInput.classList.toggle('hidden', deptSelect.value !== 'Other');
        };

        // Dark mode toggle
        window.toggleDarkMode = function() {
            const isDark = document.body.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
            document.getElementById('dark-mode-toggle').checked = isDark;
        };

        // Initialize dark mode from localStorage
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark');
            document.getElementById('dark-mode-toggle').checked = true;
        }

        // Enhanced Number to words conversion with paise support
        function numberToWords(num) {
            if (num === 0) return "Zero Rupees Only";
            
            const units = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine"];
            const teens = ["Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
            const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];
            
            function convertTwoDigits(n) {
                if (n === 0) return "";
                if (n < 10) return units[n];
                if (n < 20) return teens[n - 10];
                return tens[Math.floor(n / 10)] + (n % 10 !== 0 ? " " + units[n % 10] : "");
            }

            function convertThreeDigits(n) {
                let str = "";
                if (n > 99) {
                    str += units[Math.floor(n / 100)] + " Hundred ";
                    n %= 100;
                }
                str += convertTwoDigits(n);
                return str.trim();
            }

            let integerPart = Math.floor(num);
            let decimalPart = Math.round((num - integerPart) * 100);
            let words = "";
            
            // Convert integer part
            if (integerPart >= 10000000) {
                words += convertThreeDigits(Math.floor(integerPart / 10000000)) + " Crore ";
                integerPart %= 10000000;
            }
            if (integerPart >= 100000) {
                words += convertThreeDigits(Math.floor(integerPart / 100000)) + " Lakh ";
                integerPart %= 100000;
            }
            if (integerPart >= 1000) {
                words += convertThreeDigits(Math.floor(integerPart / 1000)) + " Thousand ";
                integerPart %= 1000;
            }
            words += convertThreeDigits(integerPart);
            
            // Add currency
            if (words.trim() === "") {
                words = "Zero";
            }
            
            words = words.trim() + " Rupees";
            
            // Add paise if any
            if (decimalPart > 0) {
                words += " " + convertTwoDigits(decimalPart) + " Paise";
            }
            
            return words + " Only";
        }

        // UI Helpers
        window.showEmployeeDetailsForm = function(name) {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('employee-details-form').classList.remove('hidden');
            
            if (name) {
                document.getElementById('emp-name').value = name;
                document.getElementById('welcome-msg').innerText = `Welcome back, ${name}`;
            }
        };

        window.goBackToLogin = function() {
            document.getElementById('employee-details-form').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        };

        window.showApp = function() {
            document.getElementById('employee-details-form').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            
            // Update user info in nav
            if (currentUser) {
                document.getElementById('user-name-nav').textContent = currentUser.displayName || 'User';
                document.getElementById('user-email-nav').textContent = currentUser.email;
                document.getElementById('user-avatar-nav').src = currentUser.photoURL || `https://ui-avatars.com/api/?name=${currentUser.displayName}&background=3b82f6&color=fff`;
                document.getElementById('user-role-nav').textContent = currentRole === 'admin' ? 'Administrator' : 'Employee';
                document.getElementById('current-user-info').textContent = `Signed in as ${currentUser.email}`;
            }
            
            // Update payslip month display
            const month = document.getElementById('salary-month').value;
            const year = document.getElementById('salary-year').value;
            document.getElementById('slip-month-display').textContent = `${month} ${year}`;
            
            // Initialize icons
            lucide.createIcons();
            
            // Calculate initial values
            calculate();
        };

        // Form submission
        document.getElementById('employee-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            // Update payslip with form data
            const companyName = document.getElementById('company-name').value;
            const companyAddress = document.getElementById('company-address').value;
            
            let department = document.getElementById('department').value;
            if (department === 'Other') {
                department = document.getElementById('custom-dept').value || 'Other';
            }

            const empCode = document.getElementById('emp-code').value;
            const empName = document.getElementById('emp-name').value;
            const fatherName = document.getElementById('father-name').value;
            const doj = document.getElementById('doj').value;
            const designation = document.getElementById('designation').value;
            const month = document.getElementById('salary-month').value;
            const year = document.getElementById('salary-year').value;
            
            // Update payslip
            document.getElementById('slipCompanyName').textContent = companyName.toUpperCase() || "COMPANY NAME";
            document.getElementById('slipCompanyAddress').textContent = companyAddress || '';
            document.getElementById('slipEmpCode').textContent = empCode;
            document.getElementById('slipEmpName').textContent = empName;
            document.getElementById('slipFatherName').textContent = fatherName;
            document.getElementById('slipDepartment').textContent = department;
            document.getElementById('slipDesignation').textContent = designation || '--';
            document.getElementById('slipDOJ').textContent = doj;
            document.getElementById('slipMonthYear').textContent = `${month}, ${year}`;
            document.getElementById('slip-month-display').textContent = `${month} ${year}`;
            
            if (window.showApp) {
                window.showApp();
            }
        });

        // Calculator functions
        function formatNum(n) {
            return n.toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        window.calculate = function() {
            const basic = parseFloat(document.getElementById('basic').value) || 0;
            const working = parseFloat(document.getElementById('workingDays').value) || 26;
            const present = parseFloat(document.getElementById('presentDays').value) || 25;
            const varHours = parseFloat(document.getElementById('varHours').value) || 0;
            const varRate = parseFloat(document.getElementById('varRate').value) || 0;
            const food = parseFloat(document.getElementById('foodAllow').value) || 0;
            const bus = parseFloat(document.getElementById('busDed').value) || 0;
            const otherEarn = parseFloat(document.getElementById('otherEarn').value) || 0;

            // Calculations based on the provided payslip
            let earnedBasic = (basic / working) * present;
            let varAmt = varHours * varRate;
            let totalEarn = earnedBasic + varAmt + food + otherEarn;
            
            // PF calculation (12% of earned basic)
            let pf = earnedBasic * 0.12;
            
            // ESI calculation (0.75% of total earnings if structure <= 21000)
            let esi = 0;
            let structureGross = basic + food;
            if (structureGross <= 21000) {
                esi = totalEarn * 0.0075;
            }
            
            let totalDed = pf + bus + esi;
            let net = totalEarn - totalDed;

            // Update payslip display
            document.getElementById('slipPayableBasic').textContent = formatNum(earnedBasic);
            document.getElementById('slipVarAmt').textContent = formatNum(varAmt);
            document.getElementById('slipPayableFood').textContent = formatNum(food);
            document.getElementById('slipOtherEarnings').textContent = formatNum(otherEarn);
            document.getElementById('slipPF').textContent = formatNum(pf);
            document.getElementById('slipESI').textContent = formatNum(esi);
            document.getElementById('slipBus').textContent = formatNum(bus);
            document.getElementById('slipTotalEarnings').textContent = formatNum(totalEarn);
            document.getElementById('slipTotalDeductions').textContent = formatNum(totalDed);
            document.getElementById('slipNetPay').textContent = "₹ " + formatNum(net);
            document.getElementById('slipAmountWords').textContent = numberToWords(net);
            
            document.getElementById('slipWorkingDays').textContent = working;
            document.getElementById('slipPresentDays').textContent = present;
            document.getElementById('slipVarHours').textContent = varHours.toFixed(2);

            // Update quick stats
            document.getElementById('quick-total-earnings').textContent = `₹${formatNum(totalEarn)}`;
            document.getElementById('quick-total-deductions').textContent = `₹${formatNum(totalDed)}`;
            document.getElementById('quick-net-pay').textContent = `₹${formatNum(net)}`;
        };

        window.resetCalculator = function() {
            // Reset to original values from the payslip image
            document.getElementById('basic').value = 23541;
            document.getElementById('workingDays').value = 26;
            document.getElementById('presentDays').value = 25;
            document.getElementById('varHours').value = 131.24;
            document.getElementById('varRate').value = 105.00;
            document.getElementById('foodAllow').value = 3000;
            document.getElementById('busDed').value = 750;
            document.getElementById('otherEarn').value = 0;
            calculate();
            showNotification('Calculator Reset', 'All values restored to original payslip data');
        };

        // PDF Generation
        window.downloadPDF = function() {
            const element = document.getElementById('payslip-container');
            const opt = {
                margin: 0.5,
                filename: `Salary_Slip_${document.getElementById('slipMonthYear').textContent.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                },
                jsPDF: { 
                    unit: 'in', 
                    format: 'letter', 
                    orientation: 'portrait' 
                },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };
            
            html2pdf().set(opt).from(element).save();
            showNotification('PDF Downloaded', 'Payslip saved to your device');
        };

        window.printPayslip = function() {
            const element = document.getElementById('payslip-container');
            const originalContent = document.body.innerHTML;
            const printContent = element.outerHTML;
            
            document.body.innerHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Print Payslip</title>
                    <style>
                        body { margin: 0; padding: 20px; background: white !important; }
                        @page { size: auto; margin: 0mm; }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 100);
                        }
                    <\/script>
                </body>
                </html>
            `;
            
            window.print();
            setTimeout(() => {
                document.body.innerHTML = originalContent;
                lucide.createIcons();
                calculate();
            }, 500);
        };

        // Initialize calculator with original values
        calculate();

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl + S to save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (document.getElementById('save-btn')) {
                    savePayslip();
                }
            }
            // Ctrl + P to print
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                printPayslip();
            }
            // Ctrl + D for dark mode
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                toggleDarkMode();
            }
            // Ctrl + R to reset
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                resetCalculator();
            }
        });

        // Auto-calculate on input changes
        document.querySelectorAll('#basic, #workingDays, #presentDays, #varHours, #varRate, #foodAllow, #busDed, #otherEarn').forEach(input => {
            input.addEventListener('input', () => {
                calculate();
            });
        });
    </script>
</body>
</html>
